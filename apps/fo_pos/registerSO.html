<style>[pgmid='registerSO'].framepage input.scanbox {
    width: 100%;
    background-color: beige;
    border: 2px solid orange;
    font-size: 1.5em;
    text-align: center;
    padding: 0.5em;
}
[pgmid='registerSO'].framepage .bigButton {
    font-size: 1.5em;
    width: 100%;
    margin-left: auto;
    max-height: 5em;
}
[pgmid='registerSO'].framepage #totalpaylist{
    min-width : 100%;
    font-weight : bold; 
    font-size:1.5em;
    text-align : right; 
}
[pgmid='registerSO'].framepage #totalpaylist input{
    width : 50%;
    height : 30%;
    font-size : 2em;
    font-weight : bold;
}
[pgmid='registerSO'].framepage #totalpaylist button{
    width : 90%;
    height : 30%;
    font-size : 2em;
    font-weight : bold;
}

[pgmid='registerSO'].framepage #buttonlist button{
    width : 90%;
    height : 30%;
    font-size : 2em;
    font-weight : bold;
}


[pgmid='registerSO'].framepage .flex73 > *:first-child{
    flex:1 1 70%;
}
[pgmid='registerSO'].framepage .flex73 > *:nth-child(2){
    flex:1 1 30%;
}

[pgmid='registerSO'].framepage input.scanbox {
    width: 100%;
    background-color: beige;
    border: 2px solid orange;
    font-size: 1.5em;
    text-align: center;
    padding: 0.5em;
} 
[pgmid='registerSO'].framepage #totalpaylist{
    min-width : 100%;
}
[pgmid='registerSO'].framepage #totalpaylist input{
    width : 80%;
    font-size : 1.2em;
    font-weight : bold;
}

[pgmid='registerSO'].framepage .flex73 > *:first-child{
    flex:1 1 70%;
}
[pgmid='registerSO'].framepage .flex73 > *:nth-child(2){
    flex:1 1 30%;
} </style>
<div class="pageNav"></div>
<div class="pageTop"></div>  
<div class="pageContent flexRow">
    <div class="flexColumn" style="flex:1 1 74%;">
        <ul id="tabs">
            <li refid="mstlist">판매전표</li> 
            <li refid="payslist">지불내역</li>
        </ul>
        <div class="flexColumn" id="mstlist">
            <div id="mst"></div>
            <div style="display:flex;width:100%; flex:unset">
                <button class ="goodssearch" style="width:100px;">상품검색</button><input type="text" name="scanbox" autocomplete="off" class="scanbox" style="ime-mode:inactive;text-transform: uppercase;" placeholder="추가할 상품을 스캔하세요" >
            </div>
            <div id="itemlist"></div>
        </div>
        <div class="flexColumn" id="payslist">
            <div id="paylist" style="height:200px;"></div>
            <div id="apvRst"></div>                    
        </div>
    </div>
    <div class="flexColumn" style="flex:1 1 24%">
        <table id="buttonlist" style="width:100%;height:60%;">
            <tr>
                <td rowspan="3">
                    <button class = "card" style="width:100%;height:30%; ">카드</button><br><br>
                    <button class = "cash" style="width:100%;height:30%; ">현금</button><br><br>
                    <button class = "btnTemp" style="width:100%;height:15%;">대기</button><br>
                </td>
            </tr>
        </table>
        <div id="msg" class="flexColumn" style="flex:1 1 24%">
            <div style="width:100%; margin-top:15em;">
                <div id="msgPanel"></div>
                <div id="msgBtnPanel"></div>
            </div>
            <div style="width:100%;height:50%;">
                <button class="gButton bigButton" id="btnSave"> 전표확정 </button><br>
                <br>
                <button class="gButton bigButton" id="btnTemp"> 대 기 </button><br> 
                <button class="gButton bigButton" id="btnReturn"> 반 품 </button><br> 
                <button class="gButton bigButton" id="btnNew"> 신 규 </button><br> 
                <button class="gButton bigButton" id="btnReApv"> 재승인 </button><br> 
                <button class="gButton bigButton" id="btnChange"> 교환 </button><br>
            </div>
        </div>
        <button class="gButton bigButton" id="btnChange2"> 등가교환 </button><br>
        <table id="totalpaylist" style="width:100%;height:40%;">
            <tr>
                <td rowspan="3">
                    총&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;액 <input type="text" name = "totalpay" readonly style="text-align:right;height:10%"><br>
                    총 결제금액 <input type="text" name = "payment" readonly style="text-align:right;height:10%"><br>
                    잔&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;액 <input type="text" name = "balance" readonly style="text-align:right;background-color:beige;height:10%">
                </td>
            </tr>
        </table>
    </div>
</div>
<div id="searchPop" class="flexColumn" style="height:500px">
    <div id="searchCond"></div>
    <div id="searchList" class="flexColumn"></div> 
</div>

<div id="searchPop2" class="flexColumn" style="height:500px">
    <div id="searchCond2"></div>
    <div id="searchList2" class="flexColumn"></div> 
</div>

<div id="searchOldPop" class="flexColumn" style="height:600px">
    <div id="searchOldCond"></div>
    <div  class="flexColumn flex73">
        <div id="searchOldList" style="flex:1 1 60%"></div>
        <div id="searchOldListGoods" class="flexColumn"></div> 
    </div>
</div>
<div id="searchPromo" class="flexColumn" style="height:500px">
    <div id="promoList" class="flexColumn"></div> 
</div>

<div id="barcode"></div>
<input type="hidden" id="txtUrl" value="http://127.0.0.1:27098">
<input type="hidden" id="taRequest">
<p id=receive style = display : none;></p>
<p id=send style = display : none;></p>
<input type="hidden" id="txtSlsAmt" style="width:100%;"  value="" />
<input type="hidden" id="txtMlplMnts" style="width:100%;"  value="" />
<input type="hidden" id="taResponse" style="height:70px;width:100%;">
<div id="posinfo"></div>

<script>
    function lpad(str, padLen, padStr) {
        if (padStr.length > padLen) {
            return str;
        }
        str += ""; // 문자로
        padStr += ""; // 문자로
        while (str.length < padLen)
            str = padStr + str;
        str = str.length >= padLen ? str.substring(0, padLen) : str;
        return str;
        }
    
        function rpad(str, padLen, padStr) {
        if (padStr.length > padLen) {
            return str + "";
        }
        str += ""; // 문자로
        padStr += ""; // 문자로
        while (str.length < padLen)
            str += padStr;
        str = str.length >= padLen ? str.substring(0, padLen) : str;
        return str;
    }
    
    function setYYMMDDHHMMSS()
    	{
    		var nowDate = new Date(); 
    		var vaYY = nowDate.getFullYear().toString().substr(2, 4);
    		var vaMM = pad(nowDate.getMonth()+1, 2);
    		var vaDD = pad(nowDate.getDate()   , 2);
    		var vaHH = pad(nowDate.getHours()  , 2);
    		var vaMin= pad(nowDate.getMinutes(), 2);
    		var vaSS = pad(nowDate.getSeconds(), 2);
    		
    		return vaYY+vaMM+vaDD+vaHH+vaMin+vaSS;
    	}
    function pad(number, length)
	{
		var str = number.toString();
		while(str.length < length)
		{
			str = '0' + str;
		}
		return str;
	}
    function setContent(param)
	{
		if(param.slsAmt) 
		{
			document.getElementById("txtSlsAmt").value = param.slsAmt;    //매출금액		
		}
		
		if(param.mlplMnts) 
		{
			document.getElementById("txtMlplMnts").value = param.mlplMnts;	//할부개월			
		}
		
		if(param.slsDt) 
		{
			document.getElementById("txtCatApprDate").value = param.slsDt;	//승인일자			
		}
		
		if(param.aprvNo) 
		{
			document.getElementById("txtCatApprNo").value = param.aprvNo;	//승인번호			
		}
		
		if(param.csrcCnsmKd) 
		{
			document.getElementById("txtCsrcCnsmKd").value = param.csrcCnsmKd;		//현금영수증 소비자구분		
		}		    
	}
	String.prototype.fillZero = function(n)
	{
		var str   = this;
		var zeros = "";

		if(str.length < n)
		{
			for(i = 0; i < n - str.length; i++)
			{
				zeros += '0';
			}
		}
		return zeros + str;
	}

	String.prototype.fillSpace = function(n)
	{
		var str   = this;
		var space = "";

		if(str.length < n)
		{
			for(i = 0; i < n - str.length; i++)
			{
				space += ' ';
			}
		}
		return str + space;
	}

	String.prototype.byteLength = function()
	{
		var len = 0;
	
		for(var i=0; i<this.length; i++)
		{
			len += (this.charCodeAt(i) > 127) ? 2 : 1;
		}
		return len;
	}

	String.prototype.substrKor = function(idx, len)
	{
		if(!this.valueOf()) return "";
	
		var str = this;
		var pos = 0;

		for(var i=0; pos<idx; i++)
		{
			pos += (str.charCodeAt(i) > 127) ? 2 : 1;
		}

		var beg = i;
		var byteLen = str.byteLength();
		var lim = 0;			

		for(var i=beg; i<byteLen; i++)
		{
			lim += (str.charCodeAt(i) > 127) ? 2 : 1;

			if(lim > len)
			{ 
				str = str.substring(beg, i);
				break;
			}
		}
	
		return str;   
	}
	function JSONtoString(object) 
	{
		var results = [];
		
		for (var property in object) 
		{
			var value = object[property];
			if (value)
				results.push(property.toString() + ': ' + value);
		}
	                 
	    return '{' + results.join(', ') + '}';
	}

	function FindJSONtoString(Key, object) 
    {
		var results = "";
		for (var property in object) 
		{
			var value = object[property];
			if (value)
			{
				if(Key == property.toString())
				{
					results = value;
					break;
				}
			}
		}
	    return results;
	}
	stringformat = function (text) 
	{
		if (arguments.length <= 1) return text;

		for (var i = 0; i <= arguments.length - 2; i++) {
			text = text.replace(new RegExp("\\{" + i + "\\}", "gi"), arguments[i + 1]);
		}

		return text;
	}    
</script>
<script>
/*-- SCRIPT autogen start ---------------------------------------------- */        
$(function() {
    var appid = "fo_pos";
    var pgmid = "registerSO"; 
    var page = $("*[pgmid='"+pgmid+"'].framepage").last();
    var pageid = page.attr("id"); 
    var me = {}
    var dataSet = {};
    var dataDef = {};
    var pageObj = {};
    var bEdit = false;
    me.fnInit = function() {
        gfn[pageid] = me; 
        me.appid    = appid;
        me.pgmid    = pgmid;
        me.pageid   = pageid;
        me.page     = page; 
        me.dataSet = dataSet;
        me.dataDef = dataDef;
        me.pageObj = pageObj;
        me.bEdit = bEdit;
me.dataDef["_pgm"]={"ver":15.7,"upd_dt":"2022-10-12 18:06:43","remark":"고객을 식별하고 상품추가, 프로모션 적용하여 판매를 등록함. 고객포인트 사용/적립. 카드단말기연동","pgmid":"registerSO","proc_mst_id":"","pgm_stat":"Y","sort_seq":100,"app_pgmid":"fo_pos","shortcut":"","reg_dt":"2022-10-12 18:06:43","reg_usid":"jjr","pgm_nm":"★판매등록","upd_usid":"jjr","pgm_tp":"UX","pgm_grp_nm":"판매","proc_mst_nm":"","app_pgm_nm":"매장","":"트랜젝션(메뉴)","crud":""};
me.dataDef["_pgm_func"]=[{"func_icon":"fas fa-file","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"신규","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"EH","remark":null,"pgmid":"registerSO","sort_seq":"1","funcid":"new","content":"신규 판매등록(화면초기화)","crud":"R","id":"0"},{"func_icon":"fas fa-save","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"대기","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"DB_W","remark":null,"pgmid":"registerSO","sort_seq":"2","funcid":"save","content":"판매전표 임시저장. 결제가 완료되면 자동으로 저장됩니다.","crud":"R","id":"1"},{"func_icon":"fas fa-search","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"영수증조회","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"DB_R","remark":"확정(승인)된 판매전표는 판매취소등록 후 재등록할 수 있습니다.","pgmid":"registerSO","sort_seq":"3","funcid":"search","content":"판매전표 조회 - 팝업이 표시되어 전표번호를 스캔 또는 입력받습니다.","crud":"R","id":"2"},{"func_icon":"fas fa-search","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"구POS","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"DB_R","remark":null,"pgmid":"registerSO","sort_seq":"4","funcid":"search_old","content":"아스템즈 판매전표를 조회합니다.","crud":"R","id":"3"},{"func_icon":"fas fa-file","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"재발행","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"EH","remark":null,"pgmid":"registerSO","sort_seq":"5","funcid":"print","content":"판매영수증을 출력합니다.","crud":"R","id":"4"},{"func_icon":"extra fas fa-trach","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"대기전표삭제","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"DB_W","remark":null,"pgmid":"registerSO","sort_seq":"6","funcid":"delete","content":"임시저장 전표를 삭제합니다.","crud":"R","id":"5"},{"func_icon":"extra","reg_dt":"2022-10-12 18:06:43","reg_usid":"","func_nm":"POS선택/변경","upd_usid":"","upd_dt":"2022-10-12 18:06:43","func_tp":"EH","remark":null,"pgmid":"registerSO","sort_seq":"7","funcid":"changePos","content":"판매등록 POS를 설정하거나 변경합니다.","crud":"R","id":"6"}];
me.dataDef["_pgm_data"] = {};
me.dataDef["_pgm_data"]["mst"]={"sort_seq":"1","data_id":"mst","data_nm":"판매전표","data_icon":null,"component_pgmid":"aweForm","component_option":null,"inout_tp":"INOUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":"판매번호","colid":"so_no","colnm":"판매번호","dtype":"text","etype":"txt","attr":"keycol  center readonly","defval":null,"w":"20","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":"판매번호","colid":"so_nm","colnm":"판매명","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"25","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":"일자-POS번호-순번","crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_dt","colnm":"판매일자","dtype":"ymd","etype":"raw","attr":"disabled","defval":"date(\"today\")","w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"pos_no","colnm":"POS번호","dtype":"text","etype":"raw","attr":"disabled","defval":null,"w":"3","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_seq","colnm":"순번","dtype":"text","etype":"raw","attr":"disabled","defval":null,"w":"3","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":"[신규] 즉시 새로운 번호가 채번됩니다.","crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"remark","colnm":"비고","dtype":"text","etype":"txt","attr":null,"defval":null,"w":"20","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":7,"section":null,"section_icon":null,"colgrp":null,"colid":"so_usid","colnm":"사용자ID","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":"신규일때 로그인사용자이름표시, 재조회시 저장된 사용자명 표시","crud":"C","id":"6"},{"sort_seq":8,"section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태코드","dtype":"text","etype":"sel","attr":"disabled","defval":null,"w":"2","h":null,"refcd":"SO_STAT","option":"sel:cd_stat::nm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":"N임시, Y승인완료","crud":"C","id":"7"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"so_end_yn","colnm":"판매마감","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"2","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":"표시","crud":"C","id":"8"},{"sort_seq":10,"section":null,"section_icon":null,"colgrp":null,"colid":"so_content","colnm":"판매내용","dtype":"text","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"9"},{"sort_seq":11,"section":null,"section_icon":null,"colgrp":null,"colid":"pre_order_yn","colnm":"예약판매 여부","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"10"},{"sort_seq":12,"section":null,"section_icon":null,"colgrp":null,"colid":"lg_tp","colnm":"접수구분","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"11"},{"sort_seq":13,"section":null,"section_icon":null,"colgrp":null,"colid":"whcd","colnm":"RT매장","dtype":"text","etype":"raw","attr":"hidden ","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"12"},{"sort_seq":14,"section":null,"section_icon":null,"colgrp":null,"colid":"nm","colnm":"고객명","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"13"},{"sort_seq":15,"section":null,"section_icon":null,"colgrp":null,"colid":"phone","colnm":"전화번호","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"14"},{"sort_seq":16,"section":null,"section_icon":null,"colgrp":null,"colid":"adress","colnm":"주소","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"15"}]};
me.dataDef["_pgm_data"]["itemlist"]={"sort_seq":"2","data_id":"itemlist","data_nm":"판매상품내역","data_icon":null,"component_pgmid":"agGrid","component_option":{"gridOpt":"rn chk","func":[{"funcid":"promotion","func_nm":"프로모션","func_icon":"fas fa-check"},{"funcid":"delList","func_nm":"선택목록삭제","func_icon":"fas fa-minus"}]},"inout_tp":"INOUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_cd","colnm":"상제품코드","dtype":"text","etype":"txt","attr":"pk readonly","defval":null,"w":"13","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"init_price","colnm":"최초가","dtype":"num","etype":"raw","attr":"hidden","defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_std_price","colnm":"판매가","dtype":"num","etype":"none","attr":"hidden","defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_price","colnm":"현 판매가","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"ac_so_price","colnm":"실 판매가","dtype":"num","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":"\" \"","remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"qty_minus","colnm":"-","dtype":"text","etype":"btn","attr":null,"defval":null,"w":"3","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":7,"section":null,"section_icon":null,"colgrp":null,"colid":"so_qty","colnm":"판매수량","dtype":"num","etype":"txt","attr":"readonly","defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"},{"sort_seq":8,"section":null,"section_icon":null,"colgrp":null,"colid":"qty_plus","colnm":"+","dtype":"text","etype":"btn","attr":null,"defval":null,"w":"3","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"7"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"판매금액","dtype":"num","etype":"raw","attr":"keycol","defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"8"},{"sort_seq":10,"section":null,"section_icon":null,"colgrp":null,"colid":"cancel","colnm":"줄삭제","dtype":"text","etype":"btn","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"9"},{"sort_seq":11,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_nm","colnm":"상제품명","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":"count('goods_cd')+\"건\"","remark":null,"crud":"C","id":"10"},{"sort_seq":12,"section":null,"section_icon":null,"colgrp":null,"colid":"remark","colnm":"비고","dtype":"text","etype":"raw","attr":"link","defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"11"},{"sort_seq":13,"section":null,"section_icon":null,"colgrp":null,"colid":"pre_order_yn","colnm":"예약판매 여부","dtype":"text","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"12"},{"sort_seq":14,"section":null,"section_icon":null,"colgrp":null,"colid":"promotion","colnm":"프로모션","dtype":"text","etype":"btn","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"13"},{"sort_seq":15,"section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat_promo","colnm":"적용여부","dtype":"text","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"14"},{"sort_seq":16,"section":null,"section_icon":null,"colgrp":null,"colid":"org_qty","colnm":"승인수량","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"15"},{"sort_seq":17,"section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"승인여부","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"16"},{"sort_seq":18,"section":null,"section_icon":null,"colgrp":null,"colid":"so_seq","colnm":"No.","dtype":"num","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"17"},{"sort_seq":19,"section":null,"section_icon":null,"colgrp":null,"colid":"mov_yn","colnm":"수불반영여부","dtype":"text","etype":"none","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"18"},{"sort_seq":20,"section":null,"section_icon":null,"colgrp":null,"colid":"brcd","colnm":"브랜드코드","dtype":"text","etype":"none","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"19"},{"sort_seq":21,"section":null,"section_icon":null,"colgrp":null,"colid":"lg_tp","colnm":"물류유형","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"20"},{"sort_seq":22,"section":null,"section_icon":null,"colgrp":null,"colid":"discount_rt","colnm":"할인율","dtype":"num","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"21"},{"sort_seq":23,"section":null,"section_icon":null,"colgrp":null,"colid":"promo_tp","colnm":"할인종류","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"22"},{"sort_seq":24,"section":null,"section_icon":null,"colgrp":null,"colid":"promo_price","colnm":"프로모션 가격","dtype":"num","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"23"},{"sort_seq":25,"section":null,"section_icon":null,"colgrp":null,"colid":"stcd","colnm":"스타일코드","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"24"},{"sort_seq":26,"section":null,"section_icon":null,"colgrp":null,"colid":"rtn_yn","colnm":"반품여부","dtype":"text","etype":"raw","attr":"hidden","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"25"}]};
me.dataDef["_pgm_data"]["paylist"]={"sort_seq":"3","data_id":"paylist","data_nm":"결제내역","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"INOUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"seq","colnm":"순번","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"pay_tp","colnm":"결제유형","dtype":"text","etype":"sel","attr":"disabled","defval":null,"w":"10","h":null,"refcd":"PAY_TP","option":"sel:pay_tp::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"pay_amt","colnm":"결제액","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"remark","colnm":"비고","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태코드","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"cancelApv","colnm":"부분취소","dtype":"text","etype":"btn","attr":null,"defval":null,"w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"}]};
me.dataDef["_pgm_data"]["apvRst"]={"sort_seq":"4","data_id":"apvRst","data_nm":"승인요청/결과","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"INOUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"comcd","colnm":"회사코드","dtype":"text","etype":"none","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"so_no","colnm":"판매번호","dtype":"text","etype":"none","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"snd_msg","colnm":"발신메시지","dtype":"text","etype":"none","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"pay_seq","colnm":"지불순번","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"seq","colnm":"순번","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"rcv_comments","colnm":"수신코멘트","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"acquire_nm","colnm":"카드사","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"},{"sort_seq":7,"section":null,"section_icon":null,"colgrp":null,"colid":"approvalno","colnm":"승인번호","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"7"},{"sort_seq":8,"section":null,"section_icon":null,"colgrp":null,"colid":"approvaltime","colnm":"승인일시","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"8"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"tot_amt","colnm":"결제액","dtype":"num","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"9"},{"sort_seq":10,"section":null,"section_icon":null,"colgrp":null,"colid":"rcv_cd","colnm":"수신코드","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"10"},{"sort_seq":12,"section":null,"section_icon":null,"colgrp":null,"colid":"rcv_msg","colnm":"수신메시지","dtype":"text","etype":null,"attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"11"}]};
me.dataDef["_pgm_data"]["promoList"]={"sort_seq":"5","data_id":"promoList","data_nm":"프로모션제품조회결과","data_icon":null,"component_pgmid":"agGrid","component_option":{"gridOpt":"rn chk","func":[{"funcid":"check","func_nm":"적용","func_icon":"fas fa-check"}]},"inout_tp":"OUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"promo_cond_nm","colnm":"프로모션명","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_cd","colnm":"상품코드","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":"프로모션 기간","colid":"start_dt","colnm":"시작기간","dtype":"ymd","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":"프로모션 기간","colid":"end_dt","colnm":"종료기간","dtype":"ymd","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_price","colnm":"현 판매가","dtype":"num","etype":"raw","attr":"keycol","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"ac_so_price","colnm":"행사가","dtype":"num","etype":"raw","attr":"keycol","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":7,"section":null,"section_icon":null,"colgrp":null,"colid":"discount_rt","colnm":"할인율","dtype":"num","etype":"raw","attr":"dec1","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"},{"sort_seq":8,"section":null,"section_icon":null,"colgrp":null,"colid":"so_qty","colnm":"잔량","dtype":"num","etype":"raw","attr":"readonly","defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"7"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"qty","colnm":"행사수량","dtype":"num","etype":"raw","attr":"readonly","defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"8"},{"sort_seq":10,"section":null,"section_icon":null,"colgrp":null,"colid":"cfm","colnm":"적용","dtype":"text","etype":"btn","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"9"}]};
me.dataDef["_pgm_data"]["posinfo"]={"sort_seq":"6","data_id":"posinfo","data_nm":"POS정보","data_icon":null,"component_pgmid":"agGrid","component_option":{"height":"26em","remark":"판매등록하려는 POS를 선택하세요...","func":[{"funcid":"select","func_nm":"선택","func_icon":"fas fa-check"}]},"inout_tp":"IN","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"cd","colnm":"POS번호","dtype":"text","etype":"raw","attr":"keycol","defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"nm","colnm":"POS명","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"20","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"so_tp","colnm":"판매구분","dtype":"text","etype":"sel","attr":"disabled","defval":null,"w":"15","h":null,"refcd":"SO_TP","option":"sel:so_tp::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"cat_nm","colnm":"승인단말기번호","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"}]};
me.dataDef["_pgm_data"]["searchCond"]={"sort_seq":"7","data_id":"searchCond","data_nm":"영수증조회조건","data_icon":null,"component_pgmid":"aweForm","component_option":{"func":[{"funcid":"search","func_nm":"검색","func_icon":"fas fa-search"},{"funcid":"select","func_nm":"선택","func_icon":"fas fa-check"}]},"inout_tp":"IN","content":[{"sort_seq":"1","section":null,"section_icon":null,"colgrp":null,"colid":"so_no","colnm":"영수번호스캔","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":"2","section":null,"section_icon":null,"colgrp":null,"colid":"sale_dt","colnm":"판매일","dtype":"ymd","etype":"txt","attr":"ymd keycol","defval":"date()","w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":"3","section":null,"section_icon":null,"colgrp":null,"colid":"pay_amt","colnm":"금액","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":"4","section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태","dtype":"text","etype":"sel","attr":null,"defval":null,"w":null,"h":null,"refcd":"SO_STAT","option":"all:cd_stat::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"}]};
me.dataDef["_pgm_data"]["searchList"]={"sort_seq":"8","data_id":"searchList","data_nm":"영수증조회결과","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"OUT","content":[{"sort_seq":"1","section":null,"section_icon":null,"colgrp":null,"colid":"so_nm","colnm":"영수번호","dtype":"text","etype":"raw","attr":"keycol","defval":null,"w":"12","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":"2","section":null,"section_icon":null,"colgrp":null,"colid":"pay_time","colnm":"결제시간","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":"3","section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태","dtype":"text","etype":"raw","attr":"readonly","defval":null,"w":"6","h":null,"refcd":"SO_STAT","option":"sel:cd_stat::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":"4","section":null,"section_icon":null,"colgrp":null,"colid":"pay_tp","colnm":"결제구분","dtype":"text","etype":"raw","attr":"readonly","defval":null,"w":"8","h":null,"refcd":"PAY_TP","option":"sel:pay_tp::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":"5","section":null,"section_icon":null,"colgrp":null,"colid":"card_nm","colnm":"카드사","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":"6","section":null,"section_icon":null,"colgrp":null,"colid":"pay_amt","colnm":"결제액","dtype":"num","etype":"raw","attr":"keycol right","defval":null,"w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":"7","section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"매출액","dtype":"num","etype":"raw","attr":"right","defval":null,"w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"}]};
me.dataDef["_pgm_data"]["searchCond2"]={"sort_seq":"9","data_id":"searchCond2","data_nm":"대기영수증조회조건","data_icon":null,"component_pgmid":"aweForm","component_option":{"func":[{"funcid":"search","func_nm":"검색","func_icon":"fas fa-search"},{"funcid":"select","func_nm":"선택","func_icon":"fas fa-check"}]},"inout_tp":"IN","content":[{"sort_seq":"1","section":null,"section_icon":null,"colgrp":null,"colid":"so_no","colnm":"영수번호스캔","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":"2","section":null,"section_icon":null,"colgrp":null,"colid":"sale_dt","colnm":"판매일","dtype":"ymd","etype":"txt","attr":"ymd keycol","defval":"date()","w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":"3","section":null,"section_icon":null,"colgrp":null,"colid":"pay_amt","colnm":"금액","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":"4","section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태","dtype":"text","etype":"sel","attr":null,"defval":null,"w":null,"h":null,"refcd":"SO_STAT","option":"all:cd_stat::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"}]};
me.dataDef["_pgm_data"]["searchList2"]={"sort_seq":"10","data_id":"searchList2","data_nm":"대기영수증조회결과","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"OUT","content":[{"sort_seq":"1","section":null,"section_icon":null,"colgrp":null,"colid":"so_nm","colnm":"영수번호","dtype":"text","etype":"raw","attr":"keycol","defval":null,"w":"12","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":"2","section":null,"section_icon":null,"colgrp":null,"colid":"pay_time","colnm":"결제시간","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":"3","section":null,"section_icon":null,"colgrp":null,"colid":"cd_stat","colnm":"상태","dtype":"text","etype":"raw","attr":"readonly","defval":null,"w":"6","h":null,"refcd":"SO_STAT","option":"sel:cd_stat::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":"4","section":null,"section_icon":null,"colgrp":null,"colid":"pay_tp","colnm":"결제구분","dtype":"text","etype":"raw","attr":"readonly","defval":null,"w":"8","h":null,"refcd":"PAY_TP","option":"sel:pay_tp::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":"5","section":null,"section_icon":null,"colgrp":null,"colid":"card_nm","colnm":"카드사","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":"6","section":null,"section_icon":null,"colgrp":null,"colid":"pay_amt","colnm":"결제액","dtype":"num","etype":"raw","attr":"keycol right","defval":null,"w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":"7","section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"매출액","dtype":"num","etype":"raw","attr":"right","defval":null,"w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"}]};
me.dataDef["_pgm_data"]["searchOldCond"]={"sort_seq":"11","data_id":"searchOldCond","data_nm":"구POS영수증조회","data_icon":null,"component_pgmid":"aweForm","component_option":{"func":[{"funcid":"search","func_nm":"검색","func_icon":"fas fa-search"},{"funcid":"select","func_nm":"선택","func_icon":"fas fa-check"}]},"inout_tp":"IN","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"so_no","colnm":"영수번호","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_dt","colnm":"판매일","dtype":"ymd","etype":"txt","attr":"ymd keycol","defval":"date()","w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"old_pos","colnm":"POS시스템","dtype":"text","etype":"sel","attr":null,"defval":"A","w":null,"h":null,"refcd":"[{\"cd\":\"A\",\"nm\":\"A-POS\"},{\"cd\":\"Z\",\"nm\":\"Z-POS\"}]","option":"all:old_pos::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"}]};
me.dataDef["_pgm_data"]["searchOldList"]={"sort_seq":"12","data_id":"searchOldList","data_nm":"구POS영수증","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"OUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"doc_tp","colnm":"구시스템","dtype":"text","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"doc_no","colnm":"영수증번호","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"20","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"mov_dt","colnm":"판매일","dtype":"ymd","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"cnt","colnm":"건수","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"qty","colnm":"수량","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"매출액","dtype":"num","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"}]};
me.dataDef["_pgm_data"]["searchOldListGoods"]={"sort_seq":"13","data_id":"searchOldListGoods","data_nm":"구POS영수증상품","data_icon":null,"component_pgmid":"agGrid","component_option":null,"inout_tp":"OUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_cd","colnm":"상품코드","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"12","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_nm","colnm":"상품명","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"25","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"qty","colnm":"수량","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"금액","dtype":"num","etype":"raw","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"}]};
me.dataDef["_pgm_data"]["msgBtnPanel"]={"sort_seq":"14","data_id":"msgBtnPanel","data_nm":"결제등록 정보","data_icon":null,"component_pgmid":"aweForm","component_option":null,"inout_tp":"IN","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"pay_tp","colnm":"결제유형","dtype":"text","etype":"sel","attr":"keycol","defval":null,"w":"10","h":"3","refcd":"[{\"cd\":\"1\",\"nm\":\"카드\"},{\"cd\":\"2\",\"nm\":\"현금\"}]","option":"sel:pay_tp::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"card_nm","colnm":"카드사명","dtype":"text","etype":"txt","attr":"keycol","defval":null,"w":"10","h":"3","refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"tot_amt","colnm":"결제액","dtype":"num","etype":"txt","attr":"pk","defval":null,"w":"10","h":"3","refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"}]};

        me.pageObj["_page"] = new gfnFramepage( me ); 
        for(var component_id in me.dataDef["_pgm_data"]) { 
            me.pageObj[component_id] = new gfnComponent( me.pageid, component_id, me.dataDef["_pgm_data"][component_id], me.fnEH, me); 
        }  
        setTimeout(function(){
            $("#frameset").scrollTo(0); //스크롤 
        },10);
        if(typeof(me.fnInitExtra)=='function') me.fnInitExtra(); 
    } 
/*-- SCRIPT autogen end ---------------------------------------------- */
  /* 사용자초기화 */ 
    me.fnInitExtra=function() {
        me.deptcd = gUserinfo.deptcd;
        me.deptnm = gUserinfo.deptnm;
        me.logTx("registerSO", "fnInitExtra");
        me.pageObj.msgBtnPanel.container.hide(); 
        $("#btntemporary").hide();
        me.page.find("button#btnChange2").hide();
        //권한제어
        function _auth(auth) {
            if(isNull(auth)) { 
                gfnAlert("시스템 사용권한 점검","화면에 대한 권한이 없습니다!");
                $("*[pageidx='"+me.pageid+"']").remove();
                delete gfn[me.pageid]; 
                me.page.remove(); 
            } else {
                if(isNull(auth.save_yn) || auth.save_yn != "Y") {
                    me.pageObj._pageFunc.setDisp("new",false);
                    me.pageObj._pageFunc.setDisp("search",false);
                    me.pageObj._pageFunc.setDisp("search_old",false);
                    me.pageObj._pageFunc.setDisp("save",false);
                    me.pageObj._pageFunc.setDisp("print",false);
                    me.pageObj._pageFunc.setDisp("delete",false); 
                }
            } 
        }
        if(subset(gds.comcd,"grpcd","pgm_auth").length==0) { //프로그램 권한조회하여
            gfnGetData("pgm_auth",function(rtn){
                _auth(subset(rtn,"pgmid",pgmid)[0]);  //해당 프로그램의 권한값 가져오기
            }); 
        } else {
            _auth(subset(subset(gds.comcd,"grpcd","pgm_auth"),"pgmid",pgmid)[0]) ;
        } 
        
        //탭 설정
        gfnTab(pageid, "tabs"); 
        
        //사용자 매장정보가 없으면 화면을 닫는다. 
        if(isNull(me.deptcd)) {
           gfnAlert("사용자 매장정보 확인","사용자의 매장정보가 존재하지 않습니다. 다시 로그인하거나 매장정보 등록 후 진행하십시오.");
        }
        //버튼 이벤트 바인딩
        me.page.find(".card").on("click", me.fnTx3);  //카드결제
        me.page.find(".cash").on("click", me.fnTx4);  //현금결제
        me.page.find(".btnTemp").on("click", me.fnsearchPop2);   //대기버튼
        me.page.find("#btnTemp").on("click", me.fnsearchPop2);  //대기버튼2
        me.page.find("#btnChange").on("click", me.fnChange);
        me.page.find("#btnChange2").on("click", me.fnSaveDirect2);
        me.page.find("button#btntemporary").on("click", me.btntemporary);  //대기버튼2
        me.page.find("button#btnNew").on("click", me.fnNew);
        me.page.find(".goodssearch").on("click",me.fnreservationSO);
        me.page.find("button#btnSave").on("click", me.fnSaveDirect);   //무승인 거래확정
        me.page.find("button#btnReturn").on("click", function() {  //반품처리 : X & C
            if(me.bReturnOld) { 
                me.fnReturnOldRun("return"); //구POS반품처리 
            } else {
                me.fnReturn();
            }
        }); 
        me.page.find("button#btnReApv").on("click", function() {    //재승인 : X & C + N
            me.fnReApv();
        });  
        
        //상품코드 바코드 직접 입력하고 엔터치면 줄추가 되도록!
        me.page.find(".scanbox").keydown(function(key){
            if(key.keyCode == 13){
                console.log(key.keyCode);
                me.fnGoodsSearch();
            }
        });

        //영수증 검색팝업
        var searchPop = me.page.find("#searchPop");
        me.searchPop = gfnPopup("영수증 조회",searchPop,{
            autoOpen: false,
			resizable: false, 
			modal: true, 
			minWidth: 600,
			minHeight: 400,  
			close:  function(){
			    $(this).dialog("close"); 
			}
		});  
		
		//대기영수증 검색팝업
        var searchPop2 = me.page.find("#searchPop2");
        me.searchPop2 = gfnPopup("대기영수증 조회",searchPop2,{  
            autoOpen: false,
			resizable: false, 
			modal: true, 
			minWidth: 600,
			minHeight: 400,  
			close:  function(){
			    $(this).dialog("close"); 
			}
		});
		
		//영수증(구POS) 검색팝업
        var searchOldPop = me.page.find("#searchOldPop");
        me.searchOldPop = gfnPopup("구POS 영수증 조회",searchOldPop,{  
            autoOpen: false,
			resizable: false, 
			modal: true, 
			minWidth: 600,
			minHeight: 400,  
			close:  function(){
			    $(this).dialog("close"); 
			}
		});
		var searchPromo = me.page.find("#searchPromo");
        me.searchPromo = gfnPopup("프로모션 조회",searchPromo,{
            autoOpen: false,
			resizable: false, 
			modal: true, 
			minWidth: 800,
			minHeight: 400,  
			close:  function(){
			    $(this).dialog("close"); 
			}
		}); 
		
        //화면초기화 
        gMDI.screen(true);
        // me.pageObj.itemlist.componentTop.hide(); 
        me.page.find("#totalpaylist").show();
        me.page.find("button#btnSave").hide(); 
        me.page.find("button#btnTemp").hide();  
        me.page.find("button#btnReturn").hide();
        me.page.find("button#btnReApv").hide();
        
        me.fnCalcAmt(); //금액계산

        //기본정보 세팅 
        //매장POS정보 세팅 - me.deptcd = 매장코드  
        me.page.find("input[colid=so_usid]").val(gUserinfo.userid||' '||gUserinfo.usernm);
        //pos_no확인 후 입력받기 
        var posinfo = me.page.find("#posinfo");
        me.posinfo = gfnPopup("POS선택",posinfo,{  
            autoOpen: false,
			resizable: false, 
			modal: true, 
			minWidth: 600,
			minHeight: 400,  
			close:  function(){
			    function checkChoice(pop) {
			        if(isNull(me.pageObj.mst.getVal("pos_no"))) {
    			        gfnStatus("먼저 POS번호를 선택해주세요...");
    			        me.pageObj._pageFunc.setDisp("new",false);
                        me.pageObj._pageFunc.setDisp("search",false);
                        me.pageObj._pageFunc.setDisp("search_old",false);
                        me.pageObj._pageFunc.setDisp("save",false);
                        me.pageObj._pageFunc.setDisp("print",false);
                        me.pageObj._pageFunc.setDisp("delete",false); 
    			    } else { 
    			        pop.dialog("close"); 
    			    }    
			    }
			    setTimeout(checkChoice, 100, $(this)); 
			}
		}); 
		
		//점에 등록된 POS번호 목록조회 후 
		if( isNull(me.pos_no) ) {
            me.fnChangePos();
        } else { //사용자-POS정보가 있으면 세팅 후 
            //신규 등록상태로 시작
            //상품코드 바코드 스캔에 포커스 
            me.fnNew();
        }
    }

    /* 이벤트핸들러 */
    me.fnEH=function(component, evt, row, col, val) { 
        //console.log(evt+","+row+","+col+","+val);
        //화면기능버튼이 눌리면 
        if (component==me.pageObj["_pageFunc"]){ 
            if(typeof(me[col])=='function') me[col](); //col=기능명 me["fnSearch"]()=me.fnSearch(); 
        } 
        
        //POS번호선택
        if (component==me.pageObj["posinfo"]){ 
            if(evt=="dblclick") {
                if(row < 0) {
                    gfnAlert("POS선택","정확한 POS를 선택하세요");
                } else {
                    me.fnSetPosinfo( row );     
                } 
            }
            if (evt=="componentFunc" && row=="select") {
                var currow = component.selectedRow();
                if(currow < 0) {
                    gfnAlert("POS선택","POS번호를 선택 후 [선택]버튼을 클릭하세요");
                } else {  
                    me.fnSetPosinfo( currow );
                } 
            }
        }
        
        //상품목록 
        if(component==me.pageObj["itemlist"]) {
            
            if(evt=="change" && me.pageObj.mst.getVal("cd_stat")=="C" ) { 
                gfnAlert("입력확인","반품된 전표의 상품은 수정할 수 없습니다.");
                return;
            }
            if(evt=="componentFunc") {
                if(row=="addRow") {
                    component.addRow();
                    me.bEdit = true;
                } else if(row=="delRow") {
                    me.bEdit = true;
                    component.delRow();
                    me.fnCalcAmt();
                } else if(row=="delList"){
                    me.bEdit = true;
                    component.delRow();
                    me.fnCalcAmt();
                } else if(row == "promotion"){
                    /*
                    gParam = me.pageObj["itemlist"].exportData("selected"); 
                    console.log(gObj);
                    var searchPop = $("<div id='stkPop' class='framepage active'></div>");
                    var searchPopup = null; 
                    gfnLoad("fo_pos","popupPromo",searchPop,function(){
                        searchPopup = gfnPopup("할인율 적용",searchPop,{width:800, height:600});
                    });
                    */
                    var nodeId = component.selectedRow();
                    if(nodeId < 0) {
                        gfnStatus("프로모션 가격을 가져오려는 줄을 선택하세요!")
                        return;
                    } 
                    if( isNull(component.getVal(nodeId,"remark")) ) {
                        gfnStatus("프로모션 중인 상품을 선택하세요!")
                        return;
                    } 
                    var item = component.getVal(nodeId,"goods_cd");
                    var goods_cd = item;
                    me.fnPromotion(goods_cd, nodeId); 
                }
            }
            if( (evt=="change"||evt=="enter") && col=="goods_cd") {
                if(row >= 0) {
                    me.bEdit = true;
                    me.fnGoodsSearch(row);
                    
                }
            }
            if(evt=="click") {
                if( col=="qty_plus") {
                    component.setVal(row,"so_qty", toNum(component.getVal(row,"so_qty"))+1);
                    if(component.getVal("cd_stat")=="Y") {
                        component.setVal(row,"remark","변경전 수량:"+component.getVal(row,"org_qty"));
                    } 
                    me.fnCalcAmt();
                    
                } else if ( col=="qty_minus") {
                    var mst = me.pageObj["mst"].exportData();
                    var itemlist = me.pageObj["itemlist"].exportData()[0];
                    if(itemlist.so_qty > 0 ){
                        if(toNum(component.getVal(row,"so_qty"))-1 < 1) {
                            gfnStatus("판매수량은 1보다 작을 수 없습니다. 취소하려면 [줄삭제] 하십시오.");
                            return;
                        }
                    }
                    if(component.getVal("cd_stat")=="Y") {
                        component.setVal(row,"remark","변경전 수량:"+component.getVal(row,"org_qty"));
                    }
                    component.setVal(row,"so_qty", toNum(component.getVal(row,"so_qty"))-1); 
                    me.fnCalcAmt();

                } else if ( col=="cancel") { 
                    // 반품전표나 기승인된 전표에서 상품을 지우려고 하면 반품처리 한다.
                    if(me.pageObj.mst.getVal("cd_stat")=="Y") { 
                        gfnAlert("줄삭제확인","승인된 전표에 등록된 상품을 삭제할 수 없습니다.");
                        return;
                    } 
                    component.delRow(row, true);
                    me.fnCalcAmt();
                } 
            }
            if(evt=="change") {
                if(col=="sale_price" || col=="so_qty") {  //판가나 수량을 직접 수정할 수 없음 
                    if(component.getVal("cd_stat")=="Y") {
                        component.setVal(row,"remark","변경전 수량:"+component.getVal(row,"org_qty"));
                    }
                    me.fnCalcAmt();
                }
            }
            if(evt=="dblclick"){
                if(col=="remark" && !isNull(val) && row >= 0) {
                    var item = component.getVal(row,"goods_cd");
                    var goods_cd = item;
                    me.fnPromotion(goods_cd, row); 
                }
            }
        }  
        
        //지불내역에서 단건 승인취소
        if (component==me.pageObj["paylist"]){ 
            if (evt=="click" && col=="cancelApv") {
                me.fnCancelApv(row);
            }
        } 

        //영수증팝업 조회조건
        if (component==me.pageObj["searchCond"]){
            if (evt=="enter") {
                console.log("searchCondEnter");
                me.fnSearchPop();
            }
            if (evt=="componentFunc") { 
                if(row=="search") {
                    console.log("searchCondsearch");
                    me.fnSearchPop();                
                } 
                if(row=="select") {
                    if(row < 0) {
                        gfnAlert("영수번호 선택","정확한 영수번호를 선택하세요");
                    } else {
                        var so_no = component.getVal(row,"so_no");
                        me.fnResearch( so_no );     
                    } 
                }
            }
        } 
        //영수증팝업 조회목록
        if (component==me.pageObj["searchList"]){ 
            if(evt=="dblclick") {
                if(row < 0) {
                    gfnAlert("영수번호 선택","정확한 영수번호를 선택하세요");
                } else {
                    var so_no = component.getVal(row,"so_no");
                    me.fnResearch( so_no );     
                } 
            } 
        }
        
        //프로모션 상품 조회 목록
        if (component==me.pageObj["promoList"]){ 
            if (evt=="componentFunc") { 
                if(row=="check") {
                    var list = component.exportData("selected");
                    console.log(list);
                    me.fnPromoApply(list); 
                }    
            }
            if(evt=="dblclick") {
                var list = component.exportData("selected");
                console.log(list);
                me.fnPromoApply(list); 
            }
            if(evt == "click"){
                if(col == "cfm"){
                    var list = component.exportData("selected");
                    console.log(list);
                    me.fnPromoApply(list); 
                }    
            }
        }
        
        //대기영수증 조회조건
        if (component==me.pageObj["searchCond2"]){ 
            if (evt=="enter") {
                me.fnSearchPop2();
            }
            if (evt=="componentFunc") { 
                if(row=="search") {
                    console.log("search2");
                    me.fnSearchPop2();                
                } 
                if(row=="select") {
                    console.log("select2");
                    if(row < 0) {
                        gfnAlert("영수번호 선택","정확한 영수번호를 선택하세요");
                    } else {
                        var so_no = component.getVal(row,"so_no");
                        me.fnResearch( so_no );     
                    } 
                }
            }
        } 
        //대기영수증팝업 조회목록
        if (component==me.pageObj["searchList2"]){ 
            console.log("searchList2");
            if(evt=="dblclick") {
                if(row < 0) {
                    gfnAlert("영수번호 선택","정확한 영수번호를 선택하세요");
                } else {
                    var so_no = component.getVal(row,"so_no");
                    me.fnResearch( so_no );     
                } 
            } 
        }

        //영수증(구POS)팝업 조회조건
        if (component==me.pageObj["searchOldCond"]){ 
            if (evt=="enter") {
                me.fnSearchOldPop();
            }
            if (evt=="componentFunc") { 
                if(row=="search") {
                    me.fnSearchOldPop();                
                } 
                if(row=="select") {
                    var currow = me.pageObj["searchOldList"].selectedRow();
                    if(currow < 0) {
                        gfnAlert("영수증 선택","정확한 영수증을 선택하세요");
                    } else {  
                        //신규생성 후 상품목록 적용하여 반품처리 
                        var rowData = me.pageObj.searchOldList.getRowData(currow);
                        me.fnReturnOld(rowData); 
                    }
                }
            }
        } 
        //영수증(구POS)팝업 조회목록
        me.currow = -1;
        if (component==me.pageObj["searchOldList"]){ 
            if(evt=="focus") {
                if(row >= 0 && me.currow != row) { 
                    var args = me.pageObj["searchOldList"].getRowData(row); 
                    args.shopcd = me.deptcd;
                    args.pos_no = me.pos_no; 
                    var invar = JSON.stringify(args);
                    gfnTx(appid+"."+pgmid,"qrySonoOldGoods",{INVAR:invar},function(OUTVAR){
                        if(OUTVAR.rtnCd=="OK") {
                            me.currow = row;
                            me.pageObj.searchOldListGoods.importData(OUTVAR.list);
                        } else {
                            gfnAlert("검색오류", OUTVAR.rtnMsg);
                        }
                    }); 
                }
            }
            if(evt=="dblclick") {
                if(row < 0) {
                    gfnAlert("영수번호 선택","정확한 영수번호를 선택하세요");
                } else {
                     //신규생성 후 상품목록 적용하여 반품처리 
                    var rowData = me.pageObj.searchOldList.getRowData(row);
                    me.fnReturnOld(rowData); 
                } 
            } 
        }

    }
    
    
    
    //프로모션 가격 적용
    me.fnPromoApply=function(list) {
        //validation
        var nodeId = me.pageObj.promoList.selectedRow();
        if(nodeId < 0) {
            gfnStatus("가격을 적용하려는 프로모션을 선택하세요!");
            return;
        }
        console.log(list)
        //총수량 정해진 프로모션인 경우
        // var qty = component.getVal(row,"qty");
        // if(!isNull(qty)) {
        //     var so_qty = component.getVal(row,"so_qty"); /* 잔량 */
        //     if(so_qty < 1){
        //         gfnAlert("수량 없음","현재 프로모션 남은 수량이 없습니다.");
        //         return;
        //     }
        // }
        /* promoList에서 선택된 row 행사가격을 itemlist의 me.rtn_row의 ac_so_price세팅해준다. */
        var item = list[0];
        me.searchPromo.dialog("close");
        console.log(item);
        /* 목록 중 상품이 있으면 수량을 증가시켜줌, 신규 건은 위로 쌓이도록 */
        var itemlist = me.pageObj["itemlist"].exportData();
        for(i=0;i<itemlist.length;i++){
            if(itemlist[i].goods_cd == item.goods_cd){
                itemlist[i].ac_so_price = item.ac_so_price;
                itemlist[i].cd_stat_promo = 'Y';
            }
        }
        me.pageObj["itemlist"].importData(itemlist);
        // var bSkipAdd = false;
        // for(var i=0; i < itemlist.countRow(); i++) {
        //     var row = itemlist.getNodeId(i);
        //     var itemgoodslist = itemlist.getVal(row,"goods_cd");
        //     var itemgoods = itemgoodslist.substr(0,9);
        //     if(isNull(me.pageObj.mst.getVal("remark"))){
        //         if(itemgoods==item.goods_cd && itemlist.getVal(row,"rtn_yn")!='Y') {
        //             itemlist.setVal(row,"cd_stat_promo","Y");
        //             itemlist.setVal(row,"remark","프로모션 적용");
        //             itemlist.setVal(row,"ac_so_price",item.ac_so_price);
        //             bSkipAdd = true;
        //             break;
        //         }
        //     }
        // }
        // if(!bSkipAdd) {
        //     item.so_qty=1;
        //     itemlist.addRow(item,-1);
        // }
        me.fnCalcAmt();            
    }
    
    
    //POS선택 *************************************************************************************************/
    me.fnChangePos=function() { 
		gfnGetData("POS",function(rtn){
		    if(isNull(rtn) || rtn.length==0) {
		        gfnAlert("사용자 매장정보 확인","매장 POS정보가 존재하지 않습니다. 다시 로그인하거나 매장마스터에서 POS정보 등록 후 진행하십시오.");
		    } else {
    		    me.pageObj.posinfo.importData(rtn); //점에 등록된 POS목록
    		    me.poslist = rtn;
                me.posinfo.dialog("open");     		    
		    }
		},"",me.deptcd); 
    }  
    //전달된 POS정보로 기초정보 세팅
    me.fnSetPosinfo=function(posdata) {
        var posinfo = me.pageObj.posinfo.getRowData(posdata);
        // 팝업으로 POS번호를 받는다
        me.pos_no = lpad(posinfo.cd,3,"0");
        me.so_tp  = posinfo.so_tp;
        me.cat_nm = posinfo.cat_nm;
        me.nm     = posinfo.nm; 
        me.apv_yn = gfnCdNm("SO_TP",me.so_tp,"val_3"); //POS의 판매형태에 등록된 승인
        var online_yn = gfnCdNm("SO_TP",me.so_tp,"val_1");
        if(online_yn == 'ON'){
            gfnAlert("잘못된 POS 선택","온라인POS는 판매등록(온라인)에서 진행하여 주십시오");
        }
        if(me.apv_yn=="Y") { //무승인 거래등록 창 열고 닫기
            me.page.find("#totalpaylist").show();
            me.page.find("button#btnSave").hide(); 
        } else {
            me.page.find("#totalpaylist").hide();
            me.page.find("button#btnSave").show();
            me.page.find("#buttonlist").hide();
        } 
        me.page.find("button#btnReturn").hide();
        me.page.find("button#btnReApv").hide();
        me.posinfo.dialog("close");
        me.pageObj._pageFunc.setDisp("new",true);
        me.pageObj._pageFunc.setDisp("search",true);
        me.pageObj._pageFunc.setDisp("save",true);
        me.pageObj._pageFunc.setDisp("print",true);
        me.pageObj._pageFunc.setDisp("delete",true);         
        me.fnNew();
    } 

    //*******************************************************************************************************/
    //new: 신규등록 또는 재승인 등록 초기화 : 임시 so_no번호 조회 -> seq_so_no는 저장시점에 채번 
    me.fnNew=function(arg2) {
        if(isNull(me.pos_no)) {
            gfnAlert("POS선택 확인","판매를 등록하려는 POS정보를 먼저 선택하세요!");
            return;
        }
        //세션정보로 부터 판매기본정보 조회 
        me.pageObj.mst.reset();
        console.log(me)
        me.pageObj.mst.setVal("pos_no",me.pos_no);
        me.pageObj.mst.setVal("so_tp",me.so_tp);
        me.pageObj.mst.setVal("cat_nm",me.cat_nm);
        me.pageObj.mst.setVal("nm", me.nm);        
        me.pageObj.mst.setVal("so_usid", gUserinfo.userid+" "+gUserinfo.usernm);
        me.pageObj._page.pageTitle.text(me.nm+" 판매등록");  
        me.pageObj["itemlist"].reset();
        me.pageObj["paylist"].reset();
        me.pageObj["apvRst"].reset(); 
        me.page.find("input[name=scanbox]").attr("value","");
        me.fnCalcAmt(); 
		var args = me.pageObj["mst"].exportData()[0]
		console.log(args)
		args.grpid = me.deptcd;  //매장정보 조회 - me.deptcd = 매장코드
		var invar = JSON.stringify(args);
		gfnTx(appid+"."+pgmid,"sonoSearch",{INVAR:invar},function(OUTVAR){  //임시 판매번호 조회
            if(OUTVAR.rtnCd=="OK") {
                console.log(OUTVAR);
                me.pageObj["mst"].importData(OUTVAR.mst); 
                me.pay_seq = 0;
                if(!isNull(arg2)) {
                    me.pageObj.mst.setVal("remark","반품재승인 "+arg2.so_nm+"("+arg2.so_no+")");
                    me.pageObj.itemlist.importData(arg2.itemlist);
                    var args2 = me.pageObj["itemlist"].exportData();
                    var sum = 0;
                    for(var i=0;i<args2.length;i++){
                        var list = me.pageObj["itemlist"].exportData()[i];
                        var sale_amt = list.sale_amt;
                        sum = sum + Number(sale_amt);
                    }
                    me.page.find("input[name=totalpay]").val( format(sum) );
                    me.page.find("input[name=balance").val(format(sum));
                    gfnAlert("반품재승인","상품정보 수정후 재승인 진행 하십시오.");
                }
                me.fnResetButtons();
                me.page.find(".scanbox").focus();  //상품코드 바코드 스캔에 포커스
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });
    }
    
    me.fnNew2=function(arg2) {
        if(isNull(me.pos_no)) {
            gfnAlert("POS선택 확인","판매를 등록하려는 POS정보를 먼저 선택하세요!");
            return;
        }
        //세션정보로 부터 판매기본정보 조회 
        me.pageObj.mst.reset();
        me.pageObj.mst.setVal("pos_no",me.pos_no);
        me.pageObj.mst.setVal("so_tp",me.so_tp);
        me.pageObj.mst.setVal("cat_nm",me.cat_nm);
        me.pageObj.mst.setVal("nm", me.nm);        
        me.pageObj.mst.setVal("so_usid", gUserinfo.userid+" "+gUserinfo.usernm);
        me.pageObj._page.pageTitle.text(me.nm+" 판매등록");  
        me.pageObj["itemlist"].reset();
        me.pageObj["paylist"].reset();
        me.pageObj["apvRst"].reset(); 
        me.page.find("input[name=scanbox]").attr("value","");
        me.fnCalcAmt(); 
		var args = me.pageObj["mst"].exportData()[0]
		args.grpid = me.deptcd;  //매장정보 조회 - me.deptcd = 매장코드
		var invar = JSON.stringify(args);
		gfnTx(appid+"."+pgmid,"sonoSearch",{INVAR:invar},function(OUTVAR){  //임시 판매번호 조회
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj["mst"].importData(OUTVAR.mst);
                me.pay_seq = 0;
                if(!isNull(arg2)) {
                    
                    me.pageObj.mst.setVal("remark","교환 "+arg2.so_nm+"("+arg2.so_no+")");
                    me.pageObj.itemlist.importData(arg2.itemlist);
                    var args2 = me.pageObj["itemlist"].exportData();
                    var sum = 0;
                    for(var i=0;i<args2.length;i++){
                        var list = me.pageObj["itemlist"].exportData()[i];
                        var sale_amt = list.sale_amt;
                        sum = sum + Number(sale_amt);
                    }
                    me.page.find("input[name=totalpay]").val( format(sum) );
                    me.page.find("input[name=balance").val(format(sum));
                    gfnAlert("교환처리","상품정보 수정후 재승인 진행 하십시오.");
                }
                me.fnResetButtons();
                me.page.find("#btnChange2").show();
                me.page.find(".scanbox").focus();  //상품코드 바코드 스캔에 포커스
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });  
    }

    //**************************************************************************************************************/
    // 상품 검색 
    me.fnGoodsSearch=function(goods_cd,lg_tp) {
        var brcd = upper(me.page.find("input[name=scanbox]").val()); 
        if(isNull(brcd)){
            brcd = goods_cd;
        }
        var barcd = brcd.trim()+"*";
        if(isNull(barcd)) return;
        var mst = me.pageObj["mst"].exportData()[0];
        var args = {barcd : barcd, shopcd : me.deptcd, sale_dt : mst.sale_dt};
        var invar = JSON.stringify(args); 
        console.log(invar)
        gfnTx(appid+"."+pgmid,"goodsSearch",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                if(isNull(OUTVAR.list)||OUTVAR.list.length==0) {
                    gfnAlert("상품검색오류","바코드 또는 상품코드에 해당하는 상품을 검색할 수 없습니다!");
                    $("input[name=scanbox]").val("");
                    return;
                }
                var item = OUTVAR.list[0];
                /*
                //var reglist = me.pageObj["itemlist"].exportData();
                var item2 = OUTVAR.list2[0];
                console.log(reglist)
                if(!isNull(item2)){
                    if(item2.start_dt <= mst.sale_dt && item2.end_dt >= mst.sale_dt || (item2.shopcd == me.deptcd || item2.shopcd == 'LFN') ){
                        item.remark = "프로모션 상품";
                        item.discount_rt = toNum(item2.discount_rt);
                        item.promo_tp = item2.promo_tp;
                        item.cd_stat_promo = 'Y';
                        // if(item.promo_tp != '정률'){
                        //     item.ac_so_price = item2.promo_price;
                        // }else{
                        //     item.ac_so_price = item.ac_so_price * ((100-item2.discount_rt)/100);
                        //     // item.ac_so_price = item.ac_so_price-(item.ac_so_price/item2.discount_rt); 
                        // }
                        // console.log(item);
                    }else{
                        item.remark = "";
                    }
                }
                */
                /* 목록 중 상품이 있으면 수량을 증가시켜줌, 신규 건은 위로 쌓이도록 */
                var itemlist = me.pageObj.itemlist;
                var bSkipAdd = false;
                for(var i=0; i < itemlist.countRow(); i++) {
                    var row = itemlist.getNodeId(i);
                    if(isNull(me.pageObj.mst.getVal("remark"))) { // && isNull(item2)){
                        if(itemlist.getVal(row,"goods_cd")==item.goods_cd && itemlist.getVal(row,"rtn_yn")!='Y') {
                            itemlist.setVal(row,"so_qty", (toNum(itemlist.getVal(row,"so_qty"))+1) );    
                            bSkipAdd = true;
                            break;
                        }
                    }
                    if(itemlist.getVal(row,"stcd") == item.stcd && itemlist.getVal(row,"cd_stat_promo") == 'Y'){
                        item.sale_price = itemlist.getVal(row,"sale_price");
                        item.ac_so_price = itemlist.getVal(row,"ac_so_price");
                        item.remark = itemlist.getVal(row,"remark");
                        item.cd_stat_promo = itemlist.getVal(row,"cd_stat_promo");
                    }
                }
                if(!bSkipAdd) {
                    item.so_qty=1;
                    itemlist.addRow(item,-1);
                }
                if(!isNull(goods_cd)){
                    var reglist = me.pageObj["itemlist"].exportData();
                    for(i=0;i<reglist.length;i++){
                        if(reglist[i].goods_cd == goods_cd){
                            reglist[i].pre_order_yn ="Y";
                            reglist[i].lg_tp = lg_tp;
                        }
                    }
                    me.pageObj["itemlist"].importData(reglist);
                }
                me.fnCalcAmt();
                me.page.find("input[name=scanbox]").val(""); 
                me.page.find(".scanbox").focus();
                /* 매장요청 'CKSR0F690B20XS' 바코드는 상/하의 한벌세트 상품인데, 따로 알고 있지 않으면 직원 확인이 어렵다고 하여 해당 상품코드는 알람 팝업 띄우기 요청 (2022-08-24 mjw 수정)*/
                if(item.set_yn == 'Y'){
                    gfnAlert("상품 확인","해당 상품코드는 세트 상품 입니다.");
                }
            } else {
                gfnAlert("조회오류***"+OUTVAR.rtnCd, OUTVAR.rtnMsg);
                $("input[name=scanbox]").val("");
            }
        });
    }

    //**************************************************************************************************************/
    //품목추가, 수량, 가격 변경에 따른 상품금액, 결제잔액 계산 
    me.fnCalcAmt=function() {
        var itemlist = me.pageObj.itemlist;
        var total = 0;
        for(var i=0; i < itemlist.countRow(); i++) {
            var row        = itemlist.getNodeId(i);
            var so_qty     = itemlist.getVal(row,"so_qty");
            var sale_price = itemlist.getVal(row,"sale_price");
            var ac_so_price = itemlist.getVal(row,"ac_so_price");
            var rtn_yn     = itemlist.getVal(row,"rtn_yn");
            /*
            if(so_qty > 0){
                var sale_amt   = toNum(so_qty*ac_so_price);
                
                if(!isNull(promo_tp) && promo_tp == '정률' && !isNull(discount_rt)){
                    var sale_amt   = toNum(so_qty*(ac_so_price-(ac_so_price/discount_rt))*((rtn_yn=="Y")?-1:1))
                    console.log(sale_amt)
                }        
                else{
                    var sale_amt   = toNum( so_qty*ac_so_price*((rtn_yn=="Y")?-1:1) );
                }
                
            }
            */
            if(so_qty > 0){
                var sale_amt   = toNum( so_qty*ac_so_price*((rtn_yn=="Y")?-1:1) );
            }else{
                var sale_amt   = toNum(so_qty*ac_so_price);
            }
            itemlist.setVal(row, "sale_amt", sale_amt);
            itemlist.setVal(row, "ac_so_price",ac_so_price);
            total += sale_amt; 
        }
        var paylist = me.pageObj.paylist;
        var pay_total = 0;
        for(var i=0; i < paylist.countRow(); i++) {
            var row        = paylist.getNodeId(i);
            var cd_stat     = paylist.getVal(row,"cd_stat");
            var pay_amt     = paylist.getVal(row,"pay_amt");
            pay_amt   = toNum( pay_amt*((cd_stat=="Y")?1:-1));
            pay_total += pay_amt; 
            
        } 
        var balance = total - pay_total;
        // if(balance < 0) {
        //     // gfnStatus("부분결제이후 상품삭제로 인해 잔액이 0보다 작아진 경우 이력보호를 전표를 삭제할 수 없습니다. 상품결제 완료처리 후 반품 또는 재승인 바랍니다.");
        // }
        me.page.find("input[name=totalpay]").val( format( total  ) );
        me.page.find("input[name=payment]").val(  format( pay_total) );  
        me.page.find("input[name=balance]").val(  format( balance ) );  
        me.pageObj.itemlist.total("bottom");
        me.pageObj.paylist.total("top"); 
        me.fnlocal();
    } 

    //**************************************************************************/
    //sonoSave: 판매전표번호를 채번하여 리턴함 
    me.fnSonoSave=function(fnCallback) {
        var args = me.pageObj["mst"].exportData()[0];
		args.grpid = me.deptcd;  //매장정보 조회 - me.deptcd = 매장코드
		args.pos_no = me.pos_no;
		console.log("fnSonoSave");		
		var invar = JSON.stringify(args);
		gfnTx(appid+"."+pgmid,"sonoSave",{INVAR:invar},function(OUTVAR){
		    console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj["mst"].setVal("so_no",OUTVAR.mst[0].so_no);
                me.pageObj["mst"].setVal("sale_seq",OUTVAR.mst[0].sale_seq);
                me.pageObj["mst"].setVal("so_nm",OUTVAR.mst[0].so_nm);
                me.pageObj["mst"].setVal("cd_stat","N");
                if(!isNull(fnCallback)) fnCallback();
            } else {
                gfnAlert("판매번호 채번 오류",OUTVAR.rtnMsg);
            }
        }); 
    }
    
    //**************************************************************************************************************/    
    //save: 대기상태로 저장 또는 결제처리 전 임시저장 
    me.fnSave=function(fnCallback) { //me.fnSave(_fnSavePay); 
        if( !me.pageObj["mst"].chkValid() ) return;
        if( me.pageObj.itemlist.countRow()==0 ) {
            gfnAlert("저장확인","저장할 판매상품 내용이 없습니다.");
            return; 
        }
        if( !isNull(me.pageObj.mst.getVal("cd_stat")) && me.pageObj.mst.getVal("cd_stat")!="N") {
            if( me.pageObj.mst.getVal("so_end_yn")=="Y") { 
                gfnAlert("저장확인","판매마감된 판매전표입니다. 수정하려면 반품처리 후 재 등록하여야 합니다.");
                return; 
            } else if(isNull(fnCallback)) { 
                gfnAlert("저장확인","결제내역이 존재하는 판매전표는 대기상태로 저장할 수 없습니다. 우선 판매 완료처리 후 후속작업 하시기 바랍니다.");
                return; 
            }
        } 
        function _fnSave() {
            var list = []; 
            var args = me.pageObj["mst"].exportData()[0];
            args.orgcd  = me.orgcd;
            args.shopcd = me.deptcd;
            args.pos_no = me.pos_no;
            args.so_tp  = me.so_tp; 
            console.log(args)
            // var itemlist = me.pageObj["itemlist"].exportData();
            // var change = "교환";
            // if(args.remark.indexOf(change)!= -1){
            //     //교환처리 된 전표
            //     var itemlists = [];
            //     for(i=0;i<itemlist.length;i++){
            //         if(itemlist[i].sale_amt < 0)
            //     }
                
            // }else{
            //     //일반 전표
            // }
            args.itemlist = me.pageObj["itemlist"].exportData();
            console.log("_fnSave");
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"save",{INVAR:invar},function(OUTVAR){ 
                console.log(OUTVAR)
                if(OUTVAR.rtnCd=="OK") { //임시저장시 delete insert한다. 
                    if(!isNull(fnCallback)) {
                        
                        me.pageObj.itemlist.importData(OUTVAR.itemlistRtn);
                        gfnStatus("판매전표정보가 저장되었습니다. 승인/취소정보를 저장합니다!");
                        fnCallback();
                    } else {
                        gfnAlert("저장성공","판매전표를 저장하였습니다.");
                        me.fnNew(); //대기로 걸어놓고 신규등록 모드로 변경 - Research(args.so_no);
                    } 
                } else {
                    gfnAlert("조회오류",OUTVAR.rtnMsg);
                }
            });
        } 
        //첫 저장일 경우 판매번호 다시조회
        if(isNull(me.pageObj.mst.getVal("cd_stat"))) {
            me.fnSonoSave(_fnSave); //채번후 저장
        } else {
            _fnSave(); //그대로 저장 
        } 
    } 

    //**************************************************************************************************************/    
    //무승인 전표저장 
    me.fnSaveDirect=function() {
        function _fnSavePay() {
            var args = me.pageObj.mst.exportData()[0];
            args.shopcd = me.deptcd;  
            args.pay_tp = '2'; //현금 {pay_tp} 
            args.pay_amt = me.pageObj.itemlist.cvalbottom("0","sale_amt")    //등록된 판매금액 {pay_amt} 
            args.pos_no = me.pageObj.mst.getVal("pos_no"); //{pos_no}  
            args.approvaltime = date("today","yyyymmddhh24miss");
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"saveDirect",{INVAR:invar},function(OUTVAR){ //무승인 현금저장
                if(OUTVAR.rtnCd=="OK") {
                    gfnStatus("저장완료 - 무승인 판매전표 승인정보를 저장하였습니다."); 
                    me.fnSaveCfm(); //me.fnNew(); //Research( me.pageObj.mst.getVal("so_no") );
                }else{
                    gfnAlert("오류",OUTVAR.rtnMsg);
                } 
            }); 
        }
        gfnConfirm("전표등록확인","해당 전표를 등록 하시겠습니까 ?",function(rtn){
           if(rtn) me.fnSave(_fnSavePay); //우선 전표채번, 헤더, 상품목록을 저장한다.
        });
        // me.fnSave(_fnSavePay); 
    }
    
    me.fnSaveDirect2=function() {
        if(me.page.find("input[name=totalpay]").val() != '0'){
            gfnAlert("오류","총액이 0원이 아닐경우 등가교환 버튼을 사용할 수 없습니다.");
            return;
        }
        if(me.pageObj.itemlist.getVal("so_qty") == '0'){
            gfnAlert("판매수량이 0 일경우 교환처리를 할 수 없습니다.");
        }
        function _fnSavePay() {
            var args = me.pageObj.mst.exportData()[0];
            args.shopcd = me.deptcd;  
            args.pay_tp = '2'; //현금 {pay_tp} 
            args.pay_amt = me.pageObj.itemlist.cvalbottom("0","sale_amt")    //등록된 판매금액 {pay_amt} 
            args.pos_no = me.pageObj.mst.getVal("pos_no"); //{pos_no}  
            args.approvaltime = date("today","yyyymmddhh24miss");
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"saveDirect",{INVAR:invar},function(OUTVAR){ //무승인 현금저장
                if(OUTVAR.rtnCd=="OK") {
                    gfnStatus("저장완료 - 등가교환 판매전표 승인정보를 저장하였습니다."); 
                    me.fnSaveCfm(); //me.fnNew(); //Research( me.pageObj.mst.getVal("so_no") );
                }else{
                    gfnAlert("오류",OUTVAR.rtnMsg);
                } 
            }); 
        }
        gfnConfirm("전표등록확인","해당 전표를 등록 하시겠습니까 ?",function(rtn){
           if(rtn) me.fnSave(_fnSavePay); //우선 전표채번, 헤더, 상품목록을 저장한다.
        }); 
        // me.fnSave(_fnSavePay); 
    }


    //**************************************************************************************************************/    
    //승인 후 전표확정저장
    me.fnSaveCfm=function() {
        var itemlists = me.pageObj["itemlist"].exportData();
        for(i=0;i<itemlists.length;i++){
           itemlists[i].so_no = me.pageObj.mst.getVal("so_no");
           itemlists[i].so_seq = isNull(itemlists[i].so_seq)?(i+1):itemlists[i].so_seq;
           itemlists[i].shopcd = me.deptcd;
           itemlists[i].sale_dt = me.pageObj.mst.getVal("sale_dt"); 
        }
        var args = me.pageObj.mst.exportData()[0]; 
        args.shopcd = me.deptcd;
        args.list = itemlists;
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"saveCfm",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR)
            if(OUTVAR.rtnCd=="OK") {
                gfnStatus("저장완료 - 판매전표가 승인완료 되었습니다.");
                setTimeout(function(){
                    if(me.apv_yn == 'Y'){
                      me.fnPrint2();
                    }else{
                      me.fnPrint();
                    }
                },1500);
                
                
                 //Research( me.pageObj.mst.getVal("so_no") );
            }else{
                gfnAlert("오류",OUTVAR.rtnMsg);
            } 
        });
    }  


    //**************************************************************************************************************/    
    //search:이전 판매전표 조회 
    me.fnSearch=function() {  //저장후 재조회 할때 so_no 보낼 것 
        me.searchPop.dialog("open");
        me.pageObj.searchCond.reset();
        me.fnSearchPop(); 
    }
    me.fnPromotion=function(goods_cd, rtn_row) { 
        me.searchPromo.dialog("open");
        me.fnsearchPromo(goods_cd, rtn_row);
    }
    me.fnsearchPop2=function() {  //저장후 재조회 할때 so_no 보낼 것 
        me.searchPop2.dialog("open");
        me.pageObj.searchCond.reset();
        console.log("fnsearchPop2");
        me.fnSearchPop2();
    } 
    //영수증번호 조회
    me.fnSearchPop=function() {
        var args = me.pageObj["searchCond"].exportData()[0]; 
        args.so_no  = args.so_no.substring(0,12);
        args.shopcd = me.deptcd;
        args.pos_no = me.pos_no;
        args.pay_amt = format(args.pay_amt);
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"qrySono",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj.searchList.importData(OUTVAR.list);
                me.pageObj.searchList.total("top");
            } else {
                gfnAlert("검색오류", OUTVAR.rtnMsg);
            }
        }); 
    }
    me.fnsearchPromo=function(goods_cd, rtn_row){
        //me.searchPromo
        var args = {}; 
        args.goods_cd = goods_cd; 
        args.sale_dt  = me.pageObj.mst.getVal("sale_dt");
        args.shopcd   = me.deptcd;
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"searchPromo",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                var mst = me.pageObj["mst"].exportData()[0];
                var itemlist = OUTVAR.list[0];
                // if(mst.sale_dt >= itemlist.start_dt && mst.sale_dt <= itemlist.end_dt){
                me.pageObj["promoList"].importData(OUTVAR.list);
                me.rtn_row = rtn_row; /* 프로모션 목록에서 가격선택시 실판가를 적용시켜줘야할 itemlist의 row */
                // }
            } else {
                gfnAlert("검색오류", OUTVAR.rtnMsg);
            }
        }); 
    }
    //대기 영수증번호 조회
    me.fnSearchPop2=function() {  
        console.log("fnSearchPop2");
        var args = me.pageObj["searchCond2"].exportData()[0];
        args.so_no  = args.so_no.substring(0,12);
        args.shopcd = me.deptcd;
        args.pos_no = me.pos_no;
        args.pay_amt = format(args.pay_amt);
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"qrySono2",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj.searchList2.importData(OUTVAR.list);
                me.pageObj.searchList2.total("top");
            } else {
                gfnAlert("검색오류", OUTVAR.rtnMsg);
            }
        }); 
    } 
    //research:(재)조회 
    me.fnResearch=function(so_no) {
        console.log("fnResearch");
        me.searchPop.dialog("close");
        me.searchPop2.dialog("close");
        me.pageObj.mst.setVal("so_no",so_no);
        if( !me.pageObj["mst"].chkValid() ) return;
        var args = me.pageObj["mst"].exportData()[0];
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"search",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                var mst = OUTVAR.list[0];
                var list2 = OUTVAR.list2;
                if(mst.cd_stat == 'N'){
                    var today = new Date();
                    var year = today.getFullYear();
                    var month = ('0' + (today.getMonth() + 1)).slice(-2);
                    var day = ('0' + today.getDate()).slice(-2);
                    var dateString = year + month  + day;
                    mst.sale_dt = dateString;
                    me.pageObj["mst"].importData(mst);
                }else{
                    me.pageObj["mst"].importData(mst);
                }
                me.fnResetButtons();
                me.pageObj["itemlist"].importData(OUTVAR.list2);  
                me.pageObj["paylist"].importData(OUTVAR.paylist); 
                me.pageObj["apvRst"].importData(OUTVAR.apvRst); 
                var itemlist = me.pageObj["itemlist"].exportData();
                for(i=0;i<itemlist.length;i++){
                    if(itemlist[i].cd_stat_promo == 'Y'){
                        itemlist[i].remark = "프로모션 상품";
                    }
                } 
                me.fnCalcAmt();  
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });
    } 
    
    //**************************************************************************************************************/    
    //delete:대기전표삭제 
    me.fnDelete=function() {
        if( !me.pageObj["mst"].chkValid() ) return;
        if( !isNull(me.pageObj.mst.getVal("cd_stat")) && me.pageObj.mst.getVal("cd_stat")!="N" ) {
            gfnAlert("대기전표 삭제확인","결제된 전표 또는 반품전표는 삭제할 수 없습니다.");
            return;
        } else if (isNull(me.pageObj.mst.getVal("cd_stat"))) {
            gfnAlert("대기전표 삭제확인","아직 저장되지 않은 판매전표입니다.");
            return;
        // } else if ( me.pageObj.paylist.countRow() > 0 ) {
        //     gfnAlert("대기전표 삭제확인","지불(승인/취소)내역이 존재하는 전표는 이력보관을 위해 삭제할 수 없습니다.");
        //     return;
        } 
        function _fnDelete() {
            var args = me.pageObj["mst"].exportData()[0];
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"delete",{INVAR:invar},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    gfnStatus("대기전표가 삭제되었습니다.");
                    me.fnNew();
                } else {
                    gfnAlert("조회오류",OUTVAR.rtnMsg);
                }
            });
        }
        gfnConfirm("대기전표삭제","대기전표 삭제 시 본 판매전표를 다시 되돌릴 수 없으므로 반드시 임의등록 후 삭제 하시기 바랍니다. 정말로 삭제 하시겠습니까 ?",function(rtn){
           if(rtn) _fnDelete(); 
        });
    }  


    //**************************************************************************************************************/    
    //반품처리 : 결제완료된 전표에 결제취소 대상을 순차적으로 반품처리한다. 완료되면 전표재승인여부를 묻는다.
    me.fnReturn=function() {
        if( !me.pageObj.mst.chkValid() ) return;
        if( me.pageObj.mst.getVal("cd_stat")!="Y") {
            gfnAlert("반품확인","반품처리 할 수 없는 상태의 판매전표입니다.");
            return;
        }
        gfnConfirm("반품확인",
              "본 판매전표를 반품처리하시겠습니까?",
              function(rtn) {
                  if(rtn==true) me.fnReturnRun();
              }
        );
    }
    me.fnReturnRun=function(rtn_tp) {
        //최종처리: 헤더업데이트 및 수불반영
        function _fnReturn(paylist) {
            var args = me.pageObj.mst.exportData()[0];
            args.shopcd = me.deptcd;
            args.paylist = isNull(paylist)?[]:paylist;
            args.rtn_tp  = "return"; //무조건 반품처리하고 재승인처리시에 업데이트 
            console.log("fnReturnRun")
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"saveReturn",{INVAR:invar},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") { 
                    gfnStatus("반품처리를 완료하였습니다.!");
                    me.fnResearch(OUTVAR.so_no_rtn);
                    setTimeout(function(){
                        if(me.apv_yn == 'Y'){
                            me.fnPrint2();    
                        }else{
                            me.fnPrint();
                        }
                    },2000);
                    
                } else {
                    gfnAlert("반품저장 오류",OUTVAR.rtnMsg);
                }
            });
        }
        //승인필요일 경우 순차적으로 반품처리 한다.
        if(me.apv_yn=="Y") { 
            //취소대상 가져오기
            var paylist = me.pageObj.paylist.exportData();
            var rtnlist = [];
            for(var i=0; i < paylist.length; i++) { 
                //지불상태가 Y 승인이고 결제유형이 1 카드인 경우만 승인취소 받음.
                if(paylist[i].cd_stat=="Y") rtnlist.push(paylist[i].id); //= rowid paylist[i].pay_tp=="1"
            }
            if(rtnlist.length==0) { //승인취소대상이 없으므로 바로 반품처리
                _fnReturn();
            } else {                
                function fnAskPopup() { //한 건씩 취소
                    if(rtnlist.length == 0) {
                        _fnReturn(); //다음건 없으면 최종처리 _fnReturn() 
                    } else {
                        var currow = rtnlist.splice(0,1);
                        me.fnCancelApv(currow, fnAskPopup); 
                    } 
                }
                fnAskPopup();
            } 
        //무승인 건에 대한 반품처리는 지불내역의 상태를 모두 C로 변경 후 처리한다.     
        } else {
            var args = me.pageObj.mst.exportData()[0];
            args.shopcd = me.deptcd; 
            args.pay_amt = me.pageObj.itemlist.cvalbottom("0","sale_amt");
            args.approvaltime = date("today","yyyymmddhh24miss");
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"saveReturnPay",{INVAR:invar},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") { 
                    gfnStatus("무승인 결제취소 정보를 저장하였습니다.");
                    _fnReturn();
                } else {
                    gfnAlert("무승인 결제취소 저장 오류",OUTVAR.rtnMsg);
                }
            }); 
        }
    }  
    /* 대기상태 부분승인 후 부분취소처리 ****************************************/
    me.fnCancelApv=function(row, fnCallback) {
        if(row < 0) {
            gfnAlert("승인취소 확인","잘못된 지불내역이 선택되었습니다.");
            return;
        }       
        var mstinfo = me.pageObj.mst.exportData()[0];
        var payinfo = me.pageObj.paylist.getRowData(row);
        
        //상태체크
        if(payinfo.cd_stat != "Y") {
            gfnAlert("승인취소 확인", "승인되지 않았거나 이미 취소상태입니다.");
            return
        }
        //결제 유형이 '1' ('카드') 일 때 
        if(payinfo.pay_tp == '1'){
            var pay_seq = me.pay_seq + 1;
            var shopcd = me.deptcd;
            var shopcds = {shopcd : shopcd};
            var invar2 = JSON.stringify(shopcds);
            gfnTx(appid+"."+pgmid,"shopsearch",{INVAR:invar2},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    gParam.shoplist = OUTVAR.list;
    		        gParam.itemlist = me.pageObj["itemlist"].exportData();
    		        gParam.apvRstlist = me.pageObj["apvRst"].exportData()
                    gParam.mstlist = me.pageObj["mst"].exportData()[0];
    		        gParam.so_tp = gfnCdNm("SO_TP",me.so_tp,"nm"); 
                    gParam.payinfo = payinfo;
                    //승인취소 팝업띄우고 
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx9.html?20211210','cardcancel',
                    'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
            
                    //콜백
                    gParam.fnCallback = function(rtn) {
                        
                        me.logTx("usdcancel", rtn);
                        /********************취소는 통신 실패일 경우 임의등록할 수 없다 *********************************/
                        var res_cd = rtn.data.RES_CD;
                        if(res_cd == '0000'){
                            //헤더와아이템저장 후 결제저장
                            function _fnSavePayCancel() {  
                                
                                console.log("취소통신 완료");
                    			var args = {};
                    			args.send      = rtn.taRequest; //요청전문
                    			args.res_cd    = res_cd;   //응답코드
                    			args.receive   = rtn.data; // 응답전문
                    			args.mst       = me.pageObj["mst"].exportData()[0];
                    			args.orgcd     = me.orgcd;
                    			args.shopcd    = me.deptcd; 
                    			args.so_tp_val = gfnCdNm("SO_TP",me.so_tp,"nm");
                    			args.so_tp     = args.so_tp_val;
                    			args.so_no     = me.pageObj.mst.getVal("so_no"); 
                    			args.seq       = payinfo.seq;  
                    			args.pay_amt   = payinfo.pay_amt;
                    			args.pay_tp    = "1"; //카드
                    			args.card_nm   = rtn.data.ACQUIRE_NM;
                    			var invar = JSON.stringify(args);
                    			gfnTx(appid+"."+pgmid,"usdCancel",{INVAR:invar},function(OUTVAR){
                                    console.log("카드승인취소 저장");
                                    me.pageObj["paylist"].importData(OUTVAR.paylist);
                                    me.pageObj["apvRst"].importData(OUTVAR.apvRst);
                                    if(OUTVAR.rtnCd=="OK") { 
                                        if(res_cd == '0000'){  //취소처리성공이었으면 
                                            me.pageObj["paylist"].setVal(row,"cd_stat","C"); //상태 바꿔주고
                                            var paylist = me.pageObj["paylist"].exportData(); //잔액계산
                                            var sum = 0;
                                            for(var i=0;i<paylist.length;i++){
                                                if(paylist[i].cd_stat=="Y") sum += toNum(paylist[i].pay_amt);
                                                else if(paylist[i].cd_stat=="C") sum -= toNum(paylist[i].pay_amt); 
                                            }
                                            me.page.find("input[name=payment]").val( format(sum) );
                                            me.page.find("input[name=balance").val( format( toNum(me.page.find("input[name=totalpay]").val()) - toNum(me.page.find("input[name=payment]").val()) ) );
                                            
                                            if(!isNull(fnCallback)) fnCallback();
                                        } else {
                                            gfnAlert("카드승인취소 오류","승인취소 통신시 오류가 발생하여 승인취소를 진행할 수 없습니다. 사유 : "+ rtn.data.DISPLAY);
                                            return false;
                                        }
                                    } else {
                                        gfnAlert("카드승인취소 저장오류",OUTVAR.rtnMsg);
                                    }
                                });
                            }
                            //먼저 헤더와 아이템정보 저장하고 callback으로 _fnSavePay를 호출 
                            me.fnSave(_fnSavePayCancel); 
                        }else{
                            gfnAlert("카드승인취소 저장오류","정상적으로 취소처리가 되지 않았습니다.");
                        }
                        
                    } 
                }
            })   
        //결제 유형이 '2' ('현금') 일 때     
        } else {
            var pay_seq = me.pay_seq + 1;
            var shopcd = me.deptcd;
            var shopcds = {shopcd : shopcd};
            var invar2 = JSON.stringify(shopcds);
            gfnTx(appid+"."+pgmid,"shopsearch",{INVAR:invar2},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    gParam.shoplist = OUTVAR.list;
                    gParam.apvRstlist = me.pageObj["apvRst"].exportData();
    		        gParam.itemlist = me.pageObj["itemlist"].exportData();
                    gParam.mstlist = me.pageObj["mst"].exportData()[0];
    		        gParam.so_tp = gfnCdNm("SO_TP",me.so_tp,"nm"); 
                    gParam.payinfo = payinfo;
                    //승인취소 팝업띄우고 
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx10.html?20211210','cashcancel',
                    'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                    //콜백
                    gParam.fnCallback = function(rtn) {
                        /********************취소는 통신 실패일 경우 임의등록할 수 없다 *********************************/
                        var res_cd = rtn.data.RES_CD;
                        if(res_cd == '0000'){
                            function _fnSavePayCancel() {
                                //헤더와아이템저장 후 결제저장
                                var card_nm = rtn.data.CARDNO;
                                if(card_nm == "010000") {
                                    card_nm = "현금";
                                }else{
                                    card_nm = "현금영수증";
                                }
                                console.log("취소통신 완료");
                    			var args = {};
                    			args.send      = rtn.taRequest; //요청전문
                    			args.res_cd    = res_cd;   //응답코드
                    			args.receive   = rtn.data; // 응답전문
                    			args.mst       = me.pageObj["mst"].exportData()[0];
                    			args.orgcd     = me.orgcd;
                    			args.shopcd    = me.deptcd; 
                    			args.so_tp_val = gfnCdNm("SO_TP",me.so_tp,"nm");
                    			args.so_tp     = args.so_tp_val;
                    			args.so_no     = me.pageObj.mst.getVal("so_no"); 
                    			args.seq       = payinfo.seq;  
                    			args.pay_amt   = payinfo.pay_amt;
                    			args.pay_tp    = "2"; //현금
                    			args.card_nm   = card_nm;
                    			var invar = JSON.stringify(args);
                    			gfnTx(appid+"."+pgmid,"usdCancel",{INVAR:invar},function(OUTVAR){
                                    console.log("현금승인취소 저장");
                                    me.pageObj["paylist"].importData(OUTVAR.paylist);
                                    me.pageObj["apvRst"].importData(OUTVAR.apvRst);
                                    if(OUTVAR.rtnCd=="OK") { 
                                        if(res_cd == '0000'){  //취소처리성공이었으면 
                                            me.pageObj["paylist"].setVal(row,"cd_stat","C"); //상태 바꿔주고
                                            var paylist = me.pageObj["paylist"].exportData(); //잔액계산
                                            var sum = 0;
                                            for(var i=0;i<paylist.length;i++){
                                                if(paylist[i].cd_stat=="Y") sum += toNum(paylist[i].pay_amt);
                                                else if(paylist[i].cd_stat=="C") sum -= toNum(paylist[i].pay_amt); 
                                            }
                                            me.page.find("input[name=payment]").val( format(sum) );
                                            me.page.find("input[name=balance").val( format( toNum(me.page.find("input[name=totalpay]").val()) - toNum(me.page.find("input[name=payment]").val()) ) );
                                            
                                            if(!isNull(fnCallback)) fnCallback();
                                        } else {
                                            gfnAlert("현금승인취소 오류","승인취소 통신시 오류가 발생하여 승인취소를 진행할 수 없습니다. 사유 : "+ rtn.data.DISPLAY);
                                            return false;
                                        }
                                    } else {
                                        gfnAlert("현금승인취소 저장오류",OUTVAR.rtnMsg);
                                    }
                                });
                            }
                            //먼저 헤더와 아이템정보 저장하고 callback으로 _fnSavePay를 호출 
                            me.fnSave(_fnSavePayCancel); 
                        }else{
                            gfnAlert("현금승인취소 저장오류","정상적으로 취소가 되지 않았습니다.");
                        }
                        
                       
                    }
                }
            })
        } 
    } 
    
    
    //**************************************************************************************************************/    
    //재승인처리 : 반품전표를 1회에 한하여 신규전표로 이동한다. 
    me.fnReApv=function(bDirect) {
        function _fnReApv() {
            var itemlist = me.pageObj.itemlist.exportData();
            var args = me.pageObj.mst.exportData()[0];
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"reApv",{INVAR:invar},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    var arg2 = {};
                    arg2.so_no = me.pageObj.mst.getVal("so_no");
                    arg2.so_nm = me.pageObj.mst.getVal("so_nm");
                    for(var i=0; i < itemlist.length; i++) {
                        var item1 = itemlist[i].sale_amt;
                        itemlist[i].sale_amt = item1*-1;
                        itemlist[i].rtn_yn = "N";
                    }
                    arg2.itemlist = me.pageObj.itemlist.exportData();
                    me.fnNew(arg2); 
                }else{
                    gfnAlert("오류",OUTVAR.rtnMsg);
                }
            });
        }
        if(me.pageObj.mst.getVal("so_content")=="반품재승인") {
            gfnAlert("재승인 확인","이미 반품재승인 처리된 전표입니다. 반품재승인은 1회에 한해 가능합니다.");
            return;
        } else {
            if(bDirect) {
                _fnReApv();
            } else {
                gfnConfirm("재승인 확인","반품전표를 재승인 하시겠습니까?(1회한) ",function(rtn){
                   if(rtn) _fnReApv();  
                });
            }
        }
    } 
    
    //교환처리
    me.fnChange=function(){
        if( !me.pageObj.mst.chkValid() ) return;
        if( me.pageObj.mst.getVal("cd_stat")!="Y") {
            gfnAlert("교환확인","교환처리 할 수 없는 상태의 판매전표입니다.");
            return;
        }
        if(me.pageObj.itemlist.getVal("so_qty") == '0'){
            gfnAlert("판매수량이 0 일경우 교환처리를 할 수 없습니다.");
            return;
        }
        gfnConfirm("반품확인",
              "본 판매전표를 교환처리하시겠습니까?",
              function(rtn) {
                  if(rtn==true) me.fnChangeRun();
              }
        );

    }
    
    me.fnChangeRun=function(cDirect){
        function _fnReChange() {
            var itemlist = me.pageObj.itemlist.exportData();
            var args = me.pageObj.mst.exportData()[0];
            var invar = JSON.stringify(args);
            gfnTx(appid+"."+pgmid,"reChange",{INVAR:invar},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    var arg2 = {};
                    arg2.so_no = me.pageObj.mst.getVal("so_no");
                    arg2.so_nm = me.pageObj.mst.getVal("so_nm");
                    for(var i=0; i < itemlist.length; i++) {
                        var item_sale_amt = itemlist[i].sale_amt;
                        var item_so_qty = itemlist[i].so_qty;
                        itemlist[i].sale_amt = item_sale_amt*-1;
                        itemlist[i].so_qty = item_so_qty*-1;
                        itemlist[i].rtn_yn = "N";
                        itemlist[i].crud = "C";
                    }
                    arg2.itemlist = me.pageObj.itemlist.exportData();
                    me.fnNew2(arg2); 
                }else{
                    gfnAlert("오류",OUTVAR.rtnMsg);
                }
            });
        }
        if(cDirect) {
            _fnReChange();
        } else {
           _fnReChange();  
        }
    }
    //**************************************************************************************************************/    
    //search: 구시스템 판매전표 조회팝업 호출
    me.fnSearch_old=function() {   
        me.searchOldPop.dialog("open"); 
        me.fnSearchOldPop(); 
    } 
    //구시스템 판매전표 조회
    me.fnSearchOldPop=function() {  
        var args = me.pageObj["searchOldCond"].exportData()[0]; 
        args.shopcd = me.deptcd;
        args.pos_no = me.pos_no;
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"qrySonoOld",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj.searchOldList.importData(OUTVAR.list);
            } else {
                gfnAlert("검색오류", OUTVAR.rtnMsg);
            }
        }); 
    } 
    //구POS 데이터 가져와서 반품치기
    me.fnReturnOld=function(rowData) {
        if(!isNull(rowData)) me.searchOldPop.dialog("close"); 

        if(isNull(me.pos_no)) {
            gfnAlert("POS선택 확인","판매를 등록하려는 POS정보를 먼저 선택하세요!");
            return;
        } 
        //세션정보로 부터 판매기본정보 조회 
        me.pageObj.mst.reset();
        me.pageObj.mst.setVal("pos_no",me.pos_no);
        me.pageObj.mst.setVal("so_tp",me.so_tp);
        me.pageObj.mst.setVal("cat_nm",me.cat_nm);
        me.pageObj.mst.setVal("nm", me.nm);        
        me.pageObj.mst.setVal("so_usid", gUserinfo.userid+" "+gUserinfo.usernm);
        me.pageObj._page.pageTitle.text(me.nm+" 반품등록(구POS)");  
        me.pageObj["itemlist"].reset();
        me.pageObj["paylist"].reset();
        me.pageObj["apvRst"].reset(); 
        me.page.find("input[name=scanbox]").attr("value","");
        me.fnCalcAmt(); 
		var args = me.pageObj["mst"].exportData()[0]
		args.grpid = me.deptcd;  //매장정보 조회 - me.deptcd = 매장코드 
		var invar = JSON.stringify(args);
		gfnTx(appid+"."+pgmid,"sonoSearch",{INVAR:invar},function(OUTVAR){ 
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj["mst"].importData(OUTVAR.mst);
                me.pageObj.mst.setVal("cd_stat","Y"); 
                me.pageObj.mst.setVal("remark", "구POS:"+rowData.doc_no+"반품 수기취소");
                var olditemlist = me.pageObj.searchOldListGoods.exportData();
                for(var i=0; i<olditemlist.length;i++) {
                    var row = me.pageObj.itemlist.addRow();
                    me.pageObj.itemlist.setVal(row,"goods_cd",olditemlist[i].goods_cd);
                    me.pageObj.itemlist.setVal(row,"goods_nm",olditemlist[i].goods_nm);
                    me.pageObj.itemlist.setVal(row,"so_qty",olditemlist[i].qty);
                    me.pageObj.itemlist.setVal(row,"sale_amt",olditemlist[i].sale_amt);
                    var sale_price = toNum(toNum(olditemlist[i].sale_amt)/toNum(olditemlist[i].qty));
                    me.pageObj.itemlist.setVal(row,"sale_price",sale_price);
                    me.pageObj.itemlist.setVal(row,"org_qty",olditemlist[i].qty);
                    me.pageObj.itemlist.setVal(row,"cd_stat","Y");
                    me.pageObj.itemlist.setVal(row,"mov_yn","Y");
                    me.pageObj.itemlist.setVal(row,"remark","구POS반품"); 
                }
                me.fnResetButtons(); 
                me.page.find("#msg").show();
                me.page.find("#msgPanel").text("카드사를 입력한 후 반품 또는 재승인 버튼을 클릭하세요.");
                me.pageObj.msgBtnPanel.container.show();
                $("select[colid=card_nm]").change(function(){
                    var card_nm = $("select[colid=card_nm] option:selected").val();
                    var pay_tp = gfnCdNm("CARD_CD",card_nm,"val_1");
                    var pay_tp_nm = gfnCdNm("PAY_TP",pay_tp,"nm");
                    var html = "";
                    html+= pay_tp;
                    html+= "[" + pay_tp_nm + "]";
                    $("span[colid=pay_tp]").val(pay_tp);
                    $("span[colid=pay_tp]").html(html);
                })
                me.bReturnOld = true;
                me.fnCalcAmt();
                me.pageObj.msgBtnPanel.setVal("tot_amt",me.pageObj.itemlist.cvalbottom("0","sale_amt"));
                gfnAlert("구POS판매 반품처리","구POS판매정보를 확인하고 전화승인 등으로 카드승인 취소 후 [반품]하시기 바랍니다.");
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });  
    } 
    me.fnReturnOldRun=function(sFlag) {
        if( !me.pageObj["msgBtnPanel"].chkValid() ) return;
        //sFlag: "return"반품처리, "reApv"반품후재매입 
        var args = me.pageObj["mst"].exportData()[0];
        args.so_no  = "N/A";
		args.shopcd = me.deptcd;  
		args.itemlist = me.pageObj.itemlist.exportData(); 
		args.pay_tp = me.pageObj.msgBtnPanel.getVal("pay_tp");
		args.card_nm = me.pageObj.msgBtnPanel.getVal("card_nm");
		args.tot_amt = me.pageObj.msgBtnPanel.getVal("tot_amt");
		args.approvaltime = date("today","yyyymmddhh24miss");
		args.so_tp    = me.so_tp;
		var invar = JSON.stringify(args); 
        gfnTx(appid+"."+pgmid,"returnOldRun",{INVAR:invar},function(OUTVAR){ 
            if(OUTVAR.rtnCd=="OK") { 
                gfnStatus("구POS 판매데이터 반품처리를 완료하였습니다.!");
                me.fnResearch(OUTVAR.so_no_rtn); 
                me.bReturnOld = false;
            } else {
                gfnAlert("구POS 판매데이터 반품처리 오류",OUTVAR.rtnMsg);
            }
        });  
    } 
    

    //전표발행용 매장정보조회 
    me.fnshopSearch=function() {
        var shopcd = me.deptcd;
        var args = {shopcd : shopcd};
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"shopsearch",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj["mst"].importData(OUTVAR.list);
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });
    }
    
    me.fnreservationSO=function() {
        gObj = me.pageObj["itemlist"].exportData("selected");
        console.log(gObj);
        var searchPop = $("<div id='stkPop' class='framepage active'></div>");
        var searchPopup = null; 
        gfnLoad("fo_pos"," reservationSO",searchPop,function(){
            searchPopup = gfnPopup("스타일 상품조회",searchPop,{width:1000, height:650});
        });
        function _fnreservation(goods_cd,ea,adress,phone,nm,whcd,lg_tp){
            console.log(goods_cd)
            console.log(ea)
            console.log(whcd)
            console.log(nm)
            console.log(phone)
            console.log(adress)
            var mst = me.pageObj["mst"].exportData();
            console.log(mst);
            mst[0].goods_cd = goods_cd;
            mst[0].so_content = nm + " " + phone + " " + adress;
            mst[0].pre_order_yn = "Y";
            mst[0].ea = ea;
            mst[0].whcd = whcd;
            mst[0].lg_tp = lg_tp;
            mst[0].remark = "예약판매 : "+ me.deptcd + " " + me.deptnm;
            mst[0].nm = nm;
            mst[0].phone = phone;
            mst[0].adress = adress;
            me.pageObj["mst"].importData(mst);
            console.log(me.pageObj["mst"].exportData());
            searchPopup.dialog("close");
            me.fnGoodsSearch(goods_cd,lg_tp);
        }
        gObj.fnCallback = _fnreservation; 
        
    }
 
    
    //승인결과 조회
     me.fnapvRstSearch=function() {
        if( !me.pageObj["mst"].chkValid() ) return;
        var args = me.pageObj["mst"].exportData()[0];
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"apvRstsearch",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj["apvRst"].importData(OUTVAR.list);
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });
    }
    
    //재발행 버튼 클릭 시 영수증 출력 
    me.fnPrint = function(){
        console.log("me.print");
        if( !me.pageObj["mst"].chkValid() ) return;
        // if( me.apv_yn!="Y") {
        //     gfnAlert("영수증 (재)발행 확인","무승인 판매등록 건은 영수증을 발행할 수 없습니다.");
        //     return;
        // }
        // if( me.pageObj.mst.getVal("cd_stat")!="Y" && me.pageObj.mst.getVal("cd_stat")!="C" && me.apv_yn == "Y") {
        //     gfnAlert("영수증 (재)발행 확인","판매전표의 상태가 승인 또는 반품이 아닙니다.");
        //     return;
        // }
        if( me.pageObj.apvRst.countRow() < 0 && me.apv_yn == "Y") {
            gfnAlert("영수증 (재)발행 확인","승인내역이 존재하지 않아 영수증을 발행할 수 없습니다.");
            return;
        } 
        // if( isNull(me.pageObj.apvRst.getVal("0","rcv_msg")) && me.apv_yn == "Y") {
        //     gfnAlert("영수증 (재)발행 확인","임의 등록된 판매영수증은 발행기능은 준비중입니다. IT팀 문의바랍니다.");
        //     return;
        // }
        var args = me.pageObj["mst"].exportData()[0];
        args.shopcd = me.deptcd;
        var invar = JSON.stringify(args);
        
        gfnTx(appid+"."+pgmid,"print",{INVAR:invar},function(OUTVAR){
            console.log("print jsp 완료");
            if(OUTVAR.rtnCd=="OK") {
                var mst = args;
                var sale_dt = mst.sale_dt;
                var shoplist = OUTVAR.list[0]; //매장정보 및 매장경영인 이름 리스트
                var itemlist = me.pageObj.itemlist.exportData(); // 상품코드, 판매수량, 판매가격, 판매액 리스트
                var apvRst = me.pageObj.apvRst.exportData(); // 
                var paylist = me.pageObj.paylist.exportData();
                //상품목록에 있는 갯수만큼 sale_amt 값을 더해 총 합계 금액 계산
                var sum = 0;
                for(i=0;i<itemlist.length;i++){
                    var tot_amt = new Number(itemlist[i].sale_amt);
                    sum = sum + tot_amt;
                }
                //전표 생성에 필요한 기본 정보들 세팅
                var total_amt = sum;
                var suppamt = Math.round(total_amt / 1.1);
                var vat = total_amt - suppamt;
                var strvat = new String(vat);
                var today = new Date();
                var year = today.getFullYear();
                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                var dateString = year + '/' + month  + '/' + day;
                var hours = ('0' + today.getHours()).slice(-2); 
                var minutes = ('0' + today.getMinutes()).slice(-2);
                var seconds = ('0' + today.getSeconds()).slice(-2); 
                var timeString = hours + ':' + minutes  + ':' + seconds;
                //전표 만들기 작업 시작
                var message = "";
                //현재 페이지의 포스 상태가(me.apv_yn) 승인이 필요한 포스이면(자사POS)
                if(me.apv_yn == "Y"){
                    //현재 판매전표 헤더의 상태가 '완료' 혹은 '반품' 상태이면(재발행 버튼을 클릭 한 것이라면)
                    if(me.pageObj.mst.getVal("cd_stat") == "Y" || me.pageObj.mst.getVal("cd_stat") == "C"){
                        //String.fromCharCode(16); //디폴트폰트
                        //String.fromCharCode(17); //굵게 (강조)
                        //String.fromCharCode(18); //더블사이즈 (Height)
                        //String.fromCharCode(19); //더블사이즈( width)
                        //String.fromCharCode(20); //연한 밑줄
                        //String.fromCharCode(21); //진한 밑줄 
                        //String.fromCharCode(22); //이미지 출력(0x16)
                        //String.fromCharCode(23); //BarCode 출력(0x17)
                        //String.fromCharCode(24); //더블사이즈(Height, width)
                        vaYYMMDDHHMMSS = setYYMMDDHHMMSS();
                        message += "L_PPRINT";  //api를 이용한 전표 출력
                        message += " * [  재    발    행    영    수    증  ] *";
                        message += String.fromCharCode(16);
                        message += "============================================";
                        message += String.fromCharCode(16);
                        //현재 판매전표 헤더의 상태가 '반품'이면
                        if(me.pageObj.mst.getVal("cd_stat")=="C") {
                            message += "===========================================";        		    
                            message += String.fromCharCode(16); //디폴트폰트
                            message += " * [     반    품    영    수    증     ] *";
                            message += String.fromCharCode(16); //디폴트폰트
                            message += "===========================================";        		    
                            message += String.fromCharCode(16); //디폴트폰트
                        }
                        message += "LF네트웍스_" + shoplist.shop_nm + "점";
                        message += String.fromCharCode(16); //디폴트폰트
                        message += shoplist.biz_no + " Tel : "+ shoplist.telno + " " + shoplist.mngr_nm;
                        message += String.fromCharCode(16); //디폴트폰트
                        message += shoplist.addr_1;
                        message += String.fromCharCode(16);
                        message += "* 저희매장을 찾아주셔서 감사합니다 *";
                        message += String.fromCharCode(16);
                        message += shoplist.addr_2;
                        message += String.fromCharCode(16);
                        message += "[일시] :" + sale_dt.slice(0,4) + "/" + sale_dt.slice(4,6) + "/" + sale_dt.slice(6,8) + " " + "[POS: " + me.pos_no + "-" + mst.sale_seq + "]";
                        message += String.fromCharCode(16);
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        //현재 상품목록에 있는 정보의 개수 만큼 전표에 입력
                        for(i=0;i<itemlist.length;i++){
                            var goods_cd = itemlist[i].goods_cd;
                            var ac_so_price = Number(itemlist[i].ac_so_price);
                            var so_qty = itemlist[i].so_qty;
                            if(itemlist[i].rtn_yn == 'Y'){
                                var sale_amt = Number(so_qty*ac_so_price*-1);    
                            }else{
                                var sale_amt = Number(so_qty*ac_so_price);    
                            }
                            if(itemlist[i].cd_stat_promo == 'Y'){
                                message += "[프로모션]" + goods_cd;
                            }else if(itemlist[i].pre_order_yn == 'Y'){
                                message += "[예약판매]" + goods_cd;
                            }else{
                                message += goods_cd;
                            }
                            message += String.fromCharCode(16);
                            message += rpad(format(ac_so_price),15," ") + lpad(so_qty,7," ")+"개" + lpad(format(sale_amt),17," ");
                            message += String.fromCharCode(16);
                        };
                        message += String.fromCharCode(16);
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += "    상품명 앞 *표시가 되어 있는 품목은 ";
                        message += String.fromCharCode(16);
                        message += "        부가세 면세 품목입니다. ";
                        message += String.fromCharCode(16);
                        message += "-------------------------------------------";
                        message += String.fromCharCode(16);
                        message += lpad("과세금액",27," ") + lpad(format(suppamt),10," ");
                        message += String.fromCharCode(16);
                        message += lpad("부 가 세",28," ") + lpad(format(strvat),10," ");
                        message += String.fromCharCode(16);
                        message += "-------------------------------------------";
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        //현재 승인결과에 있는 정보의 개수만큼 전표에 입력
                        
                        for(i=0;i<apvRst.length;i++){
                            if(apvRst[i].tot_amt != '0'){
                                var rcv_msg = JSON.parse(apvRst[i].rcv_msg);
                                var TR_TYPE_CD = rcv_msg.TR_TYPE_CD;
                                var INSTALLMENT = rcv_msg.INSTALLMENT;
                                if(rcv_msg.INSTALLMENT == '00'){
                                    rcv_msg.INSTALLMENT = "일시불";
                                }
                                //신용카드 승인 건 이면
                                if(TR_TYPE_CD == "D1"){
                                    message += "             신용카드 매출전표          ";
                                    message += String.fromCharCode(16);
                                    message += "            ===================";
                                    message += String.fromCharCode(16);
                                    message += "[카드번호] " + rcv_msg.CARDNO + "**********";
                                    message += String.fromCharCode(16);
                                    message += "[할부개월] " + rcv_msg.INSTALLMENT;
                                    message += String.fromCharCode(16);
                                    message += "[카 드 명] " + rcv_msg.ISSUER_NM;
                                    message += String.fromCharCode(16);
                                    message += "[승인번호] " + rcv_msg.APPROVALNO;
                                    message += String.fromCharCode(16);
                                    message += "[매입사명] " + rcv_msg.ACQUIRE_NM;
                                    message += String.fromCharCode(16);
                                    message += "[가맹번호] " + rcv_msg.STORE_NO;
                                    message += String.fromCharCode(16);
                                    message += "[결제금액] " + format(rcv_msg.TOT_AMT);  
                                    message += String.fromCharCode(16);
                                    message += String.fromCharCode(16);
                                //현금 결제 건 이면
                                }else if(TR_TYPE_CD == "CC"){
                                    message += "             현금승인 매출전표          ";
                                    message += String.fromCharCode(16);
                                    message += "            ===================";
                                    message += String.fromCharCode(16);
                                    message += "[등록번호] " + rcv_msg.CARDNO + "**********";
                                    message += String.fromCharCode(16);
                                    message += "[승인번호] " + rcv_msg.APPROVALNO;
                                    message += String.fromCharCode(16);
                                    message += "[결제금액] " + format(rcv_msg.TOT_AMT);  
                                    message += String.fromCharCode(16);
                                    message += String.fromCharCode(16);
                                //신용카드 취소 건 이면
                                }else if(TR_TYPE_CD == "D2"){
                                    message += "             신용카드 취소전표          ";
                                    message += String.fromCharCode(16);
                                    message += "            ===================";
                                    message += String.fromCharCode(16);
                                    message += "[카드번호] " + rcv_msg.CARDNO + "**********";
                                    message += String.fromCharCode(16);
                                    message += "[할부개월] " + rcv_msg.INSTALLMENT;
                                    message += String.fromCharCode(16);
                                    message += "[카 드 명] " + rcv_msg.ISSUER_NM;
                                    message += String.fromCharCode(16);
                                    message += "[승인번호] " + rcv_msg.APPROVALNO;
                                    message += String.fromCharCode(16);
                                    message += "[매입사명] " + rcv_msg.ACQUIRE_NM;
                                    message += String.fromCharCode(16);
                                    message += "[가맹번호] " + rcv_msg.STORE_NO;
                                    message += String.fromCharCode(16);
                                    message += "[반품금액] " + format("-" + rcv_msg.TOT_AMT);
                                    message += String.fromCharCode(16);
                                    message += String.fromCharCode(16);
                                //현금 취소 건 이면
                                }else if(TR_TYPE_CD == "CR"){
                                    message += "             현금승인 취소전표          ";
                                    message += String.fromCharCode(16);
                                    message += "            ===================";
                                    message += String.fromCharCode(16);
                                    message += "[등록번호] " + rcv_msg.CARDNO + "**********";
                                    message += String.fromCharCode(16);
                                    message += "[승인번호] " + rcv_msg.APPROVALNO;
                                    message += String.fromCharCode(16);
                                    message += "[반품금액] " + format("-" + rcv_msg.TOT_AMT);
                                    message += String.fromCharCode(16);
                                    message += String.fromCharCode(16);
                                }    
                            }else{
                                message += "            결제 전표          ";
                                message += String.fromCharCode(16);
                                message += "            ===================";
                                message += String.fromCharCode(16);
                                message += "[결제금액] " + format("-" + apvRst[i].tot_amt);
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                            }
                            
                        }
                          
                        //현재 판매전표 헤더 상태가 '완료' 이면 
                        if(me.pageObj.mst.getVal("cd_stat")=="Y") {
                        
                            message += rpad("총      액",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("합      계",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("받  은  돈",22," ");
                            message += lpad(format(total_amt),16," ");
                            
                        
                        //현재 판매전표 헤더 상태가 '반품'이면
                        } else if(me.pageObj.mst.getVal("cd_stat")=="C") {
    
                            message += rpad("총      액",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("합      계",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("반품  금액",22," ");
                            message += lpad(format(total_amt),15," ");
                            
                        }
                        
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        // if(!isNull(mst.pre_order_yn)){
                        //     message += "===========================================";
                        //     message += String.fromCharCode(16);
                        //     message += "               고객과의 약속               ";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "매장연락처 : " + shoplist.telno;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "담당자 : " + shoplist.mngr_nm;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "주문번호 : " + mst.so_no;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     for(i=0;i<itemlist.length;i++){
                        //         if(itemlist[i].pre_order_yn == 'Y'){
                        //             message += "상품 : "+ itemlist[i].goods_cd;
                        //         }
                        //     }
                        //     message += "상품 : "+ itemlist[i].goods_cd;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "고객명 : " + mst.nm;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "연락처 : " + mst.phone;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "**예약 상품 도착 시 연락드리겠습니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        // }
                        for(i=0;i<itemlist.length;i++){
                            if(itemlist[i].cd_stat_promo == 'Y'){
                                message += "***프로모션 상품은 반품/교환 절대 불가합니다.***";
                                break;
                            }
                            else if(itemlist[i].pre_order_yn == 'Y'){
                                message += "===========================================";
                                message += String.fromCharCode(16);
                                message += "               고객과의 약속               ";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "매장연락처 : " + shoplist.telno;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "담당자 : " + shoplist.mngr_nm;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "주문번호 : " + mst.so_no;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                for(k=0;k<itemlist.length;k++){
                                    message += "상품 : "+ itemlist[k].goods_cd;
                                }
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "고객명 : " + mst.nm;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "연락처 : " + mst.phone;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "**예약 상품 도착 시 연락드리겠습니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                break;
                            }
                        };
                        if(!isNull(shoplist.receipt)){
                            message += shoplist.receipt;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt2)){
                            message += shoplist.receipt2;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt3)){
                            message += shoplist.receipt3;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt4)){
                            message += shoplist.receipt4;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt5)){
                            message += shoplist.receipt5;
                            message += String.fromCharCode(16);
                        }
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += mst.so_no + " " + year + month + day;
                        message += String.fromCharCode(23); //바코드출력
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                
                        request_msg = message;
                        document.getElementById("taRequest").value = request_msg;
                        console.log(request_msg)
                        gParam.sndMsg = request_msg;
                        var pageTxn = window.open('./apps/fo_pos/registerSO_tx.html?20221024','print1',
		                'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                        gParam.fnCallback = function(data) {
                            me.fnNew();
                        }
                    }else{
                        gfnAlert("오류","영수증 출력 실패");
                    }
                }else{
                    vaYYMMDDHHMMSS = setYYMMDDHHMMSS();
                    message += "L_PPRINT";  //api를 이용한 전표 출력
                    
                    if(me.pageObj.mst.getVal("cd_stat")=="C") {
                        message += "===========================================";        		    
                        message += String.fromCharCode(16); //디폴트폰트
                        message += " * [     반    품    영    수    증     ] *";
                        message += String.fromCharCode(16); //디폴트폰트
                        message += "===========================================";        		    
                        message += String.fromCharCode(16); //디폴트폰트
                    }
                    message += "LF네트웍스_" + shoplist.shop_nm + "점";
                    message += String.fromCharCode(16); //디폴트폰트
                    message += shoplist.biz_no + " Tel : "+ shoplist.telno + " " + shoplist.mngr_nm;
                    message += String.fromCharCode(16); //디폴트폰트
                    message += shoplist.addr_1;
                    message += String.fromCharCode(16);
                    message += "* 저희매장을 찾아주셔서 감사합니다 *";
                    message += String.fromCharCode(16);
                    message += shoplist.addr_2;
                    message += String.fromCharCode(16);
                    message += "[일시] :" + dateString + " " + timeString + " " + "[POS: " + me.pos_no + "-" + mst.sale_seq + "]";
                    message += String.fromCharCode(16);
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    for(i=0;i<itemlist.length;i++){
                        var goods_cd = itemlist[i].goods_cd;
                        var ac_so_price = Number(itemlist[i].ac_so_price);
                        var so_qty = itemlist[i].so_qty;
                        if(itemlist[i].rtn_yn == 'Y'){
                            var sale_amt = Number(so_qty*ac_so_price*-1);
                        }else{
                            var sale_amt = Number(so_qty*ac_so_price);
                        }
                        if(itemlist[i].cd_stat_promo == 'Y'){
                            message += "[프로모션]" + goods_cd;
                        }else if(itemlist[i].pre_order_yn == 'Y'){
                            message += "[예약판매]" + goods_cd;
                        }else{
                            message += goods_cd;
                        }
                        message += String.fromCharCode(16);
                        message += rpad(format(ac_so_price),15," ") + lpad(so_qty,7," ")+"개" + lpad(format(sale_amt),17," ");
                        message += String.fromCharCode(16);
                    };
                    message += String.fromCharCode(16);
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += "    상품명 앞 *표시가 되어 있는 품목은 ";
                    message += String.fromCharCode(16);
                    message += "        부가세 면세 품목입니다. ";
                    message += String.fromCharCode(16);
                    message += "-------------------------------------------";
                    message += String.fromCharCode(16);
                    message += lpad("과세금액",27," ") + lpad(format(suppamt),10," ");
                    message += String.fromCharCode(16);
                    message += lpad("부 가 세",28," ") + lpad(format(strvat),10," ");
                    message += String.fromCharCode(16);
                    message += "-------------------------------------------";
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    if(me.pageObj.mst.getVal("cd_stat") == 'N' || me.pageObj.mst.getVal("cd_stat") == 'Y'){
                        message += rpad("총      액",23," ");
                        message += lpad(format(total_amt),16," ");
                        message += String.fromCharCode(16);
                        message += rpad("합      계",23," ");
                        message += lpad(format(total_amt),16," ");
                        message += String.fromCharCode(16);
                        message += rpad("받  은  돈",23," ");
                        message += lpad(format(total_amt),15," ");
                        message += String.fromCharCode(16);
                    }
                    if(me.pageObj.mst.getVal("cd_stat")=="C") {

                        message += rpad("총      액",23," ");
                        message += lpad(format(total_amt),16," ");
                        message += String.fromCharCode(16);
                        message += rpad("합      계",23," ");
                        message += lpad(format(total_amt),16," ");
                        message += String.fromCharCode(16);
                        message += rpad("반품  금액",23," ");
                        message += lpad(format(total_amt),14," ");
                        
                    }
                   
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    // if(!isNull(mst.pre_order_yn)){
                    //     message += "===========================================";
                    //     message += String.fromCharCode(16);
                    //     message += "               고객과의 약속               ";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "매장연락처 : " + shoplist.telno;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "담당자 : " + shoplist.mngr_nm;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "주문번호 : " + mst.so_no;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     for(i=0;i<itemlist.length;i++){
                    //         if(itemlist[i].pre_order_yn == 'Y'){
                    //             message += "상품 : "+ itemlist[i].goods_cd;
                    //         }
                    //     }
                    //     message += "상품 : "+ itemlist[i].goods_cd;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "고객명 : " + mst.nm;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "연락처 : " + mst.phone;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "**예약 상품 도착 시 연락드리겠습니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    // }
                    for(i=0;i<itemlist.length;i++){
                        if(itemlist[i].cd_stat_promo == 'Y'){
                            message += "***프로모션 상품은 반품/교환 절대 불가합니다.***";
                            break;
                        }
                        else if(itemlist[i].pre_order_yn == 'Y'){
                            message += "===========================================";
                            message += String.fromCharCode(16);
                            message += "               고객과의 약속               ";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "매장연락처 : " + shoplist.telno;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "담당자 : " + shoplist.mngr_nm;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "주문번호 : " + mst.so_no;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            for(k=0;k<itemlist.length;k++){
                                    message += "상품 : "+ itemlist[k].goods_cd;
                                }
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "고객명 : " + mst.nm;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "연락처 : " + mst.phone;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "**예약 상품 도착 시 연락드리겠습니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            break;
                        }
                    };
                    if(!isNull(shoplist.receipt)){
                        message += shoplist.receipt;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt2)){
                        message += shoplist.receipt2;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt3)){
                        message += shoplist.receipt3;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt4)){
                        message += shoplist.receipt4;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt5)){
                        message += shoplist.receipt5;
                        message += String.fromCharCode(16);
                    }
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += mst.so_no + " " + year + month + day;
                    message += String.fromCharCode(23); //바코드출력
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
        
                    request_msg = message;
                    console.log(request_msg)
                    document.getElementById("taRequest").value = request_msg;
                    gParam.sndMsg = request_msg;
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx.html?20221024','print2',
		            'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                    gParam.fnCallback = function(data) {
                        me.fnNew();
                    };
                }
                
        
            } else {
                gfnAlert("오류",OUTVAR.rtnMsg);
            }
        });

    }
    //승인 및 반품 진행 시 영수증 출력
    me.fnPrint2 = function(){
        console.log("me.print2");
        if( !me.pageObj["mst"].chkValid() ) return;
        // if( me.apv_yn!="Y") {
        //     gfnAlert("영수증 (재)발행 확인","무승인 판매등록 건은 영수증을 발행할 수 없습니다.");
        //     return;
        // }
        // if( me.pageObj.mst.getVal("cd_stat")!="Y" && me.pageObj.mst.getVal("cd_stat")!="C" && me.apv_yn == "Y") {
        //     gfnAlert("영수증 (재)발행 확인","판매전표의 상태가 승인 또는 반품이 아닙니다.");
        //     return;
        // }
        // if( me.pageObj.apvRst.countRow() <= 0 && me.apv_yn == "Y") {
        //     gfnAlert("영수증 (재)발행 확인","승인내역이 존재하지 않아 영수증을 발행할 수 없습니다.");
        //     return;
        // } 
        // if( isNull(me.pageObj.apvRst.getVal("0","rcv_msg")) && me.apv_yn == "Y") {
        //     gfnAlert("영수증 (재)발행 확인","임의 등록된 판매영수증은 발행기능은 준비중입니다. IT팀 문의바랍니다.");
        //     return;
        // }
        var args = me.pageObj["mst"].exportData()[0];
        args.shopcd = me.deptcd;
        var invar = JSON.stringify(args);
        
        gfnTx(appid+"."+pgmid,"print",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK") {
                var mst = args;
                var sale_dt = mst.sale_dt;
                var shoplist = OUTVAR.list[0]; //매장정보 및 매장경영인 이름 리스트
                var itemlist = me.pageObj.itemlist.exportData(); // 상품코드, 판매수량, 판매가격, 판매액 리스트
                var apvRst = me.pageObj.apvRst.exportData(); // 
                var paylist = me.pageObj.paylist.exportData();
                //상품목록에 있는 갯수만큼 sale_amt 값을 더해 총 합계 금액 계산
                var sum = 0;
                for(i=0;i<itemlist.length;i++){
                    var tot_amt = new Number(itemlist[i].sale_amt);
                    console.log(tot_amt)
                    sum = sum + tot_amt;
                }
                console.log(sum)
                console.log(itemlist)
                //전표 생성에 필요한 기본 정보들 세팅
                var total_amt = sum;
                console.log(total_amt);
                var suppamt = Math.round(total_amt / 1.1);
                console.log(suppamt)
                var vat = total_amt - suppamt;
                console.log(vat)
                var strvat = new String(vat);
                console.log(strvat)
                var today = new Date();
                var year = today.getFullYear();
                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                var dateString = year + '/' + month  + '/' + day;
                var hours = ('0' + today.getHours()).slice(-2); 
                var minutes = ('0' + today.getMinutes()).slice(-2);
                var seconds = ('0' + today.getSeconds()).slice(-2); 
                var timeString = hours + ':' + minutes  + ':' + seconds;
                //전표 만들기 작업 시작
                var message = "";
                //현재 페이지의 포스 상태가(me.apv_yn) 승인이 필요한 포스이면(자사POS)
                if(me.apv_yn == "Y"){
                    
                     //현재 판매전표가 '임시' 상태이면(고객님께 결제 / 반품 진행 상황이라면)
                    if(me.pageObj.mst.getVal("cd_stat") == "N" || me.pageObj.mst.getVal("cd_stat") == "C"){
                        //String.fromCharCode(16); //디폴트폰트
                        //String.fromCharCode(17); //굵게 (강조)
                        //String.fromCharCode(18); //더블사이즈 (Height)
                        //String.fromCharCode(19); //더블사이즈( width)
                        //String.fromCharCode(20); //연한 밑줄
                        //String.fromCharCode(21); //진한 밑줄 
                        //String.fromCharCode(22); //이미지 출력(0x16)
                        //String.fromCharCode(23); //BarCode 출력(0x17)
                        //String.fromCharCode(24); //더블사이즈(Height, width)
                        vaYYMMDDHHMMSS = setYYMMDDHHMMSS();
                        message += "L_PPRINT";  //api를 이용한 전표 출력
                        
                         if(me.pageObj.mst.getVal("cd_stat")=="C") {
                            message += "===========================================";        		    
                            message += String.fromCharCode(16); //디폴트폰트
                            message += " * [     반    품    영    수    증     ] *";
                            message += String.fromCharCode(16); //디폴트폰트
                            message += "===========================================";        		    
                            message += String.fromCharCode(16); //디폴트폰트
                        }
                        console.log(message);
                        message += "LF네트웍스_" + shoplist.shop_nm + "점";
                        message += String.fromCharCode(16); //디폴트폰트
                        message += shoplist.biz_no + " Tel : "+ shoplist.telno + " " + shoplist.mngr_nm;
                        message += String.fromCharCode(16); //디폴트폰트
                        message += shoplist.addr_1;
                        message += String.fromCharCode(16);
                        message += "* 저희매장을 찾아주셔서 감사합니다 *";
                        message += String.fromCharCode(16);
                        message += shoplist.addr_2;
                        message += String.fromCharCode(16);
                        message += "[일시] :" + sale_dt.slice(0,4) + "/" + sale_dt.slice(4,6) + "/" + sale_dt.slice(6,8) + " " + "[POS: " + me.pos_no + "-" + mst.sale_seq + "]";
                        message += String.fromCharCode(16);
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        //현재 상품목록에 있는 정보의 개수 만큼 전표에 입력
                        for(i=0;i<itemlist.length;i++){
                            var goods_cd = itemlist[i].goods_cd;
                            var ac_so_price = Number(itemlist[i].ac_so_price);
                            var so_qty = itemlist[i].so_qty;
                            if(itemlist[i].rtn_yn == 'Y'){
                                var sale_amt = Number(ac_so_price*so_qty*-1);    
                            }else{
                                var sale_amt = Number(ac_so_price*so_qty);
                            }
                            if(itemlist[i].cd_stat_promo == 'Y'){
                                message += "[프로모션]" + goods_cd;
                            }else if(itemlist[i].pre_order_yn == 'Y'){
                                message += "[예약판매]" + goods_cd;
                            }else{
                                message += goods_cd;
                            }
                            message += String.fromCharCode(16);
                            message += rpad(format(ac_so_price),15," ") + lpad(so_qty,7," ")+"개" + lpad(format(sale_amt),17," ");
                            message += String.fromCharCode(16);
                        };
                        message += String.fromCharCode(16);
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += "    상품명 앞 *표시가 되어 있는 품목은 ";
                        message += String.fromCharCode(16);
                        message += "        부가세 면세 품목입니다. ";
                        message += String.fromCharCode(16);
                        message += "-------------------------------------------";
                        message += String.fromCharCode(16);
                        message += lpad("과세금액",27," ") + lpad(format(suppamt),10," ");
                        message += String.fromCharCode(16);
                        message += lpad("부 가 세",28," ") + lpad(format(strvat),10," ");
                        message += String.fromCharCode(16);
                        message += "-------------------------------------------";
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        //현재 승인결과에 있는 정보의 개수만큼 전표에 입력
                        for(i=0;i<apvRst.length;i++){
                            var rcv_msg = JSON.parse(apvRst[i].rcv_msg);
                            var TR_TYPE_CD = rcv_msg.TR_TYPE_CD;
                            var INSTALLMENT = rcv_msg.INSTALLMENT;
                            if(rcv_msg.INSTALLMENT == '00'){
                                rcv_msg.INSTALLMENT = "일시불";
                            }
                            //신용카드 결제 건 이면
                            if(TR_TYPE_CD == "D1"){
                                message += "             신용카드 매출전표          ";
                                message += String.fromCharCode(16);
                                message += "            ===================";
                                message += String.fromCharCode(16);
                                message += "[카드번호] " + rcv_msg.CARDNO + "**********";
                                message += String.fromCharCode(16);
                                message += "[할부개월] " + rcv_msg.INSTALLMENT;
                                message += String.fromCharCode(16);
                                message += "[카 드 명] " + rcv_msg.ISSUER_NM;
                                message += String.fromCharCode(16);
                                message += "[승인번호] " + rcv_msg.APPROVALNO;
                                message += String.fromCharCode(16);
                                message += "[매입사명] " + rcv_msg.ACQUIRE_NM;
                                message += String.fromCharCode(16);
                                message += "[가맹번호] " + rcv_msg.STORE_NO;
                                message += String.fromCharCode(16);
                                message += "[결제금액] " + format(rcv_msg.TOT_AMT);  
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                            //현금 결제 건 이면
                            }else if(TR_TYPE_CD == "CC"){
                                message += "             현금승인 매출전표          ";
                                message += String.fromCharCode(16);
                                message += "            ===================";
                                message += String.fromCharCode(16);
                                message += "[등록번호] " + rcv_msg.CARDNO + "**********";
                                message += String.fromCharCode(16);
                                message += "[승인번호] " + rcv_msg.APPROVALNO;
                                message += String.fromCharCode(16);
                                message += "[결제금액] " + format(rcv_msg.TOT_AMT);  
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                            //신용카드 취소 건 이면
                            }else if(TR_TYPE_CD == "D2"){
                                message += "             신용카드 취소전표          ";
                                message += String.fromCharCode(16);
                                message += "            ===================";
                                message += String.fromCharCode(16);
                                message += "[카드번호] " + rcv_msg.CARDNO + "**********";
                                message += String.fromCharCode(16);
                                message += "[할부개월] " + rcv_msg.INSTALLMENT;
                                message += String.fromCharCode(16);
                                message += "[카 드 명] " + rcv_msg.ISSUER_NM;
                                message += String.fromCharCode(16);
                                message += "[승인번호] " + rcv_msg.APPROVALNO;
                                message += String.fromCharCode(16);
                                message += "[매입사명] " + rcv_msg.ACQUIRE_NM;
                                message += String.fromCharCode(16);
                                message += "[가맹번호] " + rcv_msg.STORE_NO;
                                message += String.fromCharCode(16);
                                message += "[반품금액] " + format("-" + rcv_msg.TOT_AMT);
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                            //현금 취소 건 이면
                            }else if(TR_TYPE_CD == "CR"){
                                message += "             현금승인 취소전표          ";
                                message += String.fromCharCode(16);
                                message += "            ===================";
                                message += String.fromCharCode(16);
                                message += "[등록번호] " + rcv_msg.CARDNO + "**********";
                                message += String.fromCharCode(16);
                                message += "[승인번호] " + rcv_msg.APPROVALNO;
                                message += String.fromCharCode(16);
                                message += "[반품금액] " + format("-" + rcv_msg.TOT_AMT);
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                            }
                        }
                          
                        //고객님께 결제승인을 받는 경우이면 
                        if(me.pageObj.mst.getVal("cd_stat")=="N") {
                        
                            message += rpad("총      액",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("합      계",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("받  은  돈",22," ");
                            message += lpad(format(total_amt),16," ");
                            
                        
                        //고객님께 반품을 해드리는 경우이면 
                        } else if(me.pageObj.mst.getVal("cd_stat")=="C") {
    
                            message += rpad("총      액",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("합      계",23," ");
                            message += lpad(format(total_amt),16," ");
                            message += String.fromCharCode(16);
                            message += rpad("반품  금액",22," ");
                            message += lpad(format(total_amt),15," ");
                            
                        }
                        
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                        // if(!isNull(mst.pre_order_yn)){
                        //     message += "===========================================";
                        //     message += String.fromCharCode(16);
                        //     message += "               고객과의 약속               ";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "매장연락처 : " + shoplist.telno;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "담당자 : " + shoplist.mngr_nm;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "주문번호 : " + mst.so_no;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     for(i=0;i<itemlist.length;i++){
                        //         if(itemlist[i].pre_order_yn == 'Y'){
                        //             message += "상품 : "+ itemlist[i].goods_cd;
                        //         }
                        //     }
                        //     message += "상품 : "+ itemlist[i].goods_cd;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "고객명 : " + mst.nm;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "연락처 : " + mst.phone;
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "**예약 상품 도착 시 연락드리겠습니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        //     message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                        //     message += String.fromCharCode(16);
                        //     message += String.fromCharCode(16);
                        // }
                        for(i=0;i<itemlist.length;i++){
                            if(itemlist[i].cd_stat_promo == 'Y'){
                                message += "***프로모션 상품은 반품/교환 절대 불가합니다.***";
                                break;
                            }
                            else if(itemlist[i].pre_order_yn == 'Y'){
                                message += "===========================================";
                                message += String.fromCharCode(16);
                                message += "               고객과의 약속               ";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "매장연락처 : " + shoplist.telno;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "담당자 : " + shoplist.mngr_nm;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "주문번호 : " + mst.so_no;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                for(k=0;k<itemlist.length;k++){
                                    message += "상품 : "+ itemlist[k].goods_cd;
                                }
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "고객명 : " + mst.nm;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "연락처 : " + mst.phone;
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "**예약 상품 도착 시 연락드리겠습니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                                message += String.fromCharCode(16);
                                message += String.fromCharCode(16);
                                break;
                            }
                        };
                        if(!isNull(shoplist.receipt)){
                            message += shoplist.receipt;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt2)){
                            message += shoplist.receipt2;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt3)){
                            message += shoplist.receipt3;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt4)){
                            message += shoplist.receipt4;
                            message += String.fromCharCode(16);
                        }
                        if(!isNull(shoplist.receipt5)){
                            message += shoplist.receipt5;
                            message += String.fromCharCode(16);
                        }
                        message += "===========================================";
                        message += String.fromCharCode(16);
                        message += mst.so_no + " " + year + month + day;
                        message += String.fromCharCode(23); //바코드출력
                        message += String.fromCharCode(16);
                        message += String.fromCharCode(16);
                
                        request_msg = message;
                        console.log(request_msg)
                        document.getElementById("taRequest").value = request_msg;
                        gParam.sndMsg = request_msg;
                        var pageTxn = window.open('./apps/fo_pos/registerSO_tx2.html?20221024','print3',
		                'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                        gParam.fnCallback = function(data) {
                            if(me.pageObj.mst.getVal("cd_stat")!="C"){
                                me.fnNew();
                            }
                            
                        }
                    }else{
                        gfnAlert("오류","영수증 출력 실패");
                    }
                }else{
                    vaYYMMDDHHMMSS = setYYMMDDHHMMSS();
                    message += "L_PPRINT";  //api를 이용한 전표 출력
                    
                    if(me.pageObj.mst.getVal("cd_stat")=="Y") {
                        message += "===========================================";        		    
                        message += String.fromCharCode(16); //디폴트폰트
                        message += " * [     반    품    영    수    증     ] *";
                        message += String.fromCharCode(16); //디폴트폰트
                        message += "===========================================";        		    
                        message += String.fromCharCode(16); //디폴트폰트
                    }
                    message += "LF네트웍스_" + shoplist.shop_nm + "점";
                    message += String.fromCharCode(16); //디폴트폰트
                    message += shoplist.biz_no + " Tel : "+ shoplist.telno + " " + shoplist.mngr_nm;
                    message += String.fromCharCode(16); //디폴트폰트
                    message += shoplist.addr_1;
                    message += String.fromCharCode(16);
                    message += "* 저희매장을 찾아주셔서 감사합니다 *";
                    message += String.fromCharCode(16);
                    message += shoplist.addr_2;
                    message += String.fromCharCode(16);
                    message += "[일시] :" + dateString + " " + timeString + " " + "[POS: " + me.pos_no + "-" + mst.sale_seq + "]";
                    message += String.fromCharCode(16);
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    for(i=0;i<itemlist.length;i++){
                        var goods_cd = itemlist[i].goods_cd;
                        var ac_so_price = Number(itemlist[i].ac_so_price);
                        var so_qty = itemlist[i].so_qty;
                        if(itemlist[i].rtn_yn == 'Y'){
                            var sale_amt = Number(so_qty*ac_so_price*-1);
                        }else{
                            var sale_amt = Number(so_qty*ac_so_price);
                        }
                        if(itemlist[i].cd_stat_promo == 'Y'){
                            message += "[프로모션]" + goods_cd;
                        }else if(itemlist[i].pre_order_yn == 'Y'){
                            message += "[예약판매]" + goods_cd;
                        }else{
                            message += goods_cd;
                        }
                        message += String.fromCharCode(16);
                        message += rpad(format(ac_so_price),15," ") + lpad(so_qty,7," ")+"개" + lpad(format(sale_amt),17," ");
                        message += String.fromCharCode(16);
                    };
                    message += String.fromCharCode(16);
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += "    상품명 앞 *표시가 되어 있는 품목은 ";
                    message += String.fromCharCode(16);
                    message += "        부가세 면세 품목입니다. ";
                    message += String.fromCharCode(16);
                    message += "-------------------------------------------";
                    message += String.fromCharCode(16);
                    message += lpad("과세금액",27," ") + lpad(format(suppamt),10," ");
                    message += String.fromCharCode(16);
                    message += lpad("부 가 세",28," ") + lpad(format(strvat),10," ");
                    message += String.fromCharCode(16);
                    message += "-------------------------------------------";
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    message += rpad("총      액",23," ");
                    message += lpad(format(total_amt),16," ");
                    message += String.fromCharCode(16);
                    message += rpad("합      계",23," ");
                    message += lpad(0,16," ");
                    message += String.fromCharCode(16);
                    message += rpad("받  은  돈",23," ");
                    message += lpad(format(total_amt),15," ");
                    
                    if(me.pageObj.mst.getVal("cd_stat")=="Y") {

                        message += rpad("총      액",23," ");
                        message += lpad(format(total_amt),16," ");
                        message += String.fromCharCode(16);
                        message += rpad("합      계",23," ");
                        message += lpad(0,16," ");
                        message += String.fromCharCode(16);
                        message += rpad("반품  금액",23," ");
                        message += lpad("- "+format(total_amt),15," ");
                        
                    }
                   
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
                    // if(!isNull(mst.pre_order_yn)){
                    //     message += "===========================================";
                    //     message += String.fromCharCode(16);
                    //     message += "               고객과의 약속               ";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "매장연락처 : " + shoplist.telno;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "담당자 : " + shoplist.mngr_nm;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "주문번호 : " + mst.so_no;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     for(i=0;i<itemlist.length;i++){
                    //         if(itemlist[i].pre_order_yn == 'Y'){
                    //             message += "상품 : "+ itemlist[i].goods_cd;
                    //         }
                    //     }
                    //     message += "상품 : "+ itemlist[i].goods_cd;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "고객명 : " + mst.nm;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "연락처 : " + mst.phone;
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "**예약 상품 도착 시 연락드리겠습니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    //     message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                    //     message += String.fromCharCode(16);
                    //     message += String.fromCharCode(16);
                    // }
                    for(i=0;i<itemlist.length;i++){
                        if(itemlist[i].cd_stat_promo == 'Y'){
                            message += "***프로모션 상품은 반품/교환 절대 불가합니다.***";
                            break;
                        }
                        else if(itemlist[i].pre_order_yn == 'Y'){
                            message += "===========================================";
                            message += String.fromCharCode(16);
                            message += "               고객과의 약속               ";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "매장연락처 : " + shoplist.telno;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "담당자 : " + shoplist.mngr_nm;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "주문번호 : " + mst.so_no;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            for(k=0;k<itemlist.length;k++){
                                message += "상품 : "+ itemlist[k].goods_cd;
                                message += String.fromCharCode(16);
                            }
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "도착 예정일 : 결제일로부터 7일 이내 입니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "고객명 : " + mst.nm;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "연락처 : " + mst.phone;
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "**예약 상품 도착 시 연락드리겠습니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            message += "**수신 후 7일이내 매장 방문 해주시기 바랍니다.";
                            message += String.fromCharCode(16);
                            message += String.fromCharCode(16);
                            break;
                        }
                    };
                    if(!isNull(shoplist.receipt)){
                        message += shoplist.receipt;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt2)){
                        message += shoplist.receipt2;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt3)){
                        message += shoplist.receipt3;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt4)){
                        message += shoplist.receipt4;
                        message += String.fromCharCode(16);
                    }
                    if(!isNull(shoplist.receipt5)){
                        message += shoplist.receipt5;
                        message += String.fromCharCode(16);
                    }
                    message += "===========================================";
                    message += String.fromCharCode(16);
                    message += mst.so_no + " " + year + month + day;
                    message += String.fromCharCode(23); //바코드출력
                    message += String.fromCharCode(16);
                    message += String.fromCharCode(16);
        
                    request_msg = message;
                    document.getElementById("taRequest").value = request_msg;
                    gParam.sndMsg = request_msg;
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx2.html?20221024','print4',
		            'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                    gParam.fnCallback = function(data) {
                        if(me.pageObj.mst.getVal("cd_stat")!="Y"){
                            me.fnNew();
                        }
                    };
                }
            } else {
                gfnAlert("오류",OUTVAR.rtnMsg);
            }
        });

    }

    //카드버튼 클릭 시
    me.fnTx3 = function() {
        // var items = me.pageObj["itemlist"].exportData();
        // for(i=0;i<items.length;i++){
        //     if(items[i].remark == '프로모션 상품' && items[i].cd_stat_promo != 'Y'){
        //         _check();
        //         return;
        //     }
        // }
        // function _check(){
        //     gfnConfirm("프로모션 확인","프로모션 가격이 적용되지 않은 프로모션 제품이 있습니다. 결제하시겠습니까 ?",function(rtn){
        //         if(rtn)if(rtn==true) _card();
        //     });
        // }
        _card();
        function _card(){
           var pay_seq = me.pay_seq + 1;
            var shopcd = me.deptcd;
            var shopcds = {shopcd : shopcd};
            var invar2 = JSON.stringify(shopcds);
            gfnTx(appid+"."+pgmid,"shopsearch",{INVAR:invar2},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    gParam.balance  = toNum( me.page.find("input[name=balance]").val() );
    		        gParam.totalpay = toNum( me.page.find("input[name=totalpay]").val() );
    		        gParam.shoplist = OUTVAR.list;
    		        gParam.itemlist = me.pageObj["itemlist"].exportData();
                    gParam.mstlist = me.pageObj["mst"].exportData()[0];
    		        gParam.so_tp = gfnCdNm("SO_TP",me.so_tp,"nm"); 
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx7.html?20220809','card',
                    'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                    
                    gParam.fnCallback = function(rtn) {
                        if(isNull(rtn) || isNull(rtn.data)){
                            gfnAlert("통신오류","CAT단말기 통신 중 오류가 발생하였습니다. 관리자에게 문의 해 주세요");
                            return;
                        }
                        var res_cd = rtn.data.RES_CD;
                        if(res_cd == '0000'){  
                            //헤더와아이템저장 후 결제저장
                            function _fnSavePay() {  
                    			var list = [];
                    			var send = {"send" : rtn.taRequest}; //요청전문
                    			var receive = {"receive" : rtn.data}; // 응답전문
                    			var mst = me.pageObj["mst"].exportData()[0];
                    			var orgcd = { "orgcd" : me.orgcd};
                    			var shopcd = { "shopcd" : me.deptcd};
                    			var so_tp_val = gfnCdNm("SO_TP",me.so_tp,"nm");
                    			var so_tp = { "so_tp" : so_tp_val } ; 
                    			var pay_seqlist = { "pay_seq" : pay_seq};
                    			list.push(send);
                    			list.push(receive);
                    			list.push(mst);
                    			list.push(orgcd);
                    			list.push(shopcd);
                    			list.push(so_tp);
                    			list.push(pay_seq);
                    			var args = { list : list };
                    			args.approvaltime = date("today","yyyymmddhh24miss");
                    			var invar = JSON.stringify(args);
                    			gfnTx(appid+"."+pgmid,"usdcard",{INVAR:invar},function(OUTVAR){
                                    if(OUTVAR.rtnCd=="OK") {
                                        me.pageObj["paylist"].importData(OUTVAR.list2);
                                        me.pageObj["apvRst"].importData(OUTVAR.list4);
                                        var args2 = me.pageObj["paylist"].exportData();
                                        var sum = 0;
                                        for(var i=0;i<args2.length;i++){
                                            var list = me.pageObj["paylist"].exportData()[i];
                                            var pay_amt = list.pay_amt;
                                            sum = sum + Number(pay_amt);
                                        }
                                        me.page.find("input[name=payment]").val( format(sum) );
                                        me.page.find("input[name=balance").val( format( toNum(me.page.find("input[name=totalpay]").val()) - toNum(me.page.find("input[name=payment]").val()) ) );
        
                                        //잔액이 0이되면 자동저장완료
                                        if( me.page.find("input[name=balance]").val() == '0'){ 
                                            me.fnSaveCfm();
                                        }
                                        
                                    } else {
                                        gfnAlert("오류",OUTVAR.rtnMsg);
                                    }
                                });
                            }
                            //먼저 헤더와 아이템정보 저장하고 callback으로 _fnSavePay를 호출 
                            me.fnSave(_fnSavePay); 
                        }else if(res_cd == "XXX3" || res_cd == "XXX4" || datalist.RES_CD == ""){
                            return;
                        }else{
                            gfnAlert("단말기 통신오류",OUTVAR.rtnMsg);
                            return;
                        }
                        // else{
                        //     $("#totalpaylist").hide();
                        //     $("#btntemporary").show();
                        //     me.pageObj.msgBtnPanel.container.show();
                        //     $("#receive").val(rtn.data);
                        //     $("#send").val(rtn.taRequest);
                        //     //통신오류 발생시 저장하지 않음 => 저장하면 완료 바보상태가 됨
                        //     //저장하지 않으면 재시도 하여 완료처리함 
                        // }
                    };
                } else {
                    gfnAlert("매장정보조회오류",OUTVAR.rtnMsg);
                }
            }); 
        }
        
    }
    // me.btntemporary = function(){
    //     function _fnSavePay() {
    //         var args = {};
    //         var msgBtnPanel = me.pageObj["msgBtnPanel"].exportData();
    //         var mst = me.pageObj["mst"].exportData();
    //         var receive = $("#receive").val();
    //         var send = $("#send").val();
    //         args.msgBtnPanel = msgBtnPanel;
    //         args.mst = mst;
    //         args.receive = receive;
    //         args.send = send;
    //         // gfnTx(appid+"."+pgmid,"failcard",{INVAR:invar},function(OUTVAR){
    //         //     if(OUTVAR.rtnCd=="OK") {
    //         //         me.pageObj["paylist"].importData(OUTVAR.list2);
    //         //         var args2 = me.pageObj["paylist"].exportData();
    //         //         var sum = 0;
    //         //         for(var i=0;i<args2.length;i++){
    //         //             var list = me.pageObj["paylist"].exportData()[i];
    //         //             var pay_amt = list.pay_amt;
    //         //             sum = sum + Number(pay_amt);
    //         //         }

    //         //         // 잔액이 0이되면 자동저장완료
    //         //         // if( me.page.find("input[name=balance]").val() == '0'){ 
    //         //         //     me.fnSaveCfm();
    //         //         // }
                    
    //         //     } else {
    //         //         gfnAlert("오류",OUTVAR.rtnMsg);
    //         //     }
    //         // })
    //     }
    // me.fnSave(_fnSavePay);
    
    // }
    //현금버튼 클릭 시
    me.fnTx4 = function() {
        // var items = me.pageObj["itemlist"].exportData();
        // for(i=0;i<items.length;i++){
        //     if(items[i].remark == '프로모션 상품' && items[i].cd_stat_promo != 'Y'){
        //         _check();
        //         return;
        //     }
        // }
        // function _check(){
        //     gfnConfirm("프로모션 확인","프로모션 가격이 적용되지 않은 프로모션 제품이 있습니다. 결제하시겠습니까 ?",function(rtn){
        //         if(rtn)if(rtn==true) _cash();
        //     });
        // }
        _cash();
        function _cash(){
            var pay_seq = me.pay_seq + 1;
            var shopcd = me.deptcd;
            var shopcds = {shopcd : shopcd};
            var invar2 = JSON.stringify(shopcds);
            gfnTx(appid+"."+pgmid,"shopsearch",{INVAR:invar2},function(OUTVAR){
                if(OUTVAR.rtnCd=="OK") {
                    gParam.shoplist = OUTVAR.list;
    		        gParam.itemlist = me.pageObj["itemlist"].exportData();
                    gParam.mstlist = me.pageObj["mst"].exportData()[0];
    		        gParam.so_tp = gfnCdNm("SO_TP",me.so_tp,"nm"); 
            		gParam.balance  = toNum( me.page.find("input[name=balance]").val() );
            		gParam.totalpay = toNum( me.page.find("input[name=totalpay]").val() );
                    gParam.fnCallback = function(rtn) {
                        if(rtn.data.RES_CD == '0000'){
                            me.logTx("fnTx4", rtn);
                            //헤더와아이템저장 후 결제저장
                            function _fnSavePay() {
                                
                                var card_nm = rtn.data.CARDNO;
                                if(card_nm == "010000") {
                                    card_nm = "현금";
                                }else{
                                    card_nm = "현금영수증";
                                }
                    			var list = [];
                    			var send = {"send" : rtn.taRequest}; //요청전문
                    			var receive = {"receive" : rtn.data}; // 응답전문
                    			var mst = me.pageObj["mst"].exportData()[0];
                                var orgcd = { "orgcd" : me.orgcd};
                                var shopcd = { "shopcd" : me.deptcd};
                                var so_tp_val = gfnCdNm("SO_TP",me.so_tp,"nm");
                                var so_tp = { "so_tp" : so_tp_val } ;
                    			list.push(send);
                    			list.push(receive);
                    			list.push(mst);
                    			list.push(orgcd);
                    			list.push(shopcd);
                    			list.push(so_tp);
                    			var args = {list:list};
                    			args.approvaltime = date("today","yyyymmddhh24miss");
                    			args.card_nm = card_nm;
                    			var invar = JSON.stringify(args);
                    			gfnTx(appid+"."+pgmid,"usdcash",{INVAR:invar},function(OUTVAR){
                                    if(OUTVAR.rtnCd=="OK") {
                                        me.pageObj["paylist"].importData(OUTVAR.list2);
                                        me.pageObj["apvRst"].importData(OUTVAR.list4);
                                        var args2 = me.pageObj["paylist"].exportData();
                                        var sum = 0;
                                        for(var i=0;i<args2.length;i++){
                                            var paylist = me.pageObj["paylist"].exportData()[i];
                                            var pay_amt = paylist.pay_amt;
                                            sum = sum + Number(pay_amt);
                                        }
                                        me.page.find("input[name=payment]").val( format(sum) );
                                        me.page.find("input[name=balance").val( format( toNum(me.page.find("input[name=totalpay]").val()) - toNum(me.page.find("input[name=payment]").val()) ));
                                        
                                        //잔액이 0이되면 자동저장완료
                                        if( me.page.find("input[name=balance]").val() == '0'){ 
                                            me.fnSaveCfm();
                                        }
                                        
                                    } else {
                                        gfnAlert("오류",OUTVAR.rtnMsg);
                                    }
                                });
                            } 
                            //먼저 헤더와 아이템정보 저장하고 callback으로 _fnSavePay를 호출 
                            me.fnSave(_fnSavePay); 
                        }else{ 
                            //통신오류 발생시 저장하지 않음 => 저장하면 완료 바보상태가 됨
                            //저장하지 않으면 재시도 하여 완료처리함 
                            me.logTx("fnTx4", rtn);
                        }
                        
                    };
                    var pageTxn = window.open('./apps/fo_pos/registerSO_tx8.html?20220809','cash',
                    'directories=no,titlebar=no,toolbar=no, location=no, status=no, menubar=no, scrollbars=no,resizable=no,height=600, left=100, top=50, width=800');
                }else {
                    gfnAlert("매장정보조회오류",OUTVAR.rtnMsg);
                }
            });
        }
        
    } 

    //*************************************************************************//
    //전표상태에 따른 버튼 활성화
    me.fnResetButtons=function() { 
        //상태와 판매유형에 따라 화면표시 제어
        /*          N : 임시저장        Y : 결제완료        C : 반품
        승인필요   상품스캔O            상품스캔X           상품스캔X
                   상품목록버튼O        상품목록버튼X       상품목록버튼X 
                   승인취소O            승인취소X           승인취소X        
                   결제금액버튼O        반품버튼            재승인(1회한)
                   부분취소 보임
                   
        불필요     상품스캔O            상품스캔X           상품스캔X
                   상품목록버튼O        상품목록버튼X       상품목록버튼X 
                   승인취소X            승인취소X           승인취소X        
                   결제금액버튼X        반품버튼            재승인(1회한)
                   부분취소 숨김
        * 결제완료건도 수정을 하려면 반품 후 재승인 처리를 해야함 */
        if(me.pageObj.mst.getVal("so_end_yn")=="Y"||me.pageObj.mst.getVal("cd_stat")=="X") {
            me.page.find(".scanbox").hide();
            me.page.find(".goodssearch").hide();
            me.dataDef._pgm_data.itemlist.content[2].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[4].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[7].attr="hidden";
            var itemlist = me.pageObj.itemlist.exportData();
            me.pageObj.itemlist.reset();
            me.pageObj.itemlist.importData(itemlist);
            me.dataDef._pgm_data.paylist.content[5].attr="hidden";
            me.pageObj.paylist.reset(); 
            me.page.find("#totalpaylist").hide();
            me.page.find("#buttonlist").hide();
            me.page.find("button#btnSave").hide();  
            me.page.find("button#btnTemp").hide();              
            me.page.find("button#btnReturn").hide();            
            me.page.find("button#btnNew").hide(); 
            me.page.find("button#btnReApv").hide();
            me.page.find("button#btnChange2").hide();
            me.page.find("#msgPanel").text("판매완료 승인, 수불반영, 정산완료된 건입니다. 수정할 수 없습니다.");
        } else if(me.pageObj.mst.getVal("cd_stat")=="N"||isNull(me.pageObj.mst.getVal("cd_stat"))) {
            me.page.find(".scanbox").show();
            me.page.find(".goodssearch").show();
            me.dataDef._pgm_data.itemlist.content[2].attr="";
            me.dataDef._pgm_data.itemlist.content[4].attr="";
            me.dataDef._pgm_data.itemlist.content[7].attr="";
            var itemlist = me.pageObj.itemlist.exportData();
            me.pageObj.itemlist.reset();
            me.pageObj.itemlist.importData(itemlist);
            if(me.apv_yn=="Y") {
                me.page.find("#totalpaylist").show();
                me.page.find("#buttonlist").show();
                me.page.find("button#btnSave").hide();
                me.page.find("button#btnTemp").hide();
                me.page.find("#msgPanel").text("");
                me.page.find("#msg").hide();
                me.dataDef._pgm_data.paylist.content[5].attr="";
                me.pageObj.paylist.reset(); 
            } else {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").show(); 
                me.page.find("button#btnTemp").show(); 
                me.page.find("#msg").show();
                me.page.find("#msgPanel").text("상품등록 후 카드승인 없이 [저장]시 판매등록 됩니다.");
                me.dataDef._pgm_data.paylist.content[5].attr="hidden";
                me.pageObj.paylist.reset(); 
            }
            me.page.find("button#btnNew").hide(); 
            me.page.find("button#btnReturn").hide();
            me.page.find("button#btnReApv").hide();
            me.page.find("button#btnChange").hide();
        } else if(me.pageObj.mst.getVal("cd_stat")=="Y") { //완료면 반품버튼
            me.page.find(".scanbox").hide();
            me.page.find(".goodssearch").hide();
            me.dataDef._pgm_data.itemlist.content[2].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[4].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[7].attr="hidden";
            var itemlist = me.pageObj.itemlist.exportData();
            me.pageObj.itemlist.reset();
            me.pageObj.itemlist.importData(itemlist); 
            me.dataDef._pgm_data.paylist.content[5].attr="hidden";
            me.pageObj.paylist.reset(); 
            if(me.apv_yn=="Y") {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").hide(); 
                me.page.find("button#btnTemp").hide();  
                me.page.find("#msgPanel").text("판매내역을 확인하고 [반품]시 카드 승인취소 호출됩니다.");
                me.dataDef._pgm_data.paylist.content[5].attr="";
                me.pageObj.paylist.reset(); 
            } else {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").hide(); 
                me.page.find("button#btnTemp").hide();  
                me.page.find("#msgPanel").text("판매내역을 확인하고 [반품]시 무승인 반품처리 됩니다.");
                me.dataDef._pgm_data.paylist.content[5].attr="hidden"; 
                me.pageObj.paylist.reset(); 
            } 
            me.page.find("button#btnReturn").show();   
            me.page.find("button#btnChange").show();
            me.page.find("button#btnNew").hide(); 
            me.page.find("button#btnReApv").hide(); 
            me.page.find("#msg").show();
            me.page.find("button#btnChange2").hide();
            
        } else if(me.pageObj.mst.getVal("cd_stat")=="C") { //반품이면 재승인 버튼 표시
            me.page.find(".scanbox").hide();
            me.page.find(".goodssearch").hide();
            me.dataDef._pgm_data.itemlist.content[2].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[4].attr="hidden";
            me.dataDef._pgm_data.itemlist.content[7].attr="hidden";
            var itemlist = me.pageObj.itemlist.exportData();
            me.pageObj.itemlist.reset();
            me.pageObj.itemlist.importData(itemlist);
            me.dataDef._pgm_data.paylist.content[5].attr="hidden";
            me.pageObj.paylist.reset(); 
            if(me.apv_yn=="Y") {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").hide(); 
                me.page.find("button#btnTemp").hide();  
                me.dataDef._pgm_data.paylist.content[5].attr="";
                me.pageObj.paylist.reset(); 
            } else {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").hide(); 
                me.page.find("button#btnTemp").hide();  
                me.dataDef._pgm_data.paylist.content[5].attr="hidden";
                me.pageObj.paylist.reset(); 
            }
            me.page.find("#msg").show();
            me.page.find("button#btnReturn").hide();      
            me.page.find("button#btnChange").hide();
            me.page.find("button#btnNew").hide(); 
            me.page.find("button#btnReApv").show();
            me.page.find("button#btnChange2").hide();
            me.page.find("#msgPanel").text("현 반품의 상품정보가 신규 판매전표로 옮겨집니다.(1회한)");
        }else if(!isNull(me.pageObj.mst.getVal("remark"))) {
            me.page.find(".scanbox").show();
            me.page.find(".goodssearch").show();
            me.dataDef._pgm_data.itemlist.content[2].attr="";
            me.dataDef._pgm_data.itemlist.content[4].attr="";
            me.dataDef._pgm_data.itemlist.content[7].attr="";
            var itemlist = me.pageObj.itemlist.exportData();
            me.pageObj.itemlist.reset();
            me.pageObj.itemlist.importData(itemlist);
            if(me.apv_yn=="Y") {
                me.page.find("#totalpaylist").show();
                me.page.find("#buttonlist").show();
                me.page.find("#msgPanel").text("");
                me.page.find("#msg").show();
                me.page.find("button#btnSave").hide();
                me.page.find("button#btnTemp").hide();
                me.page.find("button#btnNew").hide();
                me.page.find("button#btnChange").hide();
                me.dataDef._pgm_data.paylist.content[5].attr="";
                me.pageObj.paylist.reset(); 
            } else {
                me.page.find("#totalpaylist").hide();
                me.page.find("#buttonlist").hide();
                me.page.find("button#btnSave").show(); 
                me.page.find("button#btnTemp").show(); 
                me.page.find("#msg").show();
                me.page.find("#msgPanel").text("상품등록 후 카드승인 없이 [저장]시 판매등록 됩니다.");
                me.dataDef._pgm_data.paylist.content[5].attr="hidden";
                me.pageObj.paylist.reset(); 
            }
            me.page.find("button#btnNew").hide(); 
            me.page.find("button#btnReturn").hide();
            //me.page.find("button#btnReApv").hide();
            me.page.find("button#btnChange").hide();
        }
        me.pageObj.mst.setVal("sale_seq",lpad(me.pageObj.mst.getVal("sale_seq"),4,"0"));
        me.pageObj.msgBtnPanel.container.hide(); 
    }    

    me.logTx=function(from, rtn) {
        try {
            var args = {from:from, rtn:rtn};
            if(!isNull(rtn)) {
                var invar = JSON.stringify(args);
                gfnTx(appid+"."+pgmid,"logTx",{INVAR:invar},function(OUTVAR){
                },true); 
            }
        } catch {
            console.error("logTx Error");
        }      

    }
    me.fnlocal=function(){
        var itemlist = me.pageObj["itemlist"].exportData();
        localStorage.setItem('item',JSON.stringify(itemlist));
    };


/*-- SCRIPT autogen ---------------------------------------------------- */        
if(typeof(me.fnInit)=='function') me.fnInit();
});

</script>