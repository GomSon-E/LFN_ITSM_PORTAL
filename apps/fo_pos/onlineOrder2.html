<style>[pgmid='onlineOrder'].framepage .userClass { 
width:100%; 
}</style>

<!-- HTML autogen start ---------------------------------------------- -->            
<div class="pageNav"></div>
<div class="pageTop"></div>
<div class="pageCond"></div>
<div class="pageGuide"></div>
<div class="pageContent">
    <div id='list' class="flexColumn"></div>
</div>
<script>
function lpad(str, padLen, padStr) {
if (padStr.length > padLen) {
    return str;
}
str += ""; // 문자로
padStr += ""; // 문자로
while (str.length < padLen)
    str = padStr + str;
str = str.length >= padLen ? str.substring(0, padLen) : str;
return str;
}
    
function rpad(str, padLen, padStr) {
    if (padStr.length > padLen) {
        return str + "";
    }
    str += ""; // 문자로
    padStr += ""; // 문자로
    while (str.length < padLen)
        str += padStr;
    str = str.length >= padLen ? str.substring(0, padLen) : str;
    return str;
}    
    
</script>
<!-- HTML autogen end ---------------------------------------------- -->
<script>
/*-- SCRIPT autogen start ---------------------------------------------- */        
$(function() {
    var appid = "fo_pos";
    var pgmid = "onlineOrder2"; 
    var page = $("*[pgmid='"+pgmid+"'].framepage").last();
    var pageid = page.attr("id"); 
    var me = {}
    var dataSet = {};
    var dataDef = {};
    var pageObj = {};
    var bEdit = false;
    me.fnInit = function() {
        gfn[pageid] = me; 
        me.appid    = appid;
        me.pgmid    = pgmid;
        me.pageid   = pageid;
        me.page     = page; 
        me.dataSet = dataSet;
        me.dataDef = dataDef;
        me.pageObj = pageObj;
        me.bEdit = bEdit;
me.dataDef["_pgm"]={"pgmid":"onlineOrder2","pgm_nm":"온라인 주문접수2","pgm_tp":"UX","proc_mst_id":"","proc_mst_nm":"","remark":"스퀘어몰로부터 전송되었거나 수기 입력한 주문내역과 상태를 조회한다.","ver":0.1,"pgm_stat":"Y","reg_usid":"lkh","reg_dt":"2022-04-01 11:24:47","upd_usid":"lkh","upd_dt":"2022-04-01 11:24:47","app_pgmid":"fo_pos","pgm_grp_nm":"온라인","sort_seq":70,"shortcut":"","crud":"","app_pgm_nm":"매장"};
me.dataDef["_pgm_func"]=[{"func_icon":"fas fa-search","reg_dt":"2022-04-01 11:24:47","reg_usid":"","func_nm":"조회","upd_usid":"","upd_dt":"2022-04-01 11:24:47","func_tp":"DB_R","remark":null,"pgmid":"onlineOrder2","sort_seq":"1","funcid":"search","content":"대상자료 조회","crud":"R","id":"0"},{"func_icon":"fas fa-calculator","reg_dt":"2022-04-01 11:24:47","reg_usid":"","func_nm":"자동할당","upd_usid":"","upd_dt":"2022-04-01 11:24:47","func_tp":"DB_W","remark":"[자동할당] 현 재고 기준으로 합포 가능매장 또는 RT가능 매장을 추천합니다.","pgmid":"onlineOrder2","sort_seq":"2","funcid":"calc","content":"현재고 기준으로 온라인점,매장RT자동할당","crud":"U","id":"1"},{"func_icon":"fas fa-save","reg_dt":"2022-04-01 11:24:47","reg_usid":"","func_nm":"주문접수","upd_usid":"","upd_dt":"2022-04-01 11:24:47","func_tp":"DB_W","remark":"[접수구분] 온라인점 출고, 매장RT 수령 후 출고, 오프매장 고객직송을 선택하여 접수할 수 있습니다. 접수시  RT/직송 의뢰정보가 자동생성됩니다.","pgmid":"onlineOrder2","sort_seq":"3","funcid":"save","content":"주문접수","crud":"U","id":"2"}];
me.dataDef["_pgm_data"] = {};
me.dataDef["_pgm_data"]["pageCond"]={"sort_seq":"1","data_id":"pageCond","data_nm":"조회조건","data_icon":null,"component_pgmid":"aweForm","component_option":null,"inout_tp":"IN","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":"주문일자","colid":"dt_from","colnm":"주문일자","dtype":"ymd","etype":"txt","attr":"ymd keycol","defval":"date(\"1st\")","w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":"주문일자","colid":"dt_to","colnm":"주문일자","dtype":"ymd","etype":"txt","attr":"ymd keycol","defval":"date(\"today\")","w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"confirm","colnm":"접수상태","dtype":"text","etype":"sel","attr":null,"defval":"\"false\"","w":null,"h":null,"refcd":"[{\"cd\":\"true\",\"nm\":\"접수완료\"},{\"cd\":\"false\",\"nm\":\"미접수\"}]","option":"all:confirm::nm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"}]};
me.dataDef["_pgm_data"]["list"]={"sort_seq":"2","data_id":"list","data_nm":"주문목록","data_icon":null,"component_pgmid":"agGrid","component_option":{"gridOpt":"rn chk","remark":"* 매장재고 = 전 매장 가용재고 합계 - 안전재고1 "},"inout_tp":"INOUT","content":[{"sort_seq":1,"section":null,"section_icon":null,"colgrp":null,"colid":"confirmed","colnm":"접수상태","dtype":"text","etype":"sel","attr":"readonly ","defval":null,"w":"4","h":null,"refcd":"ONLINE_ACCEPT_YN","option":"sel:confirmed::nm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":null,"section_icon":null,"colgrp":null,"colid":"item_cnt","colnm":"합포건수","dtype":"num","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":"\"\"","remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":null,"section_icon":null,"colgrp":null,"colid":"order_dt","colnm":"주문일","dtype":"ymd","etype":"raw","attr":"rowSpan","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":null,"section_icon":null,"colgrp":null,"colid":"market_idx","colnm":"주문번호","dtype":"text","etype":"raw","attr":"rowSpan","defval":null,"w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":"count('market_idx')+\"건\"","remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":null,"section_icon":null,"colgrp":null,"colid":"basket_idx","colnm":"항번","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"7","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":null,"section_icon":null,"colgrp":null,"colid":"goods_cd","colnm":"상품코드","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"15","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":7,"section":null,"section_icon":null,"colgrp":null,"colid":"ea","colnm":"수량","dtype":"num","etype":"raw","attr":"keycol","defval":null,"w":"3","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"},{"sort_seq":8,"section":null,"section_icon":null,"colgrp":null,"colid":"price","colnm":"판매가","dtype":"num","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"7"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"sale_amt","colnm":"판매금액","dtype":"num","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"8"},{"sort_seq":10,"section":null,"section_icon":null,"colgrp":null,"colid":"customer_req","colnm":"고객 요청사항","dtype":"text","etype":"raw","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"9"},{"sort_seq":11,"section":null,"section_icon":null,"colgrp":null,"colid":"stk_qty","colnm":"온라인 재고","dtype":"num","etype":"raw","attr":"disabled","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"10"},{"sort_seq":12,"section":null,"section_icon":null,"colgrp":null,"colid":"stk_qty_shop","colnm":"매장 재고","dtype":"num","etype":"raw","attr":"disabled","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"11"},{"sort_seq":13,"section":null,"section_icon":null,"colgrp":null,"colid":"checkStk","colnm":"재고확인","dtype":"text","etype":"btn","attr":null,"defval":null,"w":"6","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"12"},{"sort_seq":14,"section":null,"section_icon":null,"colgrp":null,"colid":"mov_yn","colnm":"접수구분","dtype":"text","etype":"sel","attr":"keycol","defval":null,"w":null,"h":null,"refcd":"ONLINE_SO_MOV_YN","option":"sel:mov_yn::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"13"},{"sort_seq":15,"section":null,"section_icon":null,"colgrp":null,"colid":"rt_shopcd","colnm":"RT의뢰매장","dtype":"text","etype":"sel","attr":null,"defval":null,"w":null,"h":null,"refcd":"SHOPCD","option":"sel:rt_shopcd::cdnm","len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"14"},{"sort_seq":16,"section":null,"section_icon":null,"colgrp":null,"colid":"remark","colnm":"메모","dtype":"text","etype":"txt","attr":null,"defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"15"},{"sort_seq":17,"section":null,"section_icon":null,"colgrp":null,"colid":"rotate_no","colnm":"RT의뢰번호","dtype":"text","etype":"raw","attr":"disabled","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"16"},{"sort_seq":18,"section":null,"section_icon":null,"colgrp":null,"colid":"types","colnm":"자동배분","dtype":"text","etype":"raw","attr":"disabled","defval":null,"w":null,"h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"17"}]};

        me.pageObj["_page"] = new gfnFramepage( me ); 
        for(var component_id in me.dataDef["_pgm_data"]) { 
            me.pageObj[component_id] = new gfnComponent( me.pageid, component_id, me.dataDef["_pgm_data"][component_id], me.fnEH, me); 
        }  
        setTimeout(function(){
            $("#frameset").scrollTo(0); //스크롤 
        },10);
        if(typeof(me.fnInitExtra)=='function') me.fnInitExtra(); 
    } 
/*-- SCRIPT autogen end ---------------------------------------------- */

    /* 사용자초기화 */
    me.fnInitExtra=function() {
        gfnGetData("SHOPCD",function(e){});
        me.pos_no = null;
        //탭 설정
        // gfnTab(pageid, "tabs", {"multi-active":"off","toggle-switch":"on"}); 
        //사용자 컴포넌트 
        //me.dataDef["_pgm_data"][myCompoId] = {...};
        //me.pageObj["myCompoId"] = new gfnComponent( me.pageid, myCompoId, me.dataDef["_pgm_data"][myCompoId], me.fnEH, me); 
        //me.pageObj["myCompoId"].userComponent = "myCompoId";
        //사용자 컨트롤
        //var myColinfo = {colid:...}
        //me.pageObj["myColId"] = new gfnControl(myColinfo, me.fnEH) 
        //me.page.find("#myCol").append(me.pageObj["myColId"].dispObj);
        //me.pageObj["myColId"].getVal(); / myCol.setVal(val);...    
        
        function _auth(auth) {
            console.log(auth);
            if(isNull(auth)) { 
                gfnAlert("시스템 사용권한 점검","화면에 대한 권한이 없습니다!");
                $("*[pageidx='"+me.pageid+"']").remove();
                delete gfn[me.pageid]; 
                me.page.remove(); 
            } else { 
                if(isNull(auth.cfm_yn) || auth.cfm_yn != "Y") { //확정권한이 없으면 숨겨주고 잠궈줌
                    me.pageObj.pageCond
                    me.pageObj._pageFunc.setDisp("cfm",false); 
                    me.pageObj.pageCond.col["shopcd"].setDisable(true);
	                me.dataDef._pgm_data.list.content[11].attr='hidden';
	                me.pageObj.list.reset();
                    me.auth = "N";
                } else {
                    me.pageObj._pageFunc.setDisp("cfm",true); 
	                me.dataDef._pgm_data.list.content[11].attr='';
	                me.pageObj.list.reset();
                    me.auth = "Y";
                }
            }
            console.log(me.auth);
        }
        if(subset(gds.comcd,"grpcd","pgm_auth").length==0) { //프로그램 권한조회하여
            gfnGetData("pgm_auth",function(rtn){
                _auth(subset(rtn,"pgmid",pgmid)[0]);  //해당 프로그램의 권한값 가져오기
            }); 
        } else {
            _auth(subset(subset(gds.comcd,"grpcd","pgm_auth"),"pgmid",pgmid)[0]) ;
        } 
    }
    /* 이벤트핸들러 */
    me.fnEH=function(component, evt, row, col, val) {
        //console.log(evt+","+row+","+col+","+val);
        //화면기능버튼이 눌리면 
        if (component==me.pageObj["_pageFunc"]){ 
            if(typeof(me[col])=='function') me[col](); //col=기능명 me["fnSearch"]()=me.fnSearch(); 
        }
        if (component==me.pageObj["list"]){ 
            if(evt=="click" && col=="checkStk") {
                
                //매장별 재고조회 팝업 
                gObj.goods_cd = component.getVal(row,"goods_cd");
                var searchPop = $("<div id='stkPop' class='framepage active'></div>");
                var searchPopup = null;
                gfnLoad("fo_pos","onlineOrderStkPop",searchPop,function(){
                     searchPopup = gfnPopup("매장재고조회",searchPop,{width:400, height:400});
                });
                function _fnCallback(shopcd) {
                    if(component.getVal(row,"mov_yn")!="Y") {
                        if(shopcd=="LF101") {
                            component.setVal(row,"rt_shopcd",""); 
                            component.setVal(row,"mov_yn","D"); 
                        } else {
                            component.setVal(row,"rt_shopcd",shopcd); 
                            if(component.getVal(row,"mov_yn")!="O") component.setVal(row,"mov_yn","R"); 
                        }
                    } else {
                        gfnStatus("판매완료건입니다...");
                    }
                    setTimeout(function(){searchPopup.dialog("close");},1);
                }
                gObj.fnCallback = _fnCallback;  
                
            }
            if(evt=="change") {
                //온라인점 접수처리시 
                if(col=="mov_yn" && val=="D") component.setVal(row,"rt_shopcd","");
                //RT의뢰점이 변경될때
                else if(col=="rt_shopcd") {
                    //Y 수불완료인 건은 그대로 둔다.
                    if(component.getVal(row,"mov_yn")!="Y") {
                        //LF101 로 RT의뢰하는 건 온라인점 접수처리하는 것과 같다.
                        if(val=="LF101") {
                            component.setVal(row,"mov_yn","D");
                            component.setVal(row,"rt_shopcd",""); 
                        } else {
                            //이미 직송이 선택되어 있었으면 유지, 그렇지 않으면 RT의뢰
                            if(component.getVal(row,"mov_yn")!="O") component.setVal(row,"mov_yn","R");  
                        }
                    }
                }
                    
            }
        }        
        //pageCond:조회조건 이벤트처리     
        else if(component==me.pageObj["pageCond"]) {
            if(evt=="componentFunc") {
                if(row=="addRow") {
                    component.addRow();
                } else if(row=="delRow") {
                    component.delRow();
                }
            }
            //if(evt=="change" && col=="colid") {...}
        }

        //사용자 컴포넌트/컨트롤
        else if(component.userComponent=="myCompoId") {
            //if(evt=="dblclick" && col=="colid") {...}
        }
    }
    //search:조회 
    me.fnSearch=function() {
        var pageCond = me.pageObj["pageCond"].exportData()[0];
        me.pageObj.pageCond.setVal("so_no","");
        me.pageObj.pageCond.setVal("so_seq","");
        me.pageObj.pageCond.setVal("so_amt","");
        me.pageObj.pageCond.setVal("so_nm","");
        if( !me.pageObj["pageCond"].chkValid() ) return;
        var args = me.pageObj["pageCond"].exportData()[0];
        console.log(args);
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"search",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                var lists = OUTVAR.list;
                for(i=0;i<lists.length;i++){
                    if(!isNull(lists[i].confirm_dt)){
                        lists[i].confirm = 'Y'
                    }else{
                        lists[i].confirm = 'N'
                    }
                }
                me.pageObj["list"].importData(lists);
                me.pageObj["list"].total("top"); 
            } else {
                gfnAlert("조회오류",OUTVAR.rtnMsg);
            }
        });
    }
    
    //자동배분
    me.fnCalc=function() { 
        var args = {}; 
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"calc",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") { 
                me.fnSearch(); 
            } else {
                gfnAlert("저장오류",OUTVAR.rtnMsg);
            }
        }); 
    } 
    
    me.fnSave=function() {
        //일단 저장하고 체크된 건은 접수처리한다.
        var args = {};
        args.list = me.pageObj.list.exportData();
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"save",{INVAR:invar},function(OUTVAR){
            console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                //실질적인 접수처리
                var list = me.pageObj.list.exportData("selected");
                for(i=0;i<list.length;i++){
                    if(list[i].confirmed == 'Y'){
                        gfnAlert("접수오류","이미 접수 된 건이 있습니다.");
                        return;
                    }
                    if((isNull(list[i].stk_qty)||toNum(list[i].stk_qty) <= 0) && isNull(list[i].rt_shopcd)) {
                        gfnAlert("주문접수 확인","주문["+list[i].market_idx+"] 현재 온라인점 재고가 없는 건은 RT의뢰 매장 지정 후 접수할 수 있습니다.");
                        return;
                    }
                    //so_amt += list[i].sale_amt;
                }
                var args = {};
                args.list = list;
                var invar = JSON.stringify(args);
                console.log(args);
                gfnTx("api"+"."+"order_accept","send",{INVAR:invar},function(OUTVAR){
                    console.log(OUTVAR);
                    if(OUTVAR.rtnCd=="OK") {
                        gfnAlert("주문접수","주문접수가 완료되었습니다. 어드민페이지에서 송장번호를 기입해 주세요");
                        me.fnSearch();
                        // me.fnSave2();
                    } else {
                        gfnAlert("주문접수(이퀴닉스 전송) 오류",OUTVAR.rtnMsg);
                    }
                });
                // fnSave2();
            } else {
                gfnAlert("저장오류",OUTVAR.rtnMsg);
            }
        });
       
    } 

/*-- SCRIPT autogen ---------------------------------------------------- */        
if(typeof(me.fnInit)=='function') me.fnInit();
});

</script>