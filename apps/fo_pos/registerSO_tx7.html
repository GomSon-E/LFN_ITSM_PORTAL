<style>
	#tablecontainer{
		display: flex;
  		justify-content: center;
	}
	table {
		width : 70%;
		height: 300px;
		border-collapse: collapse;
		text-align: left;
		border-left: 1px solid #ccc;
		border-top: 1px solid #ccc;
  	}
	
	td{
		width: 250px;
		padding: 10px;
		vertical-align: middle;
		border-right: 1px solid #ccc;
		border-bottom: 1px solid #ccc;
	}
	th{
		width: 147px;
		padding: 10px;
		font-weight: bold;
		vertical-align :middle;
		border-right: 3px solid #369;
		color: #153d73;
		text-align: right;
		border-bottom: 1px solid #ccc;
	}
	caption{
		padding: 10px;
		font-size: 20px;
		font-weight: bold;
		color: #153d73;
	}
	#buttonth{
		border-right: 0px;
	}
	.card {
		border-radius: 5px;
		background-color: #369;
		width : 180px;
		color: white;
	}
	input{
		text-align: right;
	}
</style>
<html>
	<head>	 
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.0/jquery.min.js"> </script>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />	
		<script> 
		console.log("0");
		function lpad(str, padLen, padStr) {
		if (padStr.length > padLen) {
			return str;
		}
		str += ""; // 문자로
		padStr += ""; // 문자로
		while (str.length < padLen)
			str = padStr + str;
		str = str.length >= padLen ? str.substring(0, padLen) : str;
		return str;
		}

		function rpad(str, padLen, padStr) {
		if (padStr.length > padLen) {
			return str + "";
		}
		str += ""; // 문자로
		padStr += ""; // 문자로
		while (str.length < padLen)
			str += padStr;
		str = str.length >= padLen ? str.substring(0, padLen) : str;
		return str;
		}

		function setYYMMDDHHMMSS()
			{
				var nowDate = new Date(); 
				var vaYY = nowDate.getFullYear().toString().substr(2, 4);
				var vaMM = pad(nowDate.getMonth()+1, 2);
				var vaDD = pad(nowDate.getDate()   , 2);
				var vaHH = pad(nowDate.getHours()  , 2);
				var vaMin= pad(nowDate.getMinutes(), 2);
				var vaSS = pad(nowDate.getSeconds(), 2);
				
				return vaYY+vaMM+vaDD+vaHH+vaMin+vaSS;
			}
		function pad(number, length)
		{
			var str = number.toString();
			while(str.length < length)
			{
				str = '0' + str;
			}
			return str;
		}
		function setContent(param)
		{
			if(param.slsAmt) 
			{
				document.getElementById("txtSlsAmt").value = param.slsAmt;    //매출금액		
			}
			
			if(param.mlplMnts) 
			{
				document.getElementById("txtMlplMnts").value = param.mlplMnts;	//할부개월			
			}
			
			if(param.slsDt) 
			{
				document.getElementById("txtCatApprDate").value = param.slsDt;	//승인일자			
			}
			
			if(param.aprvNo) 
			{
				document.getElementById("txtCatApprNo").value = param.aprvNo;	//승인번호			
			}
			
			if(param.csrcCnsmKd) 
			{
				document.getElementById("txtCsrcCnsmKd").value = param.csrcCnsmKd;		//현금영수증 소비자구분		
			}		    
		}

		String.prototype.fillZero = function(n)
		{
			var str   = this;
			var zeros = "";

			if(str.length < n)
			{
				for(i = 0; i < n - str.length; i++)
				{
					zeros += '0';
				}
			}
			return zeros + str;
		}

		String.prototype.fillSpace = function(n)
		{
			var str   = this;
			var space = "";

			if(str.length < n)
			{
				for(i = 0; i < n - str.length; i++)
				{
					space += ' ';
				}
			}
			return str + space;
		}

		String.prototype.byteLength = function()
		{
			var len = 0;
		
			for(var i=0; i<this.length; i++)
			{
				len += (this.charCodeAt(i) > 127) ? 2 : 1;
			}
			return len;
		}

		String.prototype.substrKor = function(idx, len)
		{
			if(!this.valueOf()) return "";
		
			var str = this;
			var pos = 0;

			for(var i=0; pos<idx; i++)
			{
				pos += (str.charCodeAt(i) > 127) ? 2 : 1;
			}

			var beg = i;
			var byteLen = str.byteLength();
			var lim = 0;			

			for(var i=beg; i<byteLen; i++)
			{
				lim += (str.charCodeAt(i) > 127) ? 2 : 1;

				if(lim > len)
				{ 
					str = str.substring(beg, i);
					break;
				}
			}
		
			return str;   
		}

		function JSONtoString(object) 
		{
			var results = [];
			
			for (var property in object) 
			{
				var value = object[property];
				if (value)
					results.push(property.toString() + ': ' + value);
			}
						
			return '{' + results.join(', ') + '}';
		}

		function FindJSONtoString(Key, object) 
		{
			var results = "";
			for (var property in object) 
			{
				var value = object[property];
				if (value)
				{
					if(Key == property.toString())
					{
						results = value;
						break;
					}
				}
			}
			return results;
		}

		stringformat = function (text) 
		{
			if (arguments.length <= 1) return text;

			for (var i = 0; i <= arguments.length - 2; i++) {
				text = text.replace(new RegExp("\\{" + i + "\\}", "gi"), arguments[i + 1]);
			}

			return text;
		}
		// function failcard(){
		// 	var check = "1";
		// 	var RES_CDval = "0001";
		// 	var data = {RES_CD : RES_CDval};
		// 	var optionVal = $("#selectbox option:selected").val();
		// 	var comment = $("input[name=comment]").val();
		// 	var txtSlsAmt = $("input[name=txtSlsAmt").val();
		// 	var cardcompany = $("input[name=cardcompany]").val();
		// 	if(cardcompany == ""){
		// 		alert("임의 등록 시 카드사는 반드시 입력하여야 합니다.");
		// 		return;
		// 	}
		// 	var rtn = {comment : comment,
		// 			   optionVal : optionVal,
		// 			   data : data,
		// 			   payment : txtSlsAmt,
		// 			   check : check,
		// 			   cardcompany : cardcompany
		// 	};
		// 	window.opener.gParam.fnCallback(rtn);
		// 	window.close();
		// }
		function usdcard(){
			var request_msg = "";
			request_msg = "S_STATUS";
			$("input[name=taRequest]").attr("value", request_msg);
			var taRequestvalue = $("input[name=taRequest]").val();
			var taRequest = {taRequest : taRequestvalue };
			$.ajax
			({
				url:"http://127.0.0.1:27098", 
				type:"POST",
				async : false,
				dataType : "jsonp",
				jsonp : "callback",
				data : { "REQ": taRequestvalue },
				success: function(datalist)
				{	
					console.log(datalist);
					
					if(datalist != null && datalist.RES_CD == '0000'){
						var point = $("input[name=point]").val();
						var balance = $("input[name=balance]").val();
						var mlplMnts = $("input[name=txtMlplMnts").val();
						var strSaleAmt = $("input[name=txtSlsAmt]").val();
						var saleAmt = new Number(strSaleAmt);
						console.log(saleAmt);
						var suppAmt = Math.round(saleAmt / 1.1);
						var vat = saleAmt - suppAmt;
						var strVat = new String(vat);
						var request_msg = "";
						
						
						vaYYMMDDHHMMSS = setYYMMDDHHMMSS();
						request_msg += "APP____1";                     			   // 메시지 창 출력하지 않음 
						request_msg += String.fromCharCode(2);                     // STX
						request_msg += "A0";									   // 거래요청전문
						request_msg += "D1";                                       // 거래종류코드
						request_msg += String.fromCharCode(28);                    // FS(1) //단말기ID
						request_msg += String.fromCharCode(28);                    // FS(2) //현금영수증 WCC + 현금고객ID
						request_msg += String.fromCharCode(28);                    // FS(3)
						request_msg += mlplMnts.fillZero(2);                       // 할부개월
						request_msg += String.fromCharCode(28);					   // FS(4)
						request_msg += strSaleAmt;                    // 총금액
						request_msg += String.fromCharCode(28);					   // FS(5)
						request_msg += strVat;                         // 세금
						request_msg += String.fromCharCode(28);					   // FS(6)
						request_msg += "0";                                // 봉사료
						request_msg += String.fromCharCode(28);					   // FS(7) 원거래 일시
						request_msg += String.fromCharCode(28);                    // FS(8) 원거래 승인번호
						request_msg += String.fromCharCode(28);                    // FS(9) 거래일련번호
						request_msg += String.fromCharCode(28);                    // FS(10)거래구분코드
						request_msg += String.fromCharCode(28);                    // FS(11)간편결제구분코드
						request_msg += String.fromCharCode(28);                    // FS(12)(포인트)WCC+포인트번호
						request_msg += String.fromCharCode(28);                    // FS(13) 포인트승인번호     
						request_msg += String.fromCharCode(28);                    // FS(14) 사업자번호
						request_msg += String.fromCharCode(28);                    // FS(15) 대표자명
						request_msg += String.fromCharCode(28);                    // FS(16) 가맹점명(POS 거래고유번호)
						request_msg += vaYYMMDDHHMMSS;                             // 
						request_msg += String.fromCharCode(28);                    // FS(17) 가맹점주소
						request_msg += String.fromCharCode(28);                    // FS(18) 가맹점전화번호
						request_msg += String.fromCharCode(28);                    // FS(19) 매출전표출력여부/추가요청
						request_msg += "N";                                        // [Y] 전표출력 , N 전표출력하지 않음
						request_msg += String.fromCharCode( 3);                    // ETX

						$("input[name=taRequest]").attr("value", request_msg);
						var taRequestvalue = $("input[name=taRequest]").val();
						var taRequest = {taRequest : taRequestvalue };
						console.log("요청 전문 " + taRequest);
							$.ajax
									({
										url:"http://127.0.0.1:27098", 
										async : false,
										type:"POST",
										dataType : "jsonp",
										jsonp : "callback",
										data : { "REQ": taRequestvalue},
										success: function(data)
										{	
											var rtn = {data : data,
															taRequest : taRequest};
											if(data != null && data.RES_CD == '0000' && data.DISPLAY == ""){
												window.opener.gParam.fnCallback(rtn);
												window.close();
												console.log(rtn);
											}else{
												alert("결제 오류 : " + data.DISPLAY);
												return;
											}
										},
										error : function(requestObject, error, errorThrown) {
											alert("CAT단말기 통신 중 오류가 발생하였습니다. 연결 확인 후 다시 시도하여 주시기 바랍니다. \n 실제 승인이 성공한 경우 임의등록 처리 바랍니다.");
											var rtn={data:{RES_CD:"TX_ERR",req:requestObject,error:error,errorThrown:errorThrown}};
											return;
										} 
										
									});
					}else{
						alert("단말기 통신 오류 : " + datalist.DISPLAY);
						return;
					}
				},
				error : function(request,status,error){
					window.NEXACROHTML.FireUserNotify(request.responseText);
					alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
					console.log (error);
			 	}
			});
			
						
		};
			

			$(function(){
				$("input[name=totalpay]").attr("value",window.opener.gParam.totalpay);
				$("input[name=balance]").attr("value",window.opener.gParam.balance);
				$("input[name=txtSlsAmt]").attr("value",window.opener.gParam.balance);
				$("input[name=so_tp]").attr("value",window.opener.gParam.so_tp);
				console.log($("input[name=so_tp]").val());
				$("#faillist").hide();
			}); 
				
		</script>	
	</head>
	
	<body>
		<br><br><br>
		<td colspan="4"><input name="txtUrl" style="width:100%;" type="hidden" value="http://127.0.0.1:27098" /> </td>
		<td colspan="4"><input name="taRequest"  style="width:100%;" type="hidden"></input> </td>
		<td colspan="4"><input name="taRequest2"  style="width:100%;" type="hidden"></input> </td>
		<td colspan="4"><input name="so_tp"  style="width:100%;" type="hidden"></input> </td>
		<div id="tablecontainer">
			<table id="totalpaylist">
				<tr>
					<caption>카드결제 승인 창 입니다.</caption>
				</tr>
				<tr>
					<th> 총    액 : </th> <td> <input type="text" name = "totalpay"> </td> 
				</tr>
				<tr>
					<th> 잔    액 : </th> <td> <input type="text" name = "balance"> </td>
				</tr>
				<tr id="line">
					<th> 할부개월 : </th> <td> <input type="text" name = "txtMlplMnts"><br>*일시불 = 공백 <br>*3개월 = 3입력</td>
				</tr>
				<tr>
					<th> 결제금액 : </th> <td> <input type="text" name = "txtSlsAmt"> </td>
				</tr>
				<tr>
					<th id="buttonth"></th><td><button class="card" onclick="usdcard(); this.onclick='';" style="height: 70px; font-weight: bold; font-size: 15px;">카드승인 요청</button></td>
				</tr>
			</table>
			<!-- <table id="faillist">
				<tr>
					<caption>카드결제 임의등록 창 입니다.</caption>
				</tr>
				<tr>
					<th> 총    액 : </th> <td> <input type="text" name = "totalpay"> </td> 
				</tr>
				<tr>
					<th> 잔    액 : </th> <td> <input type="text" name = "balance"> </td>
				</tr>
				<tr id="line">
					<th> 할부개월 : </th> <td> <input type="text" name = "txtMlplMnts">*일시불 = 공백 3개월 = 3입력</td>
				</tr>
				<tr>
					<th> 카 드 사 : </th> <td> <input type="text" name = "cardcompany" required></td>
				</tr>
				<tr>
					<th> 결제금액 : </th> <td> <input type="text" name = "txtSlsAmt"> </td>
				</tr>
				<tr>
					<th>
						<select id="selectbox">
							<option value="1">임의등록</option>
							<option value="2">전화승인</option>
						</select> 
					</th>
					<td><input type="text" name = "comment" placeholder="ex : 통신오류"> *사유를 적어주세요</td>
				</tr>
				<tr>
					<th id="buttonth"></th><td><button class="card" onclick="failcard();">임의등록</button></td>
				</tr>
			</table> -->
		</div>
	</body>	
	
</html>