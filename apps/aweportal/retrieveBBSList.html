<div id="toggleDiv">
    <div class="pageNav"></div>
    <div class="pageTop"></div>
    <div class="pageCond">
        <div class="section">
            <div class="condCol 3col">
                <div class="section">
                    <h2>게시글 목록</h2>
                    <h3>* 공지사항 유효기간은 30일로 임시 설정</h3>
                </div>
                <label for="pgm"><span class="dummy"></span></label>
                <input type="text" class="searchBar" colid="pgmid" name="pgmid" placeholder="pgmid here" />
                <button class="searchBtn"><i class="fa fa-search"></i></button>
                <input type="text" colid="pgm_nm" readonly name="pgm_nm"/> 
            </div>      
        </div>
        <button class="btnClear">Reset</button>    
    </div>
    <!-- 게시글 표시 영역 -->
    <div>
        <table class="BBSTable">
            <thead>
            <tr>
                <th>작성자</th>
                <th>제목</th>
                <th>작성일자</th>
                <th>조회수</th>
            </tr>    
            </thead>
            <tbody class="BBSTbody">
            </tbody>
        </table>
    </div>
</div>
<div id="mnBBS" style="display: none;">
    <form>
        <input type="text" class="boardTitle" placeholder="제목" style="margin-bottom : 20px; margin-top : 20px;">
        <textarea id="mytextarea" class="boardContent" name="mytextarea" placeholder="내용을 입력하세요">
        
        </textarea>
        <br>
        <form id="uploadForm" enctype="multipart/form-data" method="post" aria-readonly="true">
            <div class="upload-btn-wrapper">
                <input type="file" id="input_file" name="fileField" multiple="true" style="height: 100%;" />
                <!-- <button class="upload-btn">파일선택</button> -->
            </div>
            <div id="dropZone">
                <div id="fileDragDesc" style="margin: 10px;"> 파일을 업로드 해주세요. </div>
            
                <table id="fileListTable" width="100%" border="0px">
                    <tbody id="fileTableTbody">
        
                    </tbody>
                </table>
            </div>
        </form>
        <button type="button" class="updateBtn">수정</button>
        <!-- <button type="button" class="deleteBtn">삭제</button> -->
        <button type="button" class="toList">목록으로</button>
      </form>
      <form>
        <input type="text" id="mycommarea" placeholder="댓글을 입력하세요" style="resize: none;"> 
            
        </textarea>
        <button type="button" class="insertCommBtn" >댓글 작성</button>
      </form>
      <table class="CommTable">
          <thead>
              <th>댓글 내용</th>
              <th>작성자</th>
              <th>작성 시간</th>
              <th>수정</th>
              <th>삭제</th>
          </thead>
          <tbody class="CommTbody">
          </tbody>
      </table>
      <!-- 팝업 테스트 -->
      <div class="openPopup"></div>   
      <div id="popup01">
          <div class="close">close</div>
          <input type="text" class="updateComm" placeholder="수정할 내용을 입력하세요">
          <button type="button" class="updateCommBtn">수정하기</button>
      </div>
</div>  

<style>
#mnBBS .boardTitle {
    width: 99%;
    margin-bottom : 20px; 
    margin-top : 20px;
}

.BBSTable {
    width: 97.5%; 
    margin: 0 auto;
    margin-top : 20px;
    padding-top: 2%;
    padding-bottom: 20%;
    font-size: 1.2em;
}

#popup01{
    display: none;
}
#popup01{
    width: 500px;
    height: 150px;
    position: absolute;
    top: 50%;
    left: 50%;
    margin: -250px 0 0 -250px;
    background-color: #fff;
    z-index: 2;
}
.backon{
    content: "";
    width: 100%;
    height: 100%;
    background: #00000054;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1;
}
.close{
    position:absolute;
    top:-25px;
    right: 0;
    cursor:pointer;
}

.openPopup{
    cursor:pointer;
}

#dropZone {
    height: 120px;
    border : 1px solid rgb(204, 204, 204); 
    margin-top : 30px; 
    margin-bottom: 30px;
}
/* 팝업 테스트 끝 */
.BBSTable > thead > tr > th { 
    background-color: rgba(138, 131, 131, 0.925); 
    color: #ffffff; 
}

.BBSTable > thead > tr > th { 
    text-align: center; 
}

.BBSTable > tbody > tr > td { 
    text-align: center; 
}

#dropZone > tr > td {
    margin-right : 5px;
}    
</style>
<script>
// autogen start /////////////////////////////////////////////////////////////////////////    
$(function() {
// 공지사항 전체 조회
var appid = "aweportal";
var pgmid = "manageBBS";  
var page = $("*[pgmid='"+pgmid+"'].framepage").last(); /* html로 호출되기 때문에 현재 pageid는 스스로 알아내야함 */
var pageid = page.attr("id");  
var dataSet = {};
var pageObj = {};   
var bEdit = false;

gfnTx(appid+"."+pgmid, "selectAllDoc", {}, function(OUTVAR){
    for (let i = 0; i < OUTVAR.list.length; i++) {
        const el = OUTVAR.list[i];
        var BBSList = {
            docid: el.docid,
            title: el.title,
            content: el.content,
            reg_usid: el.reg_usid,
            dt: el.upd_dt,
            read_cnt: el.read_cnt
        };
        me.dataSet["BBSList"].push(BBSList);
        me.fnDrawBBSList();
    };
})

$("#"+pageid+" #mytextarea").attr("id",pageid+"mytextarea");
        var plugins = [
    "advlist", "autolink", "lists", "link", "image", "charmap", "print", "preview", "anchor",
    "searchreplace", "visualblocks", "code", "fullscreen", "insertdatetime", "media", "table",
    "paste", "code", "help", "wordcount", "save"
];
var edit_toolbar = 'formatselect fontselect fontsizeselect |'
            + ' forecolor backcolor |'
            + ' bold italic underline strikethrough |'
            + ' alignjustify alignleft aligncenter alignright |'
            + ' bullist numlist |'
            + ' table tabledelete |'
            + ' link image';
var selector = '#'+pageid+'mytextarea';
tinymce.init({
    selector: selector,
    branding: false,
    forced_root_block: false,
    language: "ko_KR",
    plugins: plugins,
    toolbar: edit_toolbar,
    height: 320,
    statusbar: false,
    resize: false
});
// 날짜 형식 메소드
function dateFormat(date) {
    let month = date.getMonth() + 1;
    let day = date.getDate();
    let hour = date.getHours();
    let minute = date.getMinutes();
    let second = date.getSeconds();

    month = month >= 10 ? month : '0' + month;
    day = day >= 10 ? day : '0' + day;
    hour = hour >= 10 ? hour : '0' + hour;
    minute = minute >= 10 ? minute : '0' + minute;
    second = second >= 10 ? second : '0' + second;

    return date.getFullYear() + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
}
var me = {} // Instance
me.fnInit = function() {
        gfn[pageid] = me;
        me.appid    = appid;
        me.pgmid    = pgmid;
        me.pageid   = pageid;
        me.page     = page;

        //화면초기화 
        me.dataSet = dataSet;
        me.pageObj = pageObj;
        me.bEdit = bEdit;  /* 수정여부 for 빠져나가기, 재조회 */
        me.dataSet["_pgm"] = [
            {
                pgmid:"manageBBS", pgm_nm:"게시판 관리",
                pgm_grp_nm:"시스템개발",
                app_pgmid:"aweportal"
            }
        ][0]; 
        me.dataSet["_pgm_func"] = [];  
        me.dataSet["BBSList"] = [];
        me.dataSet["FileList"] = [];
        me.dataSet["CommList"] = [];

        me.pageObj["_pageFunc"] = new gfnButtonSet( "#"+me.pageid+" .pageFunc",
                me.dataSet["_pgm_func"], 
                me.fnEH );

        page.find("#BBSList .bbs").on("click",".bbs", function(e) {
        //pgm을 클릭하면 해당 화면을 열어준다. 
        var menu = $(e.target);
        var pgmid = menu.attr("pgmid");
        var pgmnm = menu.text(); 
        gMDI.openPage( pgmid, pgmnm );
    }); 
    },
    // 게시글 목록 조회 메소드
    me.fnDrawBBSList= function() {
        page.find(".BBSTable .BBSTbody").html("");
        $.each(me.dataSet["BBSList"],function(idx,el) {
            var bbsList = $(`<tr class="bbs" docid='${el.docid}'>`);
            bbsList.append(`<td class="reg_usid">${el.reg_usid}</td> `);
            bbsList.append(`<b><td class="title">${el.title}</td></b> `);
            //bbsList.append(`<td class="content">${el.content}</td> `);
            bbsList.append(`<td class="dt">${el.dt}</td>`);
            bbsList.append(`<td class="read_cnt">${el.read_cnt}</td>`);
            bbsList.append(`</tr>`);
            page.find(".BBSTable .BBSTbody").append(bbsList);
            bbsList.on("click",function(e){
                var oE = $(e.target);
                var oTR = oE.exactObj("tr[docid]");
                if(oTR.length != 1) return;
                //if(oE.is("button")) return;
                me.fnShowDetail(oTR.attr("docid"));
            });
        });
    },
    // 게시글 상세정보 조회 메소드
    me.fnShowDetail= function(docid) {
        var content = tinymce.activeEditor.getContent();
        var title = $(".active .boardTitle").val();
        var comments = $("#mycommarea").val();
        var userid = gUserinfo.userid;
        var arg = {docid : docid};
        var invar = JSON.stringify(arg);
        gfnTx(appid+"."+pgmid, "selectOneDoc", {INVAR : invar}, function(OUTVAR) {
            var title = OUTVAR.list[0].title;
            var content = OUTVAR.list[0].content;
            page.find("#toggleDiv").hide();
            page.find("#mnBBS").show();
            page.find("#mnBBS .boardTitle").val(title);
            tinyMCE.activeEditor.setContent(content);
        });
        gfnTx(appid+"."+pgmid, "increaseReadcnt", {INVAR : invar}, function(OUTVAR) {

        });
        gfnTx(appid+"."+pgmid, "selectComm", {INVAR : invar}, function(OUTVAR){
            for (let i = 0; i < OUTVAR.list.length; i++) {
                const el = OUTVAR.list[i];
                var CommList = {
                    docid: el.ref_id,
                    commid: el.val_1,
                    comments: el.comments,
                    reg_usid: el.reg_usid,
                    dt: el.reg_dt
                };
                me.dataSet["CommList"].push(CommList);
                me.fnDrawCommList(docid);
            };
        });
    
        gfnTx("aweportal.fileUploader", "selectFile", {INVAR : invar}, function(OUTVAR) {
            for (let i = 0; i < OUTVAR.fList.length; i++) {
                const el = OUTVAR.fList[i];
                var FileList = {
                    fileid: el.fileid,
                    filename: el.orgn_nm,
                    fileSize: el.file_sz,
                    file_dir: el.file_dir
                };
                me.dataSet["FileList"].push(FileList);
                me.fnDrawFileList(docid);
            };
        });

        // 공지사항은 관리자만 수정, 삭제 권한 부여

        if(userid != "admin") {
            $("#mnBBS .updateBtn").hide();
            $("#mnBBS .deleteBtn").hide();
        };

        // 게시글 삭제 버튼 클릭시 이벤트 발생
        // $("#mnBBS .deleteBtn").on("click", function(e) {
        //     if(confirm("게시글을 삭제하시겠습니까?")) {
        //         me.fnDeleteBBS(docid);
        //         $("li[pgmid=retrieveBBSList]").trigger("click");
        //     }
        // });
        // 게시글 수정 버튼 클릭시 이벤트 발생
        $("#mnBBS .updateBtn").on("click", function(e) {
            me.fnUpdateBBS(docid, title, content);
            $("li[pgmid=manageBBS]").trigger("click");
            $(".active .closetab").click();
        });   
        // 댓글 작성 버튼 클릭시 이벤트 발생
        $("#mnBBS .insertCommBtn").on("click", function(e) {
            me.fnInsertComm(docid, comments);
            //$("li[pgmid=retrieveBBSList]").trigger("click");
        });
    },
    // 파일 목록 조회 메소드
    me.fnDrawFileList= function(docid) {
        page.find("#dropZone #fileDragDesc").html("");
        $.each(me.dataSet["FileList"],function(idx,el) {
            var fileList = $(`<tr class="fileList" fileid='${el.fileid}'>`);
            fileList.append(`<td class="filename">${el.filename}</td>`);
            if(el.fileSize > 1000000) { 
                var chanedFileSize = Math.round(el.fileSize/1000000);
                fileList.append(`<b><td class="fileSize">${chanedFileSize} MB</td></b> `);
            }
            else {
                var chanedFileSize = el.fileSize/1000;
                fileList.append(`<b><td class="fileSize">${chanedFileSize} KB</td></b> `);
            }
            fileList.append(`</tr>`);
            page.find("#dropZone #fileDragDesc").append(fileList);

            var fileid = el.fileid;
            var filename = el.filename;
            var url = el.file_dir;
            var args = {"fileid" : fileid, "filename" : filename, "url" : url};
            var invar = JSON.stringify(args);
            fileList.on("click",function(e){
                var oE = $(e.target);
                var oTR = oE.exactObj("tr[fileid]");
                gfnTx("aweportal.fileDownloader", "", {INVAR : invar}, function(OUTVAR) {

                });
            });
        });
    },
    // 게시글에 달린 댓글 조회 메소드
    me.fnDrawCommList= function(docid) {
        page.find(".CommTable .CommTbody").html("");
        $.each(me.dataSet["CommList"],function(idx,el) {
                var commList = $(`<tr id="${el.commid}" class="bbsComm" docid='${el.docid}'>`);
                commList.append(`<td class="comments">${el.comments}</td> `);
                commList.append(`<td class="commReg_usid">${el.reg_usid}</td> `);
                commList.append(`<td class="commDt">${el.dt}</td>`);
                commList.append(`<Button class="commUpdate">수정</Button>`);
                commList.append(`<Button class="commDelete">삭제</Button>`);
                commList.append(`</tr>`);
                page.find(".CommTable .CommTbody").append(commList);
                // 댓글 삭제 버튼 클릭시 이벤트 발생
                commList.on("click",".commDelete", function(e){
                    var oE = $(e.target);
                    var oTR = oE.exactObj("tr[id]");
                    var arg = {commid : oTR.attr("id")};
                    invar = JSON.stringify(arg);
                    if(oTR.length != 1) return;
                    $.ajax({
                        url: gfnTx(appid+"."+pgmid, "deleteComm", {INVAR : invar}, function(OUTVAR) {}),
                        //url: "/deleteComm",
                        type: "POST",
                        data: invar,
                        async: false,
                        success: function() {
                            console.log(oTR.attr("id"));
                            $("#"+oTR.attr("id")).remove();
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    })
                });
                // 댓글 수정 버튼 클릭시 이벤트 발생
                commList.on("click",".commUpdate", function(e){
                    var oE = $(e.target);
                    var oTR = oE.exactObj("tr[id]");
                    var comments = $(".active #popup01 .updateComm").val();
                    if(oTR.length != 1) return;
                    $(".active #popup01").show();
                    $("body").append('<div class="backon"></div>'); //뒷배경 생성
                    $(".active #popup01 .updateCommBtn").on("click", function(e) {
                        me.fnUpdateComm(comments, oTR.attr("id"));
                        $(".active #popup01 .updateComm").val("");
                        $("li[pgmid=manageBBS]").trigger("click");
                        $(".active #popup01").hide(); //close버튼을 클릭하거나 뒷배경 클릭시 팝업 삭제
                        $(".backon").hide();
                    });
                });
                $("body").on("click", function(event) { 
                    if(event.target.className == 'close' || event.target.className == 'backon'){
                        $("#popup01").hide(); //close버튼을 클릭하거나 뒷배경 클릭시 팝업 삭제
                        $(".backon").hide();
                    }
                });
        });
    },
    // 게시글 삭제 메소드
    // me.fnDeleteBBS= function(docid) {
    //     var arg = {docid : docid};
    //     invar = JSON.stringify(arg);
    //     gfnTx("aweportal.manageBBS", "deleteDoc", {INVAR : invar}, function(OUTVAR) {

    //     });
    // },
    // 게시글 수정 메소드
    me.fnUpdateBBS= function(docid, title, content) {
        var content = tinymce.activeEditor.getContent();
        var title = $(".active .boardTitle").val();
        var args = {title:title, content:content, docid : docid};
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid, "updateDoc", {INVAR : invar}, function(OUTVAR){
            console.log(OUTVAR.rtnMsg);
            if(OUTVAR.rtnCd != "OK") {
                gfnAlert("수정 실패", "수정에 실패하였습니다.");
                return;
            } 
        });
    },

    // 댓글 작성 메소드
    me.fnInsertComm= function(docid, comments) {
        var userid = gUserinfo.userid;
        var comments = $(".active #mycommarea").val();
        var arg = {docid : docid, comments : comments};
        var invar = JSON.stringify(arg);
        var sysdate = new Date();
        var sDate = dateFormat(sysdate);
        if(!isNull(comments)){
            $.ajax({
                url:  gfnTx(appid+"."+pgmid, "insertComm",{INVAR : invar}, function(OUTVAR){}),
                type: "POST",
                data: invar,
                async: false,
                success: function(data) {
                    var commList = $(`<tr id="${data.commid}" class="bbsComm" docid='${docid}'>`);
                    commList.append(`<td class="comments">${comments}</td> `);
                    commList.append(`<td class="commReg_usid">${userid}</td> `);
                    commList.append(`<td class="commDt">${sDate}</td>`);
                    commList.append(`<Button class="commUpdate">수정</Button>`);
                    commList.append(`<Button class="commDelete">삭제</Button>`);
                    commList.append(`</tr>`);
                    page.find(".CommTable .CommTbody").append(commList);
                    $(".active #mycommarea").val("");
                },
                error: function(error) {
                    console.log(error);
                }
            });
        } else {
            gfnAlert("등록 실패", "내용을 입력해 주세요.");
            return;
        }
    },
    // 댓글 수정 메소드
    me.fnUpdateComm= function(comments, commid) {
        var comments = $(".active #popup01 .updateComm").val();
        var args = {comments:comments, commid : commid};
        var invar = JSON.stringify(args);
        gfnTx("aweportal.manageBBS", "updateComm", {INVAR : invar}, function(OUTVAR){
            console.log(OUTVAR.rtnMsg);
            $(".active #popup01 .updateComm").val("");
            if(OUTVAR.rtnCd != "OK") {
                gfnAlert("수정 실패", "수정에 실패하였습니다.");
                return;
            } 
        });
    }
    // 댓글 삭제 메소드
    // me.fnDeleteComm= function(commid) {
    //     var arg = {commid : commid};
    //     invar = JSON.stringify(arg);
    //     gfnTx(appid+"."+pgmid, "updateComm", {INVAR : invar}, function(OUTVAR){
            
    //     });
    // }
    if(typeof(me.fnInit)=='function') me.fnInit();
    
    $("#mnBBS .toList").click(function() {
        $("li[pgmid=manageBBS]").trigger("click");
        $(".active .closetab").click();
    });
});
</script>