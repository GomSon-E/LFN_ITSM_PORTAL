<style>[pgmid="retrieveCafeList"] li.cafe-list{
    font-size: 15px;
    display: inline-block;
    /* border: 1px solid hsl(0deg 0% 80%); */
    width: 265px;
    height: 100px;
    margin: 16px 32px;
    background-color: hsl(0deg 0% 97%);
    border-radius: 16px;
    cursor: pointer;
}
[pgmid="retrieveCafeList"] li.cafe-list.search{
    background-color: hsl(50deg 100% 95%);
}
[pgmid="retrieveCafeList"] ul {
    padding: 0;
}
[pgmid="retrieveCafeList"] h3 {
    margin-left:16px;
}
[pgmid="retrieveCafeList"] p {
    padding-left:36px;
    pointer-events: none;
}
[pgmid="retrieveCafeList"] p.num {
    text-align: right;
    padding-right: 36px;
    font-size: 12px;
    pointer-events: none;
}
.createList li.list{
    display:flex;
    flex-direction: column;
    align-items: flex-start;
}
.createList li.list label{
    margin-bottom: 14px;
}
.saveBtn{
    margin-left: 300px;
    padding: 4px 8px;
}
.input{
    margin:0 10px;
} 

[pgmid="retrieveCafeList"] #tabs{
    margin:0 12px;
}</style>

<!-- HTML autogen start ---------------------------------------------- -->            
<div class="pageNav"></div>
    <div class="pageTop">
        <h2>Cafe List</h2>
    </div>
    <div class="pageCond">
        <!-- 카페 목록 조회 
        <input class="input" name="cafe" type="text" autocomplete="off">
        <button class="searchBtn">검색</button> -->
    </div>
    <div class="pageGuide"></div>

    <div class="searchcafeList" id="cafeList">
        <h3>검색된 카페</h3>
        <ul id="list3"></ul>
    </div>

    <div class="cafeList" id="cafeList">
        <ul id="tabs">
            <li refid="t1">모든 카페</li>
            <li refid="t2">내 카페</li>
            <li refid="t3">가입 가능한 카페</li>
        </ul>
        
        <div>
            <div id="t1" class="flexColumn">
                <ul id="list"></ul> 
            </div> 
            <div id="t2" class="flexColumn">
                <ul id="list1"></ul> 
            </div> 
            <div id="t3" class="flexColumn">
                <ul id="list2"></ul>
            </div>
        </div> 
        
        
        <!--<div class='list-box'>-->
        <!--    <div class='cafe'>-->
        <!--        <h3>내 카페</h3>-->
        <!--        <ul id="list"></ul>-->
        <!--    </div>-->
        <!--    <div class='cafe'>-->
        <!--        <h3>가입 가능한 카페</h3>-->
        <!--        <ul id="list2"></ul>-->
        <!--    </div>-->
        <!--</div>-->
        
    </div>
<!-- HTML autogen end ---------------------------------------------- -->
<script>
/*-- SCRIPT autogen start ---------------------------------------------- */        
$(function() {
    var appid = "aweportal";
    var pgmid = "retrieveCafeList"; 
    var page = $("*[pgmid='"+pgmid+"'].framepage").last();
    var pageid = page.attr("id"); 
    var me = {}
    var dataSet = {};
    var dataDef = {};
    var pageObj = {};
    var bEdit = false;
    me.fnInit = function() {
        gfn[pageid] = me; 
        me.appid    = appid;
        me.pgmid    = pgmid;
        me.pageid   = pageid;
        me.page     = page; 
        me.dataSet = dataSet;
        me.dataDef = dataDef;
        me.pageObj = pageObj;
        me.bEdit = bEdit;
me.dataDef["_pgm"]={"pgmid":"retrieveCafeList","pgm_nm":"카페목록조회/생성","pgm_tp":"UX","proc_mst_id":"","proc_mst_nm":"","remark":"카페목록을 조회 또는 신규카페를 생성한다.","ver":0.2,"pgm_stat":"Y","reg_usid":"admin","reg_dt":"2021-11-15 09:42:33","upd_usid":"admin","upd_dt":"2021-11-15 09:42:33","app_pgmid":"aweportal","pgm_grp_nm":"카페","sort_seq":12,"shortcut":"","crud":"","app_pgm_nm":"포털"};
me.dataDef["_pgm_func"]=[{"func_icon":"fas fa-search","reg_dt":"2021-11-15 09:42:33","reg_usid":"","func_nm":"조회","upd_usid":"","upd_dt":"2021-11-15 09:42:33","func_tp":"DB_R","remark":"카페를 검색하려면 카페그룹이름으로 검색합니다.","pgmid":"retrieveCafeList","sort_seq":"1","funcid":"search","content":null,"crud":"R","id":"0"},{"func_icon":"fas fa-plus","reg_dt":"2021-11-15 09:42:33","reg_usid":"","func_nm":"카페생성","upd_usid":"","upd_dt":"2021-11-15 09:42:33","func_tp":"EH","remark":"새로운 카페를 생성하려면 카페생성 버튼을 클릭하세요.","pgmid":"retrieveCafeList","sort_seq":"2","funcid":"create","content":null,"crud":"R","id":"1"}];
me.dataDef["_pgm_data"] = {};
me.dataDef["_pgm_data"]["pageCond"]={"sort_seq":"1","data_id":"pageCond","data_nm":"카페그룹이름","data_icon":null,"component_pgmid":"aweForm","component_option":null,"inout_tp":"IN","content":[{"sort_seq":"1","section":null,"section_icon":null,"colgrp":null,"colid":"grp_nm","colnm":"카페그룹이름","dtype":"text","etype":"txt","attr":null,"defval":null,"w":"10","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C"}]};

        me.pageObj["_page"] = new gfnFramepage( me ); 
        for(var component_id in me.dataDef["_pgm_data"]) { 
            me.pageObj[component_id] = new gfnComponent( me.pageid, component_id, me.dataDef["_pgm_data"][component_id], me.fnEH, me); 
        }  
        setTimeout(function(){
            $("#frameset").scrollTo(0); //스크롤 
        },10);
        if(typeof(me.fnInitExtra)=='function') me.fnInitExtra(); 
    } 
/*-- SCRIPT autogen end ---------------------------------------------- */

            /* 사용자초기화 */
    me.fnInitExtra=function() {
        //탭
        gfnTab(pageid, "tabs");
        
        me.dataSet["allCafe"] = [];
        me.dataSet["joinedCafe"] = [];
        me.dataSet["nJoinedCafe"] = [];
        me.dataSet["searchCafe"] = [];    
        //카페명 클릭하면 retrieveCafeHome으로 페이지이동
        me.page.find("#cafeList").on("click","li.cafe-list",function(e){
            
            var menu = $(e.target);
            var pgmid = "retrieveCafeHome"; 
            var grpid = menu.attr('id');
            var pgmnm = menu.attr('name');
            
            gMDI.openPageOne(pgmid,pgmnm,grpid);
            
        })  
        me.fnLoad();  
    }
    /* 이벤트핸들러 */
    me.fnEH=function(component, evt, row, col, val) { 
        //console.log(evt+","+row+","+col+","+val);
        //화면기능버튼이 눌리면 
        if (component==me.pageObj["_pageFunc"]){ 
            if(typeof(me[col])=='function') me[col](); //col=기능명 me["fnSearch"]()=me.fnSearch(); 
        }
        //사용자 컴포넌트/컨트롤
        else if(component.userComponent=="myCompoId") {
            //if(evt=="dblclick" && col=="colid") {...}
        }
    }
//카페리스트 조회
    me.fnLoad = function() {
        me.dataSet["allCafe"] = [];
        me.dataSet["joinedCafe"] =[];
        me.dataSet["nJoinedCafe"] =[];

        gfnTx(appid+"."+pgmid,"loadCafeList",{},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK"){
                var cafeList = OUTVAR.cafeList;//모든카페
                var joinedList = OUTVAR.joinedlist;//가입된 카페명목록
                var nJoinedList = OUTVAR.notjoinedlist;//가입되지않은(가입가능한) 카페명목록

                for(var i = 0; i <cafeList.length; i++){
                    var row = cafeList[i];
                    var list = { cafe_id: row.grpid , cafe_nm:row.grp_nm, member_num:row.num};
                    me.dataSet["allCafe"].push(list);                                        
                };

                for(var i = 0; i <joinedList.length; i++){
                    var row = joinedList[i];
                    var joinedCafeList = { cafe_id: row.grpid , cafe_nm:row.grp_nm, member_num:row.num};
                    me.dataSet["joinedCafe"].push(joinedCafeList);                                        
                };
                for(var i = 0; i <nJoinedList.length; i++){
                    var row = nJoinedList[i];
                    var nJoinedCafeList = { cafe_id: row.grpid, cafe_nm:row.grp_nm, member_num:row.num};
                    me.dataSet["nJoinedCafe"].push(nJoinedCafeList);                                        
                    
                };

                me.fnDrawCafeList();
            }
    
        })
    },
    me.fnSearch = function(){
        //카페 검색
        if(!me.pageObj["pageCond"].chkValid()) return;
        var args = me.pageObj["pageCond"].exportData()[0];
        var invar = JSON.stringify(args);
        gfnTx(appid+"."+pgmid,"search",{INVAR:invar},function(OUTVAR){
            if(OUTVAR.rtnCd=="OK"){
                var searchList = OUTVAR.searchlist;
                me.dataSet["searchCafe"] = [];

                for(var i = 0; i <searchList.length; i++){
                    var row = searchList[i];
                    var list = { cafe_id: row.grpid, cafe_nm:row.grp_nm, member_num:row.num};
                    me.dataSet["searchCafe"].push(list);                                        
                }
                me.fnDrawCafeList();
            }
        });
    },
    me.fnDrawCafeList = function() {
        var oList = me.page.find("#list");
        oList.children("*").remove();
        $.each(me.dataSet["allCafe"],function(idx,el){
            var oCafe = $(`<li class='cafe-list' id=${el.cafe_id} name='${el.cafe_nm} 카페'></li>`);
            oCafe.append(`<p>${el.cafe_nm}</p>`);
            
            oCafe.append(`<p class="num">멤버수 : ${el.member_num}</p>`);
            
            oList.append(oCafe);
        });

        var oList1 = me.page.find("#list1");
        oList1.children("*").remove();
        $.each(me.dataSet["joinedCafe"],function(idx,el){
            var oCafe = $(`<li class='cafe-list' id=${el.cafe_id} name='${el.cafe_nm} 카페'></li>`);
            oCafe.append(`<p>${el.cafe_nm}</p>`);
            
            oCafe.append(`<p class="num">멤버수 : ${el.member_num}</p>`);
            
            oList1.append(oCafe);
        });

        var oList2 = me.page.find("#list2");
        oList2.children("*").remove();
        $.each(me.dataSet["nJoinedCafe"],function(idx,el){
            var oCafe = $(`<li class='cafe-list' id=${el.cafe_id} name='${el.cafe_nm} 카페'></li>`);
            oCafe.append(`<p>${el.cafe_nm}</p>`);
            oCafe.append(`<p class="num">멤버수 : ${el.member_num}</p>`);
            oList2.append(oCafe);
        });

        var oList3 = me.page.find("#list3");
        oList3.children("*").remove();
        $.each(me.dataSet["searchCafe"],function(idx,el){
            var oCafe = $(`<li class='cafe-list search' id=${el.cafe_id} name='${el.cafe_nm} 카페'></li>`);
            oCafe.append(`<p>${el.cafe_nm}</p>`);
            oCafe.append(`<p class="num">멤버수 : ${el.member_num}</p>`);
            oList3.append(oCafe);
        });
    },
    //카페생성 팝업창
    me.fnCreate = function(){
        var createCafe = $("<div></div>");
        var createList = $("<ul class='createList'></ul>");
        createCafe.append(createList);
        var col = [
            // {id:"grpid", nm : "카페그룹id"},
			{id:"grpnm", nm : "카페그룹이름"},
        ];
        var oRow = $(`<li class='list'></li>`);
        for(let i=0;i<col.length;i++){
            var list = col[i];
            var oCol = $(`<input type="text" name="${list.id}" autocomplete="off" style="height:16px;"></input>`);
            oRow.append(oCol);
            oCol.before($(`<label>${list.nm}</label>`));
            createList.append(oRow);
        }
        var saveBtn = $(`<br><button class="saveBtn">생성</button>`);

        createCafe.append(saveBtn);

        gfnPopup("카페생성",createCafe,{resizable:false, width:300,height:180,modal:false});

        //생성버튼 클릭시
        saveBtn.on("click",function(){
			var oRows = createCafe.find(".createList li input");
            var cafenm = oRows.val();
			var args = {grpnm:cafenm};
            var invar = JSON.stringify(args);
            var overlapChk = false;
            //이름 중복 확인
            for(let i=0;i<me.dataSet["allCafe"].length;i++){
                if(me.dataSet["allCafe"][i].cafe_nm == cafenm){
                    overlapChk = true;
                }
            }
            if(isNull(cafenm)) gfnAlert("공백 오류","생성할 카페그룹이름을 입력해주세요.");
            else if(overlapChk == true){
                gfnAlert("중복 오류","이미 존재하는 카페 이름입니다. 다시 입력해주세요.");
            }else{
                gfnConfirm("카페 생성", "카페를 생성하시겠습니까?", function(confirm) {
                    if(confirm) {
                        gfnTx(appid+"."+pgmid,"saveCreateCafe",{INVAR:invar},function(OUTVAR){
                            if(OUTVAR.rtnCd=="OK") {
                                gfnAlert("카페생성","카페가 생성되었습니다.",me.fnLoad());
                            } else {
                                gfnAlert("실패",OUTVAR.rtnMsg);
                            }
                        });
                    }else return;
                })
            }
		})    
    }
  

/*-- SCRIPT autogen ---------------------------------------------------- */        
if(typeof(me.fnInit)=='function') me.fnInit();
});

</script>