<style>[pgmid='meisReportBot'].framepage #txtMsg { 
    width:100%; 
    min-height: 20em;
}</style>

<!-- HTML autogen start ---------------------------------------------- -->            
<div class="pageNav"></div>
<div class="pageTop"></div>
<div class="pageCond"></div>
<div class="pageGuide"></div>
<div class="pageContent">
    <textarea id="txtMsg"></textarea>
</div>
<!-- HTML autogen end ---------------------------------------------- -->
<script>
/*-- SCRIPT autogen start ---------------------------------------------- */        
$(function() {
    var appid = "meis";
    var pgmid = "meisReportBot"; 
    var page = $("*[pgmid='"+pgmid+"'].framepage").last();
    var pageid = page.attr("id"); 
    var me = {}
    var dataSet = {};
    var dataDef = {};
    var pageObj = {};
    var bEdit = false;
    me.fnInit = function() {
        gfn[pageid] = me; 
        me.appid    = appid;
        me.pgmid    = pgmid;
        me.pageid   = pageid;
        me.page     = page; 
        me.dataSet = dataSet;
        me.dataDef = dataDef;
        me.pageObj = pageObj;
        me.bEdit = bEdit;
me.dataDef["_pgm"]={"ver":0.4,"upd_dt":"2022-10-26 19:51:26","remark":"","pgmid":"meisReportBot","proc_mst_id":"","pgm_stat":"Y","sort_seq":900,"app_pgmid":"meis","shortcut":"","reg_dt":"2022-10-26 19:51:26","reg_usid":"kihyunlee","pgm_nm":"판매일보봇","upd_usid":"kihyunlee","pgm_tp":"UX","pgm_grp_nm":"BOT","proc_mst_nm":"","app_pgm_nm":"모바일EIS","":"트랜젝션(메뉴)","crud":""};
me.dataDef["_pgm_func"]=[{"func_icon":"fas fa-robot","reg_dt":"2022-10-26 19:51:26","reg_usid":"","func_nm":"Activate","upd_usid":"","upd_dt":"2022-10-26 19:51:26","func_tp":null,"remark":null,"pgmid":"meisReportBot","sort_seq":"1","funcid":"activateBOT","content":null,"crud":"R","id":"0"},{"func_icon":"fas fa-flag","reg_dt":"2022-10-26 19:51:26","reg_usid":"","func_nm":"실행","upd_usid":"","upd_dt":"2022-10-26 19:51:26","func_tp":null,"remark":null,"pgmid":"meisReportBot","sort_seq":"2","funcid":"run","content":null,"crud":"R","id":"1"},{"func_icon":"fas fa-search","reg_dt":"2022-10-26 19:51:26","reg_usid":"","func_nm":"조회","upd_usid":"","upd_dt":"2022-10-26 19:51:26","func_tp":null,"remark":null,"pgmid":"meisReportBot","sort_seq":"3","funcid":"search","content":null,"crud":"R","id":"2"},{"func_icon":"fas fa-envelope","reg_dt":"2022-10-26 19:51:26","reg_usid":"","func_nm":"메시지발송","upd_usid":"","upd_dt":"2022-10-26 19:51:26","func_tp":null,"remark":null,"pgmid":"meisReportBot","sort_seq":"4","funcid":"sendMsg","content":null,"crud":"R","id":"3"}];
me.dataDef["_pgm_data"] = {};
me.dataDef["_pgm_data"]["pageCond"]={"sort_seq":"1","data_id":"pageCond","data_nm":"조회조건","data_icon":null,"component_pgmid":"aweForm","component_option":null,"inout_tp":null,"content":[{"sort_seq":1,"section":"BOT","section_icon":"fas fa-robot","colgrp":null,"colid":"bot_tick","colnm":"BotTick(msec)","dtype":"num","etype":"txt","attr":null,"defval":"60000","w":"8","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"0"},{"sort_seq":2,"section":"BOT","section_icon":"fas fa-robot","colgrp":null,"colid":"bot_activated","colnm":"Bot실행","dtype":"text","etype":"cbx","attr":null,"defval":"N","w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"1"},{"sort_seq":3,"section":"BOT","section_icon":"fas fa-robot","colgrp":null,"colid":"bot_stat","colnm":"Bot상태","dtype":"text","etype":"raw","attr":null,"defval":"ready","w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"2"},{"sort_seq":4,"section":"BOT","section_icon":"fas fa-robot","colgrp":null,"colid":"bot_dt","colnm":"최근시간","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"15","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"3"},{"sort_seq":5,"section":"JOB","section_icon":"fas fa-flag","colgrp":null,"colid":"job_cond","colnm":"Job조건","dtype":"text","etype":"tarea","attr":null,"defval":null,"w":"30","h":"5","refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"4"},{"sort_seq":6,"section":"JOB","section_icon":null,"colgrp":null,"colid":"job_stat","colnm":"Job상태","dtype":"text","etype":"raw","attr":null,"defval":"off","w":"5","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"5"},{"sort_seq":7,"section":"JOB","section_icon":null,"colgrp":null,"colid":"job_dt","colnm":"최근시간","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"15","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"6"},{"sort_seq":8,"section":"JOB","section_icon":null,"colgrp":null,"colid":"job_rst","colnm":"실행결과","dtype":"text","etype":"raw","attr":null,"defval":null,"w":"30","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"7"},{"sort_seq":9,"section":null,"section_icon":null,"colgrp":null,"colid":"room_id","colnm":"메시지방ID","dtype":"text","etype":"txt","attr":null,"defval":"9d493239-b189-2c14-318d-8649823323ec","w":"20","h":null,"refcd":null,"option":null,"len":null,"valid":null,"colFormula":null,"grpFormula":null,"totFormula":null,"remark":null,"crud":"C","id":"8"}]};

        me.pageObj["_page"] = new gfnFramepage( me ); 
        for(var component_id in me.dataDef["_pgm_data"]) { 
            me.pageObj[component_id] = new gfnComponent( me.pageid, component_id, me.dataDef["_pgm_data"][component_id], me.fnEH, me); 
        }  
        setTimeout(function(){
            $("#frameset").scrollTo(0); //스크롤 
        },10);
        if(typeof(me.fnInitExtra)=='function') me.fnInitExtra(); 
    } 
/*-- SCRIPT autogen end ---------------------------------------------- */

    /* 사용자초기화 */
    me.fnInitExtra=function() {
        //탭 설정
        //gfnTab(pageid, "tabs", {"multi-active":"off","toggle-switch":"on"}); 
        //사용자 컴포넌트 
        //me.dataDef["_pgm_data"][myCompoId] = {...};
        //me.pageObj["myCompoId"] = new gfnComponent( me.pageid, myCompoId, me.dataDef["_pgm_data"][myCompoId], me.fnEH, me); 
        //me.pageObj["myCompoId"].userComponent = "myCompoId";
        //사용자 컨트롤
        //var myColinfo = {colid:...}
        //me.pageObj["myColId"] = new gfnControl(myColinfo, me.fnEH) 
        //me.page.find("#myCol").append(me.pageObj["myColId"].dispObj);
        //me.pageObj["myColId"].getVal(); / myCol.setVal(val);...    
        
        me.pageObj.pageCond.setVal("job_cond","(date('today','hh24:mi')=='18:00'||date('today','hh24:mi')=='21:00')?true:false");
        
    }
    /* 이벤트핸들러 */
    me.fnEH=function(component, evt, row, col, val) { 
        //console.log(evt+","+row+","+col+","+val);
        //화면기능버튼이 눌리면 
        if (component==me.pageObj["_pageFunc"]){ 
            if(typeof(me[col])=='function') me[col](); //col=기능명 me["fnSearch"]()=me.fnSearch(); 
        }
        //사용자 컴포넌트/컨트롤
        else if(component.userComponent=="myCompoId") {
            //if(evt=="dblclick" && col=="colid") {...}
        }
    }
    
    /* BOT활성화 */
    me.fnActivateBOT=function() {
        if(me.pageObj.pageCond.getVal("bot_activated")=="N") {
            me.pageObj.pageCond.setVal("bot_activated","Y");
            me.pageObj.pageCond.setVal("bot_stat","ready");
            me.fnBot();
        } else {
            me.pageObj.pageCond.setVal("bot_activated","N");
        }
    }
    
    /* BOT Tick */
    me.fnBot=function() {
        var tick = nvl(me.pageObj.pageCond.getVal("bot_tick"),1000);
        try {
            //주인님이 허락하지 않은 상태에서 호출되면 tick하지 않음
            if(me.pageObj.pageCond.getVal("bot_activated")!="Y") {
                me.pageObj.pageCond.setVal("bot_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                me.pageObj.pageCond.setVal("bot_stat","off");   
                return;
            }
            
            //허락받았고 상태가 ready일때만 job을 실행할 것
            if(me.pageObj.pageCond.getVal("bot_stat")=="ready") {
                me.pageObj.pageCond.setVal("bot_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                me.pageObj.pageCond.setVal("bot_stat","tick"); //일단 tick으로 바꿔놓고...

                //수행조건 점검
                var job_cond = eval(me.pageObj.pageCond.getVal("job_cond"));
                if(job_cond) { 
                    //JOB을 수행하고 오면 다시 Tick하기 위한 콜백함수
                    var _fnBotCallback = function() {
                        me.pageObj.pageCond.setVal("bot_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                        me.pageObj.pageCond.setVal("bot_stat","ready"); 
                        setTimeout(me.fnBot,tick); 
                    }
                    me.fnRun(_fnBotCallback); 
                } else {
                    me.pageObj.pageCond.setVal("bot_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                    me.pageObj.pageCond.setVal("bot_stat","ready"); 
                    setTimeout(me.fnBot,tick); 
                }
            } else {
               setTimeout(me.fnBot,tick); 
            }  
        } catch(e) {
            me.pageObj.pageCond.setVal("bot_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
            me.pageObj.pageCond.setVal("bot_stat","exception");
            console.log("fnBot Exception:");
            console.log(e); 
            //익셉션이 발생하더라도 쉼없이 Tick한다. 
            if(me.pageObj.pageCond.getVal("bot_activated")=="Y") { 
                me.pageObj.pageCond.setVal("bot_stat","ready");
                setTimeout(me.fnBot,tick);
            }
        }
    }
    
    /* job Run */
    me.fnRun=function(afnCallback) {
        //조회한 후 조회결과가 있으면
        var _fnSearchCallback = function(OUTVAR) {
            if(OUTVAR.rtnCd=="OK") {
                me.pageObj.pageCond.setVal("job_stat","message sending...");
                me.pageObj.pageCond.setVal("job_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                me.pageObj.pageCond.setVal("job_rst","");        
                //메시지전송 호출하고 그 결과를 돌려줌 
                me.fnSendMsg(afnCallback);
            } else { 
                me.pageObj.pageCond.setVal("job_stat","halt!");
                me.pageObj.pageCond.setVal("job_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
                me.pageObj.pageCond.setVal("job_rst",OUTVAR.rtnMsg);
            }
        }
        //조회호출
        me.pageObj.pageCond.setVal("job_stat","searching...");
        me.pageObj.pageCond.setVal("job_dt",date("today","yyyy-mm-dd hh24:mi:ss"));
        me.pageObj.pageCond.setVal("job_rst","");
        me.fnSearch(_fnSearchCallback); 
    }
    
    //search:조회 
    me.fnSearch=function(fnSearchCallback) {
        try {
        var args = {today:date("today","yyyymmdd")}; 
        var invar = JSON.stringify(args);
        gfnTx("meis.meisHome","search",{INVAR:invar},function(OUTVAR){
            //console.log(OUTVAR);
            if(OUTVAR.rtnCd=="OK") {
                var am_sale = 0;
                var am_profit = 0; 
                OUTVAR.list.forEach(e=>{
                    am_sale += toNum(e.am_sale);
                    am_profit += toNum(e.am_profit); 
                }); 
                var rt_profit = 100*am_profit/am_sale; 
                //일단 결과 갈무리 해놓고
                var msg = `[판매일보 : ${date("today","yy년mm월dd일(w) hh24:mi")}]
스퀘어몰
(전체) - 거래액 ${lpad(gfnNumToStr(am_sale*1000000,-6)," ",9)}, 수수료매출 ${lpad(gfnNumToStr(am_profit*1000000,-6)," ",6)}, 수수료율 ${lpad(format(rt_profit,1)+"%"," ",6)}
===== ============ ============ =========`;
                OUTVAR.list.forEach(e=>{
                    msg += `
${e.nm_stor} - 거래액 ${lpad(gfnNumToStr(e.am_sale*1000000,-6)," ",9)}, 수수료매출 ${lpad(gfnNumToStr(e.am_profit*1000000,-6)," ",6)}, 수수료율 ${lpad(format(e.rt_profit,1)+"%"," ",6)}`;
                }); 
                me.page.find("#txtMsg").val( msg );
                
                //두번째 조회
                gfnTx("meis.meisHome","search2",{INVAR:invar},function(OUTVAR2){
                    if(OUTVAR2.rtnCd=="OK") {
                        var sale_price_amt = 0;
                        var sale_amt = 0;
                        OUTVAR2.list.forEach(e=>{
                            sale_price_amt += toNum(e.sale_price_amt);
                            sale_amt += toNum(e.sale_amt);
                        });
                        var price_rt = 100*sale_amt/sale_price_amt;
                        msg += `

팩토리아울렛
(전체) - 소가액 ${lpad(gfnNumToStr(sale_price_amt*1000000,-6)," ",9)},  판가액 ${lpad(gfnNumToStr(sale_amt*1000000,-6)," ",6)},  판가율 ${lpad(format(price_rt,1)+"%"," ",6)}
===== ============ ========== ==========`;
                        OUTVAR2.list.forEach(e=>{
                            msg += `
${e.wh_nm} - 소가액 ${lpad(gfnNumToStr(e.sale_price_amt*1000000,-6)," ",9)},  판가액 ${lpad(gfnNumToStr(e.sale_amt*1000000,-6)," ",6)},  판가율 ${lpad(format(e.price_rt,1)+"%"," ",6)}`;
                        });
                        me.page.find("#txtMsg").val(msg);
                        if(typeof(fnSearchCallback)=='function') fnSearchCallback(OUTVAR2);
                    } else {
                        if(typeof(fnSearchCallback)=='function') fnSearchCallback(OUTVAR2);
                    }
                });
            } else {
                if(typeof(fnSearchCallback)=='function') fnSearchCallback(OUTVAR);
            }
        });
        } catch(e) {
            console.log("fnSearchError:");
            console.log(e);
            if(typeof(fnSearchCallback)=='function') fnSearchCallback({rtnCd:"ERR",rtnMsg:e});
        }
    }

    //sendMsg:메시지발송 
    me.fnSendMsg=function(fnSendMsgCallback) { 
        var msg = `${me.page.find("#txtMsg").val()}`;
        gfnSendBotChat( 
            me.pageObj.pageCond.getVal("room_id"),
            msg,
            "",
            "",
            function() { 
                gfnSendBotChat( 
                    me.pageObj.pageCond.getVal("room_id"),
                    "더 자세한 내용은 모바일EIS에서 확인하세요!",
                    "https://fo.lfnetworks.co.kr/meis.jsp",
                    "모바일EIS 바로가기",
                    function(OUTVAR) {
                        if(typeof(fnSendMsgCallback)=='function') fnSendMsgCallback(OUTVAR);
                        else console.log(OUTVAR);
                    }
                );
            } 
        );
    }


/*-- SCRIPT autogen ---------------------------------------------------- */        
if(typeof(me.fnInit)=='function') me.fnInit();
});

</script>